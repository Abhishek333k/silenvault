<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Architect HTML Console | Pro Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; height: 100vh; }
        .editor-font { font-family: 'Fira Code', monospace; line-height: 1.6; }
        
        .ad-placeholder { 
            background: repeating-linear-gradient(45deg, #1e293b, #1e293b 10px, #334155 10px, #334155 20px); 
            display: flex; align-items: center; justify-content: center; 
            color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; 
            border: 1px dashed #475569; 
        }

        .line-numbers {
            font-family: 'Fira Code', monospace;
            line-height: 1.6;
            text-align: right;
            color: #475569;
            background-color: #0f172a;
            user-select: none;
            padding: 1.5rem 0.5rem;
        }

        #editor { resize: none; background: transparent; outline: none; }
        
        .tab-active { border-bottom: 2px solid #3b82f6; color: #60a5fa; background: rgba(59, 130, 246, 0.1); }
        .tab-inactive { color: #94a3b8; }
        .tab-inactive:hover { color: #e2e8f0; background: rgba(255, 255, 255, 0.05); }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col">

    <header class="h-14 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900/50 backdrop-blur-md shrink-0">
        <div class="flex items-center gap-3">
             <a href="index.html" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
                <div class="bg-blue-600 p-1.5 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m18 16 4-4-4-4"></path><path d="m6 8-4 4 4 4"></path><path d="m14.5 4-5 16"></path></svg>
                </div>
                <h1 class="text-sm font-bold tracking-tight">OpsCode <span class="text-blue-500">Architect</span></h1>
             </a>
        </div>
        
        <div class="hidden md:flex ad-placeholder h-10 w-64 rounded text-[10px]">Header Ad</div>

        <div class="flex items-center gap-2">
            <button id="btn-export" class="bg-slate-800 hover:bg-slate-700 text-xs font-medium px-3 py-1.5 rounded border border-slate-700 transition-colors">Export .html</button>
            <button id="btn-clear" class="text-slate-400 hover:text-red-400 text-xs font-medium px-2">Reset</button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <section class="flex-1 flex flex-col border-r border-slate-800 relative min-w-[300px]">
            <div class="flex bg-slate-900 border-b border-slate-800 shrink-0">
                <button onclick="switchTab('html')" id="tab-html" class="tab-active flex-1 py-2 text-xs font-mono font-medium transition-colors">index.html</button>
                <button onclick="switchTab('css')" id="tab-css" class="tab-inactive flex-1 py-2 text-xs font-mono font-medium transition-colors">style.css</button>
                <button onclick="switchTab('js')" id="tab-js" class="tab-inactive flex-1 py-2 text-xs font-mono font-medium transition-colors">script.js</button>
            </div>

            <div class="flex-1 flex relative overflow-hidden bg-[#0b1120]">
                <div id="line-numbers" class="line-numbers w-12 shrink-0 overflow-hidden border-r border-slate-800 font-mono text-xs">1</div>
                
                <textarea id="editor" class="flex-1 p-6 editor-font text-blue-100 text-sm whitespace-pre" spellcheck="false" placeholder=""></textarea>
                
                <div id="char-count" class="absolute bottom-2 right-4 text-[10px] text-slate-600 font-mono bg-slate-900/80 px-2 rounded pointer-events-none">0 chars</div>
                <div id="status-indicator" class="absolute bottom-2 right-20 text-[10px] text-emerald-500 font-mono bg-slate-900/80 px-2 rounded opacity-0 transition-opacity pointer-events-none">Compiling...</div>
            </div>
        </section>

        <section class="flex-1 flex flex-col bg-white min-w-[300px]">
            <div class="bg-slate-100 px-4 py-2 text-[10px] font-bold text-slate-500 uppercase border-b border-slate-200 flex justify-between items-center shrink-0">
                <span>Live Preview</span>
                <span class="text-slate-400" title="Code executes locally. No data is transmitted.">Isolated Sandbox</span>
            </div>
            <iframe id="preview" class="flex-1 w-full h-full border-none bg-white" sandbox="allow-scripts allow-modals allow-forms"></iframe>
        </section>

        <aside class="hidden xl:flex flex-col w-64 border-l border-slate-800 p-4 gap-4 bg-slate-900/30 shrink-0">
            <div class="ad-placeholder h-full w-full rounded">Skyscraper Ad</div>
        </aside>

    </main>

    <footer class="bg-slate-950 border-t border-slate-800 px-4 py-2 flex items-center justify-between shrink-0">
        <div class="text-[10px] text-slate-500 flex gap-4">
            <span>&copy; 2026 Architect Systems</span>
            <a href="legal.html" class="hover:text-white">Terms</a>
            <a href="legal.html" class="hover:text-white">Privacy</a>
            <span>Disclaimer: Local execution only.</span>
        </div>
        <div class="ad-placeholder h-8 w-64 md:w-96 rounded text-[10px]">Footer Banner Ad</div>
    </footer>

    <script>
        // --- State Management ---
        const codeStore = {
            html: `\n<h1>Business Invoice Template</h1>\n<p>Start editing to generate your custom layout.</p>\n<button id="demo">Test Logic</button>`,
            css: `body {\n  font-family: sans-serif;\n  padding: 2rem;\n  color: #333;\n}\nh1 { color: #2563eb; }`,
            js: `document.getElementById('demo').addEventListener('click', () => {\n  alert('Logic processor engaged.');\n});`
        };
        let activeTab = 'html';
        let timeoutId = null;
        let lastLineCount = 0; // OPTIMIZATION: Track lines to avoid redundant DOM updates

        const els = {
            editor: document.getElementById('editor'),
            lines: document.getElementById('line-numbers'),
            preview: document.getElementById('preview'),
            status: document.getElementById('status-indicator'),
            charCount: document.getElementById('char-count'),
            tabs: {
                html: document.getElementById('tab-html'),
                css: document.getElementById('tab-css'),
                js: document.getElementById('tab-js')
            }
        };

        function switchTab(newTab) {
            codeStore[activeTab] = els.editor.value;
            els.tabs[activeTab].classList.replace('tab-active', 'tab-inactive');
            els.tabs[newTab].classList.replace('tab-inactive', 'tab-active');
            
            activeTab = newTab;
            els.editor.value = codeStore[activeTab];
            
            updateLineNumbers(true); // Force update on tab switch
            els.editor.focus();
        }

        function updateLineNumbers(force = false) {
            const lines = els.editor.value.split('\n').length;
            // OPTIMIZATION: Only rewrite DOM if line count actually changed
            if (lines !== lastLineCount || force) {
                els.lines.innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>');
                lastLineCount = lines;
            }
        }

        function syncScroll() {
            els.lines.scrollTop = els.editor.scrollTop;
        }

        function compile() {
            codeStore[activeTab] = els.editor.value;
            els.status.style.opacity = '1';
            clearTimeout(timeoutId);

            timeoutId = setTimeout(() => {
                const htmlContent = codeStore.html;
                const cssContent = `<style>${codeStore.css}</style>`;
                
                // SECURITY: Defang closing script tags in user input to prevent Sandbox escape
                const safeJsContent = codeStore.js.replace(/<\/script>/gi, '<\\/script>');
                const jsContent = `<script>${safeJsContent}<\/script>`; 
                
                let fullSource;

                if (htmlContent.includes('<html') || htmlContent.includes('<!DOCTYPE')) {
                    fullSource = htmlContent;
                    if (fullSource.includes('</head>')) {
                        fullSource = fullSource.replace('</head>', `${cssContent}</head>`);
                    } else {
                        fullSource = cssContent + fullSource;
                    }
                    if (fullSource.includes('</body>')) {
                        fullSource = fullSource.replace('</body>', `${jsContent}</body>`);
                    } else {
                        fullSource = fullSource + jsContent;
                    }
                } else {
                    fullSource = `
                        <!DOCTYPE html>
                        <html>
                        <head>${cssContent}</head>
                        <body>
                            ${htmlContent}
                            ${jsContent}
                        </body>
                        </html>
                    `;
                }

                // SECURITY & PERFORMANCE: Use srcdoc instead of memory-leaking Blob URLs
                els.preview.srcdoc = fullSource;
                els.status.style.opacity = '0';
            }, 300); // OPTIMIZATION: Reduced debounce to 300ms for snappier feedback
            
            els.charCount.innerText = `${els.editor.value.length} chars`;
        }

        function downloadProject() {
            codeStore[activeTab] = els.editor.value; 
            const safeJsContent = codeStore.js.replace(/<\/script>/gi, '<\\/script>');
            const fullSource = `<!DOCTYPE html><html><head><style>${codeStore.css}</style></head><body>${codeStore.html}<script>${safeJsContent}<\/script></body></html>`;
            
            const blob = new Blob([fullSource], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `architect_export_${new Date().toISOString().slice(0,10)}.html`; // Professional naming
            a.click();
            URL.revokeObjectURL(url);
        }
        
        els.editor.addEventListener('input', () => {
            updateLineNumbers();
            compile();
        });
        
        els.editor.addEventListener('scroll', syncScroll);

        // BUG FIX: Preserve Undo history while allowing Tab key
        els.editor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                // setRangeText preserves the Ctrl+Z undo stack natively in modern browsers
                this.setRangeText('  ', this.selectionStart, this.selectionEnd, 'end');
                updateLineNumbers();
                compile(); 
            }
        });

        document.getElementById('btn-export').addEventListener('click', downloadProject);
        
        document.getElementById('btn-clear').addEventListener('click', () => {
            if(confirm('Are you sure you want to purge the current session?')) {
                location.reload(); 
            }
        });

        window.onload = () => {
            els.editor.value = codeStore.html;
            updateLineNumbers(true);
            compile();
        };
    </script>
</body>
</html>
