<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covert Morse Transceiver | SilenVault</title>
    <meta name="description" content="Acoustic chat client utilizing high-frequency On-Off Keying (Morse Code) to bypass hardware distortion.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>
    <link rel="stylesheet" href="../assets/css/components.css">

    <style>
        :root { --bg-color: #0f172a; --panel-bg: rgba(30, 41, 59, 0.85); --primary-text: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); overflow-x: hidden; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(16px); border: 1px solid #334155; }
        .mono { font-family: 'Fira Code', monospace; }
        .terminal-scroll { overflow-y: auto; scroll-behavior: smooth; }
        .terminal-scroll::-webkit-scrollbar { width: 4px; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        canvas { image-rendering: pixelated; }

        .chat-bubble { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.75rem; word-wrap: break-word; font-size: 0.875rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .chat-sent { align-self: flex-end; background: #1e3a8a; border-bottom-right-radius: 0.25rem; border: 1px solid #2563eb; }
        .chat-recv { align-self: flex-start; background: #064e3b; border-bottom-left-radius: 0.25rem; border: 1px solid #10b981; }

        .pulse-rx { animation: pulse-rx-ring 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-rx-ring { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1000px] mx-auto w-full px-4 py-8 flex flex-col gap-6">
        
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-white tracking-tight">
                    Covert <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-500">Transceiver</span>
                </h1>
                <p class="text-sm text-slate-400 mt-1">Air-Gapped Communication via Automated Acoustic Morse Code.</p>
            </div>
        </div>

        <div id="mic-alert" class="hidden glass-panel border-rose-500/50 bg-rose-950/20 p-4 rounded-xl flex items-center gap-3">
            <span class="text-rose-200 font-medium text-sm">Microphone Access Denied! Please run on localhost or a secure HTTPS server.</span>
        </div>

        <div class="glass-panel rounded-2xl border border-slate-700 shadow-2xl flex flex-col h-[70vh] min-h-[550px] overflow-hidden relative">
            
            <div class="bg-[#020617] border-b border-slate-700 p-4 flex flex-col sm:flex-row justify-between items-center gap-4 z-10 shadow-md">
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <button id="btn-engage" onclick="toggleTransceiver()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-6 py-2 rounded-lg border border-emerald-500 uppercase tracking-widest text-xs transition-all w-full sm:w-auto flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                        Engage Link
                    </button>
                    <div id="status-dot" class="w-3 h-3 rounded-full bg-slate-600 shrink-0"></div>
                </div>

                <div class="flex items-center gap-3 w-full sm:w-auto">
                    <select id="config-band" class="bg-slate-800 border border-slate-600 text-slate-300 text-xs font-bold rounded-lg px-3 py-2 outline-none shadow-inner focus:border-emerald-500 w-full">
                        <option value="covert">Ultrasonic (17.5kHz Covert)</option>
                        <option value="audible">HAM Radio (700Hz Audible)</option>
                    </select>
                </div>
            </div>

            <div class="w-full h-24 bg-[#020617] border-b border-slate-700 relative shrink-0">
                <div class="absolute top-2 left-2 text-[9px] text-slate-500 font-mono z-10 font-bold uppercase tracking-widest">Live Spectrum Radar</div>
                <canvas id="spectrogram" class="w-full h-full absolute inset-0"></canvas>
            </div>

            <div id="chat-window" class="flex-1 terminal-scroll p-6 flex flex-col relative bg-[#0f172a]">
                <div class="text-center mb-6">
                    <span class="bg-slate-800 text-slate-400 px-3 py-1 rounded-full text-[10px] font-mono border border-slate-700">Acoustic Channel Open</span>
                </div>
                </div>

            <div class="bg-slate-900 border-t border-slate-700 px-4 py-2 flex items-center gap-3">
                <span class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Live Decoder:</span>
                <span id="live-buffer" class="text-emerald-400 mono text-sm font-bold tracking-widest"></span>
                <span id="live-text-buffer" class="text-white mono text-sm font-bold ml-2"></span>
            </div>

            <div class="bg-[#020617] border-t border-slate-700 p-4">
                <div class="flex items-end gap-3">
                    <textarea id="chat-input" disabled rows="2" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white focus:outline-none focus:border-blue-500 resize-none shadow-inner placeholder-slate-600" placeholder="Type a message to transmit via Morse..."></textarea>
                    
                    <button id="btn-send" onclick="sendChatMessage()" disabled class="bg-blue-600 hover:bg-blue-500 disabled:bg-slate-800 disabled:border-slate-700 text-white p-3 rounded-xl shadow-lg transition-all border border-blue-500 shrink-0 h-[46px] w-[46px] flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                    </button>
                </div>
            </div>

        </div>

    </main>
    <sv-footer base-path=".."></sv-footer>

    <script>
        // ==========================================
        // MORSE CODE PROTOCOL MATH
        // ==========================================
        const WPM = 15; // Words Per Minute
        const DOT_MS = 1200 / WPM; // 80ms
        const DASH_MS = DOT_MS * 3; // 240ms
        const SYMBOL_SPACE = DOT_MS; // 80ms
        const LETTER_SPACE = DOT_MS * 3; // 240ms
        const WORD_SPACE = DOT_MS * 7; // 560ms

        // Timing Tolerances for real-world acoustic decoding
        const TOLERANCE_DOT_MAX = 150; 
        const TOLERANCE_DASH_MIN = 160;

        const MORSE_MAP = {
            'A': '.-', 'B': '-...', 'C': '-.-.', 'D': '-..', 'E': '.', 'F': '..-.',
            'G': '--.', 'H': '....', 'I': '..', 'J': '.---', 'K': '-.-', 'L': '.-..',
            'M': '--', 'N': '-.', 'O': '---', 'P': '.--.', 'Q': '--.-', 'R': '.-.',
            'S': '...', 'T': '-', 'U': '..-', 'V': '...-', 'W': '.--', 'X': '-..-',
            'Y': '-.--', 'Z': '--..', '0': '-----', '1': '.----', '2': '..---',
            '3': '...--', '4': '....-', '5': '.....', '6': '-....', '7': '--...',
            '8': '---..', '9': '----.'
        };

        const REVERSE_MORSE = {};
        for(let key in MORSE_MAP) { REVERSE_MORSE[MORSE_MAP[key]] = key; }

        let audioCtx = null;
        let isTransceiverActive = false;
        let isTransmitting = false;

        let micStream = null;
        let analyser = null;
        let drawRaf = null;

        // UI Binds
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const btnEngage = document.getElementById('btn-engage');
        const btnSend = document.getElementById('btn-send');
        const statusDot = document.getElementById('status-dot');
        const liveBuffer = document.getElementById('live-buffer');
        const liveTextBuffer = document.getElementById('live-text-buffer');
        const specCanvas = document.getElementById('spectrogram');
        const specCtx = specCanvas.getContext('2d');

        function appendChatBubble(type, text) {
            if(!text.trim()) return;
            const wrapper = document.createElement('div');
            wrapper.className = `chat-bubble flex flex-col relative z-10 ${type === 'sent' ? 'chat-sent' : 'chat-recv'}`;
            
            let statusHtml = type === 'sent' ? `<span class="text-[9px] text-blue-300/70 font-mono text-right mt-1">Broadcasted via Sound</span>` : `<span class="text-[9px] text-emerald-300/70 font-mono text-left mt-1">Intercepted</span>`;
            
            wrapper.innerHTML = `<span class="text-white">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>${statusHtml}`;
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // ==========================================
        // TRANSMITTER ENGINE
        // ==========================================
        function getFreq() {
            return document.getElementById('config-band').value === 'covert' ? 17500 : 700;
        }

        function getVolume() {
            return document.getElementById('config-band').value === 'covert' ? 0.05 : 0.2; // Covert needs to be quiet to stop aliasing
        }

        function sendChatMessage() {
            if (!isTransceiverActive || isTransmitting) return;
            const text = chatInput.value.toUpperCase().trim();
            if (!text) return;

            chatInput.value = '';
            appendChatBubble('sent', text);
            
            // Generate Morse Timing Sequence
            const sequence = [];
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === ' ') {
                    sequence.push({ on: false, duration: WORD_SPACE });
                    continue;
                }
                const morse = MORSE_MAP[char];
                if (!morse) continue; // Skip unknown chars

                for (let m = 0; m < morse.length; m++) {
                    sequence.push({ on: true, duration: morse[m] === '.' ? DOT_MS : DASH_MS });
                    if (m < morse.length - 1) sequence.push({ on: false, duration: SYMBOL_SPACE });
                }
                sequence.push({ on: false, duration: LETTER_SPACE });
            }

            // PTT (Push To Talk): Mute our own receiver while broadcasting
            isTransmitting = true;
            statusDot.className = "w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6] shrink-0";
            
            let time = audioCtx.currentTime + 0.1;
            const freq = getFreq();
            const vol = getVolume();

            sequence.forEach(step => {
                if (step.on) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    
                    // Attack/Release to prevent clicking
                    gain.gain.setValueAtTime(0, time);
                    gain.gain.setTargetAtTime(vol, time, 0.01);
                    gain.gain.setTargetAtTime(0, time + (step.duration / 1000) - 0.01, 0.01);
                    
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    
                    osc.start(time);
                    osc.stop(time + (step.duration / 1000));
                }
                time += (step.duration / 1000);
            });

            // Re-enable Receiver after transmission completes
            setTimeout(() => {
                isTransmitting = false;
                statusDot.className = "w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981] pulse-rx shrink-0";
            }, (time - audioCtx.currentTime) * 1000);
        }

        // ==========================================
        // RECEIVER (Algorithmic Morse Decoder)
        // ==========================================
        let isToneActive = false;
        let toneStartTime = 0;
        let silenceStartTime = 0;
        let currentSymbolBuffer = '';
        let currentMessageBuffer = '';

        function startDemodulator() {
            const buffer = new Float32Array(analyser.frequencyBinCount);
            const binWidth = audioCtx.sampleRate / analyser.fftSize;

            function decodeLoop() {
                if (!isTransceiverActive) return;
                requestAnimationFrame(decodeLoop);

                // PTT: Don't decode if we are the ones talking
                if (isTransmitting) return;

                analyser.getFloatFrequencyData(buffer);
                const now = performance.now();
                const freq = getFreq();
                
                // Find Target Bin
                const targetBin = Math.round(freq / binWidth);
                const mag = Math.max(buffer[targetBin-1], buffer[targetBin], buffer[targetBin+1]);
                
                // Detection Threshold (Varies by room/volume, -75dB is a safe baseline)
                const THRESHOLD = -75;

                if (mag > THRESHOLD) {
                    // TONE IS ON
                    if (!isToneActive) {
                        isToneActive = true;
                        toneStartTime = now;
                        
                        // We heard a tone, so if there was a silence timer, check if it means a space
                        if (silenceStartTime > 0) {
                            const silenceDur = now - silenceStartTime;
                            if (silenceDur > WORD_SPACE - 100 && currentMessageBuffer.length > 0) {
                                currentMessageBuffer += ' ';
                                liveTextBuffer.innerText = currentMessageBuffer;
                            }
                        }
                    }
                } else {
                    // TONE IS OFF
                    if (isToneActive) {
                        isToneActive = false;
                        const duration = now - toneStartTime;
                        silenceStartTime = now;

                        // Identify Dot vs Dash
                        if (duration > 30 && duration < TOLERANCE_DOT_MAX) {
                            currentSymbolBuffer += '.';
                            liveBuffer.innerText = currentSymbolBuffer;
                        } else if (duration >= TOLERANCE_DASH_MIN && duration < 600) {
                            currentSymbolBuffer += '-';
                            liveBuffer.innerText = currentSymbolBuffer;
                        }
                    } else if (silenceStartTime > 0) {
                        // WE ARE IN SILENCE. Measure it.
                        const silenceDur = now - silenceStartTime;

                        // If silence is long enough, the letter is finished.
                        if (silenceDur > LETTER_SPACE - 50 && currentSymbolBuffer.length > 0) {
                            const letter = REVERSE_MORSE[currentSymbolBuffer];
                            if (letter) {
                                currentMessageBuffer += letter;
                                liveTextBuffer.innerText = currentMessageBuffer;
                            }
                            currentSymbolBuffer = ''; // Clear for next letter
                            liveBuffer.innerText = '';
                        }

                        // If silence is REALLY long, the message is finished. Render chat bubble!
                        if (silenceDur > 2000 && currentMessageBuffer.length > 0) {
                            appendChatBubble('recv', currentMessageBuffer);
                            currentMessageBuffer = '';
                            liveTextBuffer.innerText = '';
                            silenceStartTime = 0; // Reset
                        }
                    }
                }
            }
            decodeLoop();
        }

        // ==========================================
        // BOOT & RADAR
        // ==========================================
        async function toggleTransceiver() {
            if (isTransceiverActive) {
                stopTransceiver();
                return;
            }

            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false } });
                document.getElementById('mic-alert').classList.add('hidden');
                
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(micStream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 4096; 
                analyser.smoothingTimeConstant = 0.0;
                source.connect(analyser);

                isTransceiverActive = true;

                btnEngage.innerText = "Terminate Link";
                btnEngage.className = "bg-rose-600 hover:bg-rose-500 text-white font-bold px-6 py-2 rounded-lg border border-rose-500 uppercase tracking-widest text-xs transition-all w-full sm:w-auto flex items-center justify-center shadow-[0_0_15px_rgba(225,29,72,0.3)]";
                statusDot.className = "w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981] pulse-rx shrink-0";
                
                chatInput.disabled = false;
                btnSend.disabled = false;

                resizeCanvas();
                startDemodulator();
                drawWaterfall();

            } catch (err) {
                document.getElementById('mic-alert').classList.remove('hidden');
            }
        }

        function stopTransceiver() {
            isTransceiverActive = false;
            if (micStream) micStream.getTracks().forEach(t => t.stop());
            if (audioCtx) audioCtx.close();
            cancelAnimationFrame(drawRaf);
            
            btnEngage.innerText = "Engage Link";
            btnEngage.className = "bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-6 py-2 rounded-lg border border-emerald-500 uppercase tracking-widest text-xs transition-all w-full sm:w-auto flex items-center justify-center shadow-[0_0_15px_rgba(16,185,129,0.3)]";
            statusDot.className = "w-3 h-3 rounded-full bg-slate-600 shrink-0";
            
            chatInput.disabled = true;
            btnSend.disabled = true;
            currentSymbolBuffer = '';
            currentMessageBuffer = '';
            liveBuffer.innerText = '';
            liveTextBuffer.innerText = '';
        }

        let sliceX = 0;
        function resizeCanvas() {
            specCanvas.width = specCanvas.parentElement.clientWidth;
            specCanvas.height = specCanvas.parentElement.clientHeight;
        }

        function drawWaterfall() {
            if (!isTransceiverActive) return;
            drawRaf = requestAnimationFrame(drawWaterfall);

            const buffer = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(buffer);

            const w = specCanvas.width;
            const h = specCanvas.height;

            if (sliceX >= w) sliceX = 0;

            specCtx.fillStyle = '#020617';
            specCtx.fillRect(sliceX + 1, 0, 4, h); 

            const targetFreq = getFreq();
            const binWidth = audioCtx.sampleRate / analyser.fftSize;
            
            // Map the Y axis around our target frequency (+/- 500Hz)
            const startIdx = Math.floor((targetFreq - 500) / binWidth);
            const range = Math.floor(1000 / binWidth);

            for (let y = 0; y < h; y++) {
                const index = startIdx + Math.floor((y / h) * range); 
                const value = buffer[index];
                
                let r=2, g=6, b=23; 
                if (value > 200) { r=255; g=255; b=255; } 
                else if (value > 120) { r=16; g=185; b=129; } 
                else if (value > 70) { r=30; g=58; b=138; } 

                specCtx.fillStyle = `rgb(${r},${g},${b})`;
                specCtx.fillRect(sliceX, h - y, 1, 1);
            }
            sliceX += 2; // Move faster so Morse blocks look long
        }

        document.getElementById('config-band').addEventListener('change', () => {
            if (isTransceiverActive) {
                stopTransceiver();
                setTimeout(toggleTransceiver, 300);
            }
        });

        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
    </script>
</body>
</html>
