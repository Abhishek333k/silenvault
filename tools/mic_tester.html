<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mic & Audio Tester | SilenVault</title>
    <meta name="description" content="Test your microphone, record and playback audio locally, and verify Left/Right stereo speaker channels.">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5449371042798610" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .mono { font-family: 'Fira Code', monospace; }

        /* Audio Visualizer Canvas */
        #visualizer {
            width: 100%; height: 160px; background: #0b1120; border-radius: 1rem;
            border: 1px solid #1e293b; box-shadow: inset 0 0 40px rgba(0,0,0,0.5);
        }

        .data-box { background: #020617; border: 1px solid #1e293b; border-radius: 0.75rem; padding: 1rem; position: relative; overflow: hidden; }
        
        /* Volume Bar */
        .vol-wrapper { width: 100%; background: #1e293b; height: 12px; border-radius: 6px; overflow: hidden; position: relative; }
        #vol-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444); transition: width 0.05s ease-out; }

        /* Status Pulses */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .recording-dot { width: 12px; height: 12px; background-color: #ef4444; border-radius: 50%; display: inline-block; animation: pulse-red 1.5s infinite; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1200px] mx-auto w-full px-4 py-8 flex flex-col gap-6">
        
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-2">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">
                    Audio <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-500">Diagnostics</span>
                </h1>
                <p class="text-sm text-slate-400 mt-1">Verify microphone input, playback quality, and stereo channels.</p>
            </div>

            <div class="glass-panel p-2 rounded-xl flex items-center gap-3">
                <svg class="w-4 h-4 text-slate-400 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                <select id="mic-select" class="bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded p-1.5 outline-none cursor-pointer max-w-[200px] truncate" onchange="switchDevice()">
                    <option value="">Default Microphone</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="md:col-span-2 glass-panel p-6 rounded-3xl border-slate-700 shadow-2xl flex flex-col gap-6">
                
                <div class="flex justify-between items-center">
                    <h2 class="text-sm font-bold text-slate-300 uppercase tracking-widest flex items-center gap-2">
                        Input Visualizer
                        <span id="mic-status" class="text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded-full">Inactive</span>
                    </h2>
                    <button id="btn-toggle-mic" onclick="toggleMic()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-4 py-2 rounded-lg transition-colors shadow-[0_0_15px_rgba(37,99,235,0.4)]">
                        Enable Microphone
                    </button>
                </div>

                <canvas id="visualizer"></canvas>

                <div class="grid grid-cols-2 gap-4">
                    <div class="data-box">
                        <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-2">Live Volume</span>
                        <div class="vol-wrapper"><div id="vol-bar"></div></div>
                    </div>
                    <div class="data-box flex justify-between items-center">
                        <div>
                            <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Peak Level</span>
                            <span id="peak-out" class="text-xl font-bold text-white mono">0%</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Status</span>
                            <span id="detect-out" class="text-sm font-bold text-rose-400">No Audio</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-6">
                
                <div class="glass-panel p-6 rounded-3xl border-slate-700 flex flex-col gap-4">
                    <h2 class="text-sm font-bold text-slate-300 uppercase tracking-widest border-b border-slate-800 pb-2">Quality Check</h2>
                    <p class="text-xs text-slate-400">Record a 5-second snippet to hear how you sound to others.</p>
                    
                    <button id="btn-record" onclick="toggleRecord()" disabled class="bg-slate-800 text-slate-400 border border-slate-700 font-bold text-sm px-4 py-3 rounded-xl transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                        <span id="record-text">Start Recording</span>
                    </button>

                    <audio id="audio-playback" controls class="w-full h-8 hidden mt-2"></audio>
                </div>

                <div class="glass-panel p-6 rounded-3xl border-slate-700 flex flex-col gap-4">
                    <h2 class="text-sm font-bold text-slate-300 uppercase tracking-widest border-b border-slate-800 pb-2">Stereo Test</h2>
                    <p class="text-xs text-slate-400">Verify your left and right speakers or headphone drivers.</p>
                    
                    <div class="flex gap-2">
                        <button onclick="testSpeaker(-1)" class="flex-1 bg-slate-800 hover:bg-indigo-600 text-white font-bold text-xs py-3 rounded-xl transition-colors border border-slate-700">
                            Play Left
                        </button>
                        <button onclick="testSpeaker(1)" class="flex-1 bg-slate-800 hover:bg-indigo-600 text-white font-bold text-xs py-3 rounded-xl transition-colors border border-slate-700">
                            Play Right
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8 mt-4">
            <div class="lg:col-span-2 glass-panel p-8 rounded-2xl border-slate-800 prose prose-invert max-w-none">
                <h2 class="text-xl font-bold text-white mb-4">Troubleshooting Audio Issues</h2>
                <ul class="text-sm text-slate-400 leading-relaxed space-y-3">
                    <li><strong>No Input Detected:</strong> Ensure you clicked "Allow" when the browser asked for microphone permissions. If denied, check the lock icon ðŸ”’ next to your URL bar to reset permissions.</li>
                    <li><strong>Wrong Microphone:</strong> If you have a webcam and a headset, the browser might default to the wrong one. Use the dropdown at the top right to select the correct device.</li>
                    <li><strong>Low Volume / Muffled:</strong> Check the physical mute switch on your headset cord. Additionally, go to your OS sound settings (Windows Sound Control Panel or macOS Audio MIDI Setup) to ensure the input gain is turned up.</li>
                    <li><strong>Privacy First:</strong> SilenVault runs locally. Your audio data is processed inside your browser RAM and is <strong>never</strong> uploaded to our servers.</li>
                </ul>
            </div>

            <div class="space-y-6">
                <div id="sidebar-ad-wrapper" class="hidden opacity-0 transition-opacity duration-1000">
                    <aside class="smart-ad-unit bg-slate-900/50 border border-slate-800 rounded-2xl flex flex-col items-center justify-center p-4 min-h-[250px]">
                        <span class="text-[10px] uppercase tracking-widest text-slate-600 block mb-2 pointer-events-none">Sponsored</span>
                        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5449371042798610" data-ad-slot="7594122081" data-ad-format="auto" data-full-width-responsive="true"></ins>
                        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                    </aside>
                </div>
            </div>
        </div>

    </main>

    <sv-footer base-path=".."></sv-footer>

    <script>
        // ARCHITECT: Core Audio State
        let audioCtx, analyser, microphone, dataArray;
        let isMicActive = false;
        let animationId;
        let stream;

        // Recording State
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordTimeout;

        // DOM Elements
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');
        const btnToggle = document.getElementById('btn-toggle-mic');
        const statusBadge = document.getElementById('mic-status');
        const volBar = document.getElementById('vol-bar');
        const peakOut = document.getElementById('peak-out');
        const detectOut = document.getElementById('detect-out');
        const selectDevice = document.getElementById('mic-select');
        const btnRecord = document.getElementById('btn-record');
        const recordText = document.getElementById('record-text');
        const audioPlayback = document.getElementById('audio-playback');

        // Initialize Canvas size
        function resizeCanvas() {
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 1. Fetch Available Microphones
        async function getDevices() {
            try {
                // Must request permission first before labels are exposed by browser
                await navigator.mediaDevices.getUserMedia({ audio: true }); 
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(d => d.kind === 'audioinput');
                
                selectDevice.innerHTML = '';
                audioInputs.forEach(device => {
                    const opt = document.createElement('option');
                    opt.value = device.deviceId;
                    opt.text = device.label || `Microphone ${selectDevice.length + 1}`;
                    selectDevice.appendChild(opt);
                });
            } catch (err) {
                console.warn("Device enumeration blocked until permission granted.");
            }
        }

        // 2. Microphone Engine
        async function toggleMic() {
            if (isMicActive) {
                stopMic();
            } else {
                startMic();
            }
        }

        async function startMic() {
            try {
                const deviceId = selectDevice.value;
                const constraints = deviceId ? { audio: { deviceId: { exact: deviceId } } } : { audio: true };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Refresh devices now that we definitely have permission
                if(selectDevice.options.length <= 1) getDevices();

                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();

                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                microphone = audioCtx.createMediaStreamSource(stream);
                microphone.connect(analyser);
                
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                isMicActive = true;
                btnToggle.innerText = "Stop Microphone";
                btnToggle.classList.replace('bg-blue-600', 'bg-rose-600');
                btnToggle.classList.replace('hover:bg-blue-500', 'hover:bg-rose-500');
                btnToggle.classList.replace('shadow-[0_0_15px_rgba(37,99,235,0.4)]', 'shadow-[0_0_15px_rgba(225,29,72,0.4)]');
                
                statusBadge.innerText = "Listening";
                statusBadge.className = "text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded-full border border-emerald-500/30";
                
                btnRecord.disabled = false;
                btnRecord.classList.replace('text-slate-400', 'text-white');
                btnRecord.classList.replace('bg-slate-800', 'bg-blue-600');
                btnRecord.classList.replace('border-slate-700', 'border-blue-500');
                btnRecord.classList.add('hover:bg-blue-500');

                drawVisualizer();
            } catch (err) {
                alert("Microphone access denied. Please check your browser permissions.");
                console.error(err);
            }
        }

        function stopMic() {
            if (stream) stream.getTracks().forEach(track => track.stop());
            if (animationId) cancelAnimationFrame(animationId);
            
            isMicActive = false;
            btnToggle.innerText = "Enable Microphone";
            btnToggle.classList.replace('bg-rose-600', 'bg-blue-600');
            btnToggle.classList.replace('hover:bg-rose-500', 'hover:bg-blue-500');
            btnToggle.classList.replace('shadow-[0_0_15px_rgba(225,29,72,0.4)]', 'shadow-[0_0_15px_rgba(37,99,235,0.4)]');
            
            statusBadge.innerText = "Inactive";
            statusBadge.className = "text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded-full";
            
            btnRecord.disabled = true;
            btnRecord.classList.replace('text-white', 'text-slate-400');
            btnRecord.classList.replace('bg-blue-600', 'bg-slate-800');
            btnRecord.classList.replace('border-blue-500', 'border-slate-700');
            btnRecord.classList.remove('hover:bg-blue-500');
            
            // Reset Canvas & Data
            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
            volBar.style.width = '0%';
            peakOut.innerText = '0%';
            detectOut.innerText = 'No Audio';
            detectOut.className = 'text-sm font-bold text-rose-400';
        }

        function switchDevice() {
            if (isMicActive) {
                stopMic();
                setTimeout(startMic, 100); // restart with new device
            }
        }

        // 3. Visualizer Engine
        function drawVisualizer() {
            if (!isMicActive) return;
            animationId = requestAnimationFrame(drawVisualizer);

            analyser.getByteFrequencyData(dataArray);

            // Calculate Volume metrics
            let sum = 0;
            let maxPeak = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
                if (dataArray[i] > maxPeak) maxPeak = dataArray[i];
            }
            let average = sum / dataArray.length;
            let volPercent = Math.min(100, Math.round((average / 128) * 100)); // normalized scale
            let peakPercent = Math.round((maxPeak / 255) * 100);

            // Update DOM HUD
            volBar.style.width = volPercent + '%';
            peakOut.innerText = peakPercent + '%';

            if (volPercent > 2) {
                detectOut.innerText = 'Sound Detected';
                detectOut.className = 'text-sm font-bold text-emerald-400';
            } else {
                detectOut.innerText = 'Listening...';
                detectOut.className = 'text-sm font-bold text-slate-400';
            }

            // Draw Waveform
            canvasCtx.fillStyle = '#0b1120';
            canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < dataArray.length; i++) {
                barHeight = dataArray[i] / 2;

                // Gradient coloring based on height
                const r = barHeight + 50;
                const g = 150 + (barHeight * 2);
                const b = 250;

                canvasCtx.fillStyle = `rgb(${r},${g},${b})`;
                
                // Draw centered bars
                canvasCtx.fillRect(x, (canvas.height - barHeight) / 2, barWidth - 1, barHeight);
                x += barWidth;
            }
        }

        // 4. Record & Playback Engine
        function toggleRecord() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!stream) return;
            audioChunks = [];
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayback.src = audioUrl;
                audioPlayback.classList.remove('hidden');
                audioPlayback.play(); // Auto play after record
            };

            mediaRecorder.start();
            isRecording = true;
            
            // UI Updates
            recordText.innerText = "Recording... (Max 5s)";
            btnRecord.classList.replace('bg-blue-600', 'bg-rose-950');
            btnRecord.classList.replace('border-blue-500', 'border-rose-500');
            btnRecord.innerHTML = `<span class="recording-dot"></span> <span id="record-text" class="text-rose-400">Recording...</span>`;
            audioPlayback.classList.add('hidden');
            audioPlayback.pause();

            // Auto stop after 5 seconds
            recordTimeout = setTimeout(() => {
                if (isRecording) stopRecording();
            }, 5000);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            clearTimeout(recordTimeout);
            isRecording = false;
            
            // UI Restore
            btnRecord.classList.replace('bg-rose-950', 'bg-blue-600');
            btnRecord.classList.replace('border-rose-500', 'border-blue-500');
            btnRecord.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> <span id="record-text">Record New Audio</span>`;
        }

        // 5. Speaker Tester (Stereo Panner)
        function testSpeaker(panValue) {
            // Re-init audioCtx if user clicked this before enabling mic
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const panner = audioCtx.createStereoPanner();
            const gain = audioCtx.createGain();

            // Setup routing
            osc.connect(panner);
            panner.connect(gain);
            gain.connect(audioCtx.destination);

            // Configure sound (Pleasant chime sound)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.3); // Sweep up

            // Pan: -1 = Left, 1 = Right
            panner.pan.value = panValue;

            // Envelope (Fade out to avoid clicking)
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        // 6. Ad-Sensing Logic
        function monitorAds() {
            const adSlot = document.querySelector('#sidebar-ad-wrapper ins.adsbygoogle');
            const container = document.getElementById('sidebar-ad-wrapper');
            if (!adSlot) return;

            const observer = new MutationObserver(() => {
                if (adSlot.getAttribute('data-ad-status') === 'filled' || adSlot.innerHTML.includes('iframe')) {
                    container.classList.remove('hidden');
                    setTimeout(() => container.classList.add('opacity-100'), 50);
                    observer.disconnect();
                }
            });
            observer.observe(adSlot, { attributes: true, childList: true });
        }

        window.onload = monitorAds;
    </script>
</body>
</html>
