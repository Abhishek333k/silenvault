<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Touch Screen Diagnostics | SilenVault</title>
    <meta name="description" content="Professional touch screen tester. Map dead zones using the factory grid system and verify 10-point multi-touch tracking.">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5449371042798610" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; overscroll-behavior: none; }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .mono { font-family: 'Fira Code', monospace; }

        /* Factory Canvas Container */
        #canvas-wrapper {
            width: 100%; height: 65vh; min-height: 450px;
            background: #020617; border-radius: 1rem;
            border: 1px solid #1e293b; box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
            position: relative; overflow: hidden;
        }

        /* The drawing surface */
        #touch-canvas {
            display: block; width: 100%; height: 100%;
            touch-action: none; /* CRITICAL: Hardware lock prevents browser scroll/zoom */
            cursor: crosshair;
        }

        /* Fullscreen override */
        #canvas-wrapper.fullscreen {
            position: fixed; inset: 0; width: 100vw; height: 100vh; z-index: 9999;
            border-radius: 0; border: none;
        }

        .data-box { background: #020617; border: 1px solid #1e293b; border-radius: 0.75rem; padding: 1rem; }
        
        /* Floating Fullscreen HUD */
        #fs-hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.85); border: 1px solid rgba(51, 65, 85, 0.8);
            backdrop-filter: blur(8px); padding: 10px 20px; border-radius: 100px;
            display: flex; gap: 20px; align-items: center; pointer-events: none;
            z-index: 50; transition: opacity 0.3s;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1400px] mx-auto w-full px-4 py-8 flex flex-col gap-6">
        
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-2">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">
                    Touch <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">Diagnostics</span>
                </h1>
                <p class="text-sm text-slate-400 mt-1">Factory-grade dead zone mapping and multi-touch telemetry.</p>
            </div>

            <div class="glass-panel p-2 rounded-xl flex items-center gap-2">
                <button onclick="resetGrid()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold px-4 py-2 rounded-lg transition-colors border border-slate-700 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    Reset Grid
                </button>
                <button onclick="toggleFullscreen()" class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold px-4 py-2 rounded-lg transition-colors shadow-[0_0_15px_rgba(168,85,247,0.4)] flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
                    Full Screen Test
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="lg:col-span-3 flex flex-col gap-4">
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="data-box shadow-inner">
                        <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Active Points</span>
                        <span id="current-touches" class="text-2xl font-bold text-white mono">0</span>
                    </div>
                    <div class="data-box shadow-inner">
                        <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Max Tracked</span>
                        <span id="max-touches" class="text-2xl font-bold text-pink-400 mono">0</span>
                    </div>
                    <div class="data-box shadow-inner">
                        <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Grid Scanned</span>
                        <span class="text-2xl font-bold text-emerald-400 mono"><span id="grid-pct">0</span>%</span>
                    </div>
                    <div class="data-box shadow-inner">
                        <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Input Source</span>
                        <span id="input-type" class="text-lg font-bold text-blue-400">Awaiting</span>
                    </div>
                </div>

                <div id="canvas-wrapper">
                    <div id="fs-hud" class="hidden">
                        <div class="text-white text-xs font-bold font-mono">Touches: <span id="fs-current" class="text-purple-400">0</span></div>
                        <div class="w-px h-4 bg-slate-600"></div>
                        <div class="text-white text-xs font-bold font-mono">Max: <span id="fs-max" class="text-pink-400">0</span></div>
                        <div class="w-px h-4 bg-slate-600"></div>
                        <div class="text-slate-400 text-[10px] uppercase tracking-widest font-bold">Press ESC to Exit</div>
                    </div>
                    <canvas id="touch-canvas"></canvas>
                </div>

            </div>

            <div class="flex flex-col gap-6">
                <div class="glass-panel p-6 rounded-2xl border-slate-800 prose prose-invert max-w-none">
                    <h2 class="text-lg font-bold text-white mb-2 border-b border-slate-700 pb-2">Diagnostic Guide</h2>
                    <ul class="text-xs text-slate-400 leading-relaxed space-y-3 m-0 p-0 list-none">
                        <li><strong class="text-slate-200">Grid Mapping (Dead Zones):</strong> Swipe your finger across the canvas. The engine will "paint" the underlying grid blocks <span class="text-emerald-400">Green</span>. If a block refuses to paint, your digitizer has a physical dead zone.</li>
                        <li><strong class="text-slate-200">Multi-Touch Limit:</strong> Place as many fingers on the screen as possible. Watch the "Max Tracked" counter. Modern panels support 10 simultaneous touches.</li>
                        <li><strong class="text-slate-200">Hardware Telemetry:</strong> The crosshairs under your fingers display raw X/Y coordinates. If your device supports it, the radius and pressure (Force) will also be calculated dynamically.</li>
                    </ul>
                </div>

                <div id="sidebar-ad-wrapper" class="hidden opacity-0 transition-opacity duration-1000">
                    <aside class="smart-ad-unit bg-slate-900/50 border border-slate-800 rounded-2xl flex flex-col items-center justify-center p-4 min-h-[250px]">
                        <span class="text-[10px] uppercase tracking-widest text-slate-600 block mb-2 pointer-events-none">Sponsored</span>
                        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5449371042798610" data-ad-slot="7594122081" data-ad-format="auto" data-full-width-responsive="true"></ins>
                        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                    </aside>
                </div>
            </div>

        </div>
    </main>

    <sv-footer base-path=".."></sv-footer>

    <script>
        const canvas = document.getElementById('touch-canvas');
        const ctx = canvas.getContext('2d');
        const wrapper = document.getElementById('canvas-wrapper');
        const fsHud = document.getElementById('fs-hud');
        
        // DOM HUD
        const elCurrent = document.getElementById('current-touches');
        const elMax = document.getElementById('max-touches');
        const elGridPct = document.getElementById('grid-pct');
        const elInputType = document.getElementById('input-type');
        const elFsCurrent = document.getElementById('fs-current');
        const elFsMax = document.getElementById('fs-max');

        // Engine State
        let maxTouches = 0;
        let dpr = 1;
        let activeTouches = new Map();
        
        // Grid Factory Logic
        const GRID_SIZE = 50; 
        let gridCols = 0;
        let gridRows = 0;
        let paintedBlocks = new Set();
        
        const colors = ['#a855f7', '#ec4899', '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6', '#f97316', '#14b8a6'];

        // Core Render Engine
        function resizeCanvas() {
            const rect = wrapper.getBoundingClientRect();
            dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            // Calculate grid dimensions (logical pixels)
            gridCols = Math.ceil(rect.width / GRID_SIZE);
            gridRows = Math.ceil(rect.height / GRID_SIZE);
            
            updateGridPct();
        }

        window.addEventListener('resize', () => {
            resizeCanvas();
            // Don't clear grid on simple resize, just re-calculate bounds
        });
        resizeCanvas();

        function resetGrid() {
            paintedBlocks.clear();
            maxTouches = 0;
            updateHUD(0);
            updateGridPct();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                wrapper.requestFullscreen().catch(err => console.log(err));
            } else {
                document.exitFullscreen();
            }
        }

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                wrapper.classList.add('fullscreen');
                fsHud.classList.remove('hidden');
                setTimeout(resizeCanvas, 100);
            } else {
                wrapper.classList.remove('fullscreen');
                fsHud.classList.add('hidden');
                setTimeout(resizeCanvas, 100);
            }
        });

        // Telemetry Updaters
        function updateHUD(currentCount) {
            if(currentCount > maxTouches) maxTouches = currentCount;
            elCurrent.innerText = currentCount;
            elMax.innerText = maxTouches;
            elFsCurrent.innerText = currentCount;
            elFsMax.innerText = maxTouches;
            elCurrent.classList.toggle('text-purple-400', currentCount > 0);
            elCurrent.classList.toggle('text-white', currentCount === 0);
        }

        function updateGridPct() {
            const totalBlocks = gridCols * gridRows;
            const pct = totalBlocks > 0 ? Math.min(100, Math.round((paintedBlocks.size / totalBlocks) * 100)) : 0;
            elGridPct.innerText = pct;
        }

        // Hardware Event Handlers
        function processTouchData(touches, typeName) {
            activeTouches.clear();
            elInputType.innerText = typeName;
            elInputType.className = typeName === 'Mouse' ? 'text-lg font-bold text-blue-400' : 'text-lg font-bold text-pink-400';

            const rect = canvas.getBoundingClientRect();

            for (let i = 0; i < touches.length; i++) {
                const t = touches[i];
                const id = t.identifier !== undefined ? t.identifier : 'M';
                
                // Logical coordinates
                const x = t.clientX - rect.left;
                const y = t.clientY - rect.top;
                
                // Hardware specific data
                const force = t.force || 0;
                const radius = Math.max(t.radiusX || 20, 20); // Fallback to 20 if unsupported
                
                activeTouches.set(id, { x, y, force, radius, color: colors[(id === 'M' ? 2 : id) % colors.length] });

                // Paint Grid Block
                const col = Math.floor(x / GRID_SIZE);
                const row = Math.floor(y / GRID_SIZE);
                if (col >= 0 && col < gridCols && row >= 0 && row < gridRows) {
                    const blockKey = `${col},${row}`;
                    if (!paintedBlocks.has(blockKey)) {
                        paintedBlocks.add(blockKey);
                        updateGridPct();
                    }
                }
            }
            updateHUD(activeTouches.size);
        }

        // Event Listeners (Passive: false is mandatory to block browser gestures)
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); processTouchData(e.touches, 'Touch Screen'); }, { passive: false });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); processTouchData(e.touches, 'Touch Screen'); }, { passive: false });
        canvas.addEventListener('touchend', (e) => { e.preventDefault(); processTouchData(e.touches, 'Touch Screen'); }, { passive: false });
        canvas.addEventListener('touchcancel', (e) => { e.preventDefault(); processTouchData(e.touches, 'Touch Screen'); }, { passive: false });

        // Mouse Fallback
        let isMouseDown = false;
        canvas.addEventListener('mousedown', (e) => { isMouseDown = true; processTouchData([e], 'Mouse'); });
        canvas.addEventListener('mousemove', (e) => { if(isMouseDown) processTouchData([e], 'Mouse'); });
        window.addEventListener('mouseup', () => { if(isMouseDown){ isMouseDown = false; activeTouches.clear(); updateHUD(0); }});

        // -----------------------------------------------------------
        // High-Performance Hardware Render Loop (requestAnimationFrame)
        // -----------------------------------------------------------
        function renderEngine() {
            // Scale context for Retina displays
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);

            // 1. Draw Grid Base & Painted Blocks
            ctx.lineWidth = 1;
            for (let c = 0; c < gridCols; c++) {
                for (let r = 0; r < gridRows; r++) {
                    const bx = c * GRID_SIZE;
                    const by = r * GRID_SIZE;
                    
                    if (paintedBlocks.has(`${c},${r}`)) {
                        // Painted Block (Emerald glow)
                        ctx.fillStyle = 'rgba(16, 185, 129, 0.15)';
                        ctx.fillRect(bx, by, GRID_SIZE, GRID_SIZE);
                        ctx.strokeStyle = 'rgba(16, 185, 129, 0.3)';
                    } else {
                        // Empty Block
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
                    }
                    ctx.strokeRect(bx, by, GRID_SIZE, GRID_SIZE);
                }
            }

            // 2. Draw Active Touch Telemetry
            activeTouches.forEach((t, id) => {
                // Outer Pulse Ring
                ctx.beginPath();
                ctx.strokeStyle = t.color;
                ctx.lineWidth = 2;
                ctx.arc(t.x, t.y, t.radius * 1.5, 0, Math.PI * 2);
                ctx.stroke();

                // Inner Solid Dot
                ctx.beginPath();
                ctx.fillStyle = t.color;
                ctx.globalAlpha = 0.8;
                ctx.arc(t.x, t.y, 8, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;

                // Precision Crosshair
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                ctx.lineWidth = 1;
                ctx.moveTo(t.x - 30, t.y); ctx.lineTo(t.x + 30, t.y);
                ctx.moveTo(t.x, t.y - 30); ctx.lineTo(t.x, t.y + 30);
                ctx.stroke();

                // Telemetry Data Text
                ctx.fillStyle = '#f8fafc';
                ctx.font = '10px "Fira Code", monospace';
                ctx.fillText(`X:${Math.round(t.x)} Y:${Math.round(t.y)}`, t.x + 20, t.y - 20);
                if (t.force > 0) {
                    ctx.fillText(`Force: ${t.force.toFixed(2)}`, t.x + 20, t.y - 8);
                }
            });

            requestAnimationFrame(renderEngine);
        }

        // Start Hardware Loop
        renderEngine();

        // Ad-Sensing Logic
        function monitorAds() {
            const adSlot = document.querySelector('#sidebar-ad-wrapper ins.adsbygoogle');
            const container = document.getElementById('#sidebar-ad-wrapper');
            if (!adSlot) return;

            const observer = new MutationObserver(() => {
                if (adSlot.getAttribute('data-ad-status') === 'filled' || adSlot.innerHTML.includes('iframe')) {
                    container.classList.remove('hidden');
                    setTimeout(() => container.classList.add('opacity-100'), 50);
                    observer.disconnect();
                }
            });
            observer.observe(adSlot, { attributes: true, childList: true });
        }

        window.onload = monitorAds;
    </script>
</body>
</html>
