<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF Remover & Image Metadata Scrubber | SilenVault</title>
    <meta name="description" content="Free, local-first tool to view and remove hidden EXIF data, GPS coordinates, and camera tracking details from your photos before sharing online.">
    <meta name="keywords" content="exif remover, remove metadata from image, delete gps data photo, strip exif online, local image scrubber">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5449371042798610" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/lite.umd.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .mono { font-family: 'Fira Code', monospace; }

        .drop-zone {
            border: 2px dashed #334155; border-radius: 1rem; background: #0b1120;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 400px; transition: all 0.3s ease; cursor: pointer; position: relative;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3b82f6; background: rgba(59, 130, 246, 0.05);
        }
        .drop-zone input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        /* Restored: Image Container & Laser Scanner */
        .img-container {
            position: relative; width: 100%; border-radius: 8px; overflow: hidden;
            border: 2px solid #1e293b; background: #000;
        }
        .preview-img { width: 100%; max-height: 400px; object-fit: contain; display: block; opacity: 0.5; transition: opacity 0.5s; }
        .preview-img.scanned { opacity: 1; }

        .scanner-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: #3b82f6; box-shadow: 0 0 15px #3b82f6, 0 0 30px #3b82f6;
            animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; z-index: 20; display: none;
        }
        .scanning .scanner-line { display: block; }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .terminal {
            background: #020617; border: 1px solid #1e293b; border-radius: 8px;
            font-family: 'Fira Code', monospace; font-size: 13px; height: 400px; display: flex; flex-direction: column;
        }
        .terminal-header {
            background: #0f172a; border-bottom: 1px solid #1e293b; padding: 10px 16px;
            display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0;
        }
        .terminal-body {
            padding: 16px; overflow-y: auto; flex: 1; color: #94a3b8;
        }
        .terminal-body::-webkit-scrollbar { width: 6px; }
        .terminal-body::-webkit-scrollbar-track { background: #020617; }
        .terminal-body::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        .log-line { margin-bottom: 6px; display: flex; align-items: flex-start; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
        
        .log-key { color: #cbd5e1; font-weight: bold; width: 40%; flex-shrink: 0; word-break: break-all; }
        .log-val { word-break: break-all; }
        
        /* Severity Colors */
        .val-high { color: #f43f5e; font-weight: bold; } /* Red */
        .val-med { color: #fbbf24; } /* Yellow */
        .val-low { color: #64748b; } /* Gray */
        .val-sys { color: #3b82f6; width: 100%; } /* Blue */
        .val-safe { color: #10b981; font-weight: bold; } /* Green */

        .status-badge {
            display: inline-flex; items-center; gap: 8px; padding: 4px 12px; border-radius: 999px;
            font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
        }
        .status-warn { background: rgba(251, 191, 36, 0.1); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
        .status-safe { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .status-scan { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1400px] mx-auto w-full px-4 py-8 flex flex-col gap-6">
        
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-2">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">
                    EXIF Metadata <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">Remover</span>
                </h1>
                <p class="text-sm text-slate-400 mt-1">Scan, categorize, and remove hidden image data locally in your browser.</p>
            </div>
        </div>

        <div id="upload-stage" class="glass-panel p-2 rounded-2xl">
            <div id="drop-zone" class="drop-zone">
                <div class="bg-blue-500/10 p-6 rounded-full mb-6 border border-blue-500/20">
                    <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2 pointer-events-none tracking-tight">Select Image to Scan</h3>
                <p class="text-sm text-slate-500 pointer-events-none mb-6">Drop an image here to extract and view hidden metadata.</p>
                <div class="px-6 py-2 rounded-lg bg-slate-800 text-slate-300 text-xs font-bold pointer-events-none">Or Click to Browse Files</div>
                <input type="file" id="file-input" accept="image/jpeg, image/png, image/webp, image/heic">
            </div>
        </div>

        <div id="workspace-stage" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="glass-panel p-4 rounded-xl border-slate-700">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Image Source</span>
                        <div id="status-indicator" class="status-badge status-scan">
                            <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Scanning
                        </div>
                    </div>
                    
                    <div id="img-container" class="img-container scanning">
                        <div class="scanner-line"></div>
                        <img id="preview-image" class="preview-img" alt="Scanned Image">
                    </div>

                    <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-slate-900 p-2 rounded border border-slate-800">
                            <span class="block text-[10px] text-slate-500 uppercase">File Size</span>
                            <span id="file-size" class="text-slate-300 font-mono">0 KB</span>
                        </div>
                        <div class="bg-slate-900 p-2 rounded border border-slate-800">
                            <span class="block text-[10px] text-slate-500 uppercase">Format</span>
                            <span id="file-format" class="text-slate-300 font-mono">JPEG</span>
                        </div>
                    </div>
                </div>

                <button onclick="resetApp()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold px-4 py-3 rounded-xl transition-all border border-slate-700">
                    Load New Image
                </button>
            </div>

            <div class="lg:col-span-8 flex flex-col gap-4">
                <div class="terminal">
                    <div class="terminal-header">
                        <span class="text-slate-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                            Metadata Audit Log
                        </span>
                        <span id="meta-count" class="text-slate-500 text-[10px] font-mono">0 Tags Found</span>
                    </div>
                    <div class="terminal-body" id="terminal-out">
                        </div>
                </div>

                <div id="action-area" class="glass-panel p-4 rounded-xl border-slate-700 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="text-sm text-slate-400">
                        <span id="action-msg">Analyzing file structure...</span>
                    </div>
                    
                    <button id="btn-scrub" onclick="scrubImage()" class="hidden w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold px-8 py-3 rounded-xl transition-all shadow-[0_0_20px_rgba(59,130,246,0.4)] flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        Remove Metadata
                    </button>

                    <button id="btn-download" onclick="downloadImage()" class="hidden w-full md:w-auto bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold px-8 py-3 rounded-xl transition-all shadow-[0_0_20px_rgba(16,185,129,0.4)] flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download Cleaned Image
                    </button>
                </div>
            </div>

        </div>

        <canvas id="scrub-canvas" class="hidden"></canvas>

        <div class="grid lg:grid-cols-3 gap-8 mt-6">
            <div class="lg:col-span-2 glass-panel p-8 rounded-2xl border-slate-800 prose prose-invert max-w-none">
                <h2 class="text-xl font-bold text-white mb-4">Understanding Image Metadata</h2>
                <ul class="text-sm text-slate-400 leading-relaxed space-y-3 m-0 p-0 list-none">
                    <li><strong class="text-blue-400">What is EXIF data?</strong> Exchangeable Image File Format (EXIF) is data automatically attached to photos by your smartphone or digital camera. It contains settings like shutter speed and ISO, but often includes sensitive information like exact GPS coordinates, date/time, and device models.</li>
                    <li><strong class="text-amber-400">The Color Coding:</strong> Our auditor categorizes data by sensitivity. <span class="text-rose-400 font-bold">Red</span> items (like GPS or Serial Numbers) are high privacy risks. <span class="text-amber-400 font-bold">Yellow</span> items (like software or dates) can be used for profiling. <span class="text-slate-500 font-bold">Gray</span> items are benign camera settings.</li>
                    <li><strong class="text-slate-200">How we remove it:</strong> When you click "Remove Metadata", SilenVault draws your image onto an invisible HTML5 Canvas. This extracts only the visual RGB pixels, leaving all text-based EXIF data behind. The clean pixels are then re-encoded into a fresh file entirely within your browser's memory.</li>
                </ul>
            </div>

            <div class="space-y-6">
                <div id="sidebar-ad-wrapper" class="hidden opacity-0 transition-opacity duration-1000">
                    <aside class="smart-ad-unit bg-slate-900/50 border border-slate-800 rounded-2xl flex flex-col items-center justify-center p-4 min-h-[250px]">
                        <span class="text-[10px] uppercase tracking-widest text-slate-600 block mb-2 pointer-events-none">Sponsored</span>
                        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5449371042798610" data-ad-slot="7594122081" data-ad-format="auto" data-full-width-responsive="true"></ins>
                    </aside>
                </div>
            </div>
        </div>

    </main>

    <sv-footer base-path=".."></sv-footer>

    <script>
        let originalFile = null;
        let scrubbedBlob = null;
        let originalImageObj = new Image();
        
        let activeCategories = [];
        let currentScanId = 0; // Prevents overlapping animations

        // DOM Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const stageUpload = document.getElementById('upload-stage');
        const stageWorkspace = document.getElementById('workspace-stage');
        
        const imgContainer = document.getElementById('img-container');
        const previewImage = document.getElementById('preview-image');
        const fileSizeEl = document.getElementById('file-size');
        const fileFormatEl = document.getElementById('file-format');
        
        const terminalOut = document.getElementById('terminal-out');
        const metaCount = document.getElementById('meta-count');
        const statusIndicator = document.getElementById('status-indicator');
        const actionMsg = document.getElementById('action-msg');
        
        const btnScrub = document.getElementById('btn-scrub');
        const btnDownload = document.getElementById('btn-download');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, preventDefaults));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(e => dropZone.classList.add('dragover'));
        ['dragleave', 'drop'].forEach(e => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + ['Bytes', 'KB', 'MB'][i];
        }

        // --- Semantic Threat Categorizer ---
        function getSeverity(key) {
            const k = key.toLowerCase();
            const high = ['latitude', 'longitude', 'gps', 'serial', 'author', 'creator'];
            const med = ['make', 'model', 'software', 'host', 'date', 'time', 'lens'];
            
            if (high.some(h => k.includes(h))) return 'high';
            if (med.some(m => k.includes(m))) return 'med';
            return 'low';
        }

        function logToTerminal(key, val, severity = 'low') {
            const line = document.createElement('div');
            line.className = 'log-line';
            
            if (severity === 'sys') {
                line.innerHTML = `<span class="val-sys">${val}</span>`;
            } else if (severity === 'safe') {
                line.innerHTML = `<span class="log-key">${key}</span><span class="val-safe">${val}</span>`;
            } else {
                line.innerHTML = `<span class="log-key">${key}</span><span class="log-val val-${severity}">${val}</span>`;
            }
            terminalOut.appendChild(line);
            terminalOut.scrollTop = terminalOut.scrollHeight;
        }

        async function handleFile(file) {
            if (!file || !file.type.match('image.*')) { alert("Please drop a valid image file."); return; }
            
            currentScanId++; // Increment ID to kill any old animations
            let thisScanId = currentScanId;

            originalFile = file;
            activeCategories = []; 
            
            fileSizeEl.innerText = formatBytes(file.size);
            fileFormatEl.innerText = file.type.split('/')[1].toUpperCase();

            const url = URL.createObjectURL(file);
            previewImage.src = url;
            originalImageObj.src = url;

            stageUpload.classList.add('hidden');
            stageWorkspace.classList.remove('hidden');
            
            // Restored: UI Reset & Laser Animation Active
            terminalOut.innerHTML = '';
            imgContainer.classList.add('scanning');
            previewImage.classList.remove('scanned');
            statusIndicator.className = "status-badge status-scan";
            statusIndicator.innerHTML = `<svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Scanning Data`;
            btnScrub.classList.add('hidden');
            btnDownload.classList.add('hidden');

            logToTerminal('', '> INITIALIZING METADATA SCAN...', 'sys');

            try {
                const exifData = await exifr.parse(file, {tiff: true, ifd0: true, exif: true, gps: true});
                
                if (thisScanId !== currentScanId) return; // Abort if user dropped a new image

                if (exifData && Object.keys(exifData).length > 0) {
                    const keys = Object.keys(exifData);
                    metaCount.innerText = `${keys.length} Tags Found`;
                    
                    // State Tracking
                    if (exifData.latitude || exifData.GPSLatitude || exifData.longitude) activeCategories.push('GPS_COORDS');
                    if (exifData.Make || exifData.Model || exifData.SerialNumber || exifData.LensModel) activeCategories.push('HARDWARE_TAGS');
                    if (exifData.Software || exifData.HostComputer) activeCategories.push('SOFTWARE_TAGS');
                    if (exifData.ModifyDate || exifData.DateTimeOriginal) activeCategories.push('TIMESTAMPS');
                    if (activeCategories.length === 0) activeCategories.push('GENERAL_METADATA'); 

                    // Restored: Terminal Typing Animation
                    let idx = 0;
                    function printNextLog() {
                        if (thisScanId !== currentScanId) return;
                        
                        if (idx >= keys.length) {
                            // Finish Scan Animation
                            imgContainer.classList.remove('scanning');
                            previewImage.classList.add('scanned');
                            logToTerminal('', `> SCAN COMPLETE. [${keys.length}] DATA TAGS DETECTED.`, 'sys');
                            
                            statusIndicator.className = "status-badge status-warn";
                            statusIndicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-500"></span> Metadata Present`;
                            actionMsg.innerHTML = `<span class="text-amber-400">Action Suggested:</span> Hidden metadata found. Review log.`;
                            btnScrub.classList.remove('hidden');
                            return;
                        }

                        let key = keys[idx];
                        let val = exifData[key];
                        if (val instanceof Date) val = val.toISOString();
                        if (typeof val === 'object' && val !== null) val = JSON.stringify(val);
                        
                        const severity = getSeverity(key);
                        logToTerminal(key, val, severity);

                        idx++;
                        setTimeout(printNextLog, 40); // 40ms matrix typing effect
                    }

                    // Start typing logs
                    setTimeout(printNextLog, 500);

                } else {
                    // Safe File Logic
                    setTimeout(() => {
                        if (thisScanId !== currentScanId) return;
                        imgContainer.classList.remove('scanning');
                        previewImage.classList.add('scanned');
                        metaCount.innerText = `0 Tags Found`;
                        logToTerminal('', '> SCAN COMPLETE. NO METADATA DETECTED.', 'sys');
                        logToTerminal('STATUS', 'CLEAN', 'safe');
                        
                        statusIndicator.className = "status-badge status-safe";
                        statusIndicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Clean Image`;
                        actionMsg.innerHTML = `<span class="text-emerald-400">Clear:</span> No metadata found. File is safe.`;
                        
                        scrubbedBlob = file; 
                        btnDownload.classList.remove('hidden');
                    }, 1000);
                }
            } catch (error) {
                console.error(error);
                setTimeout(() => {
                    if (thisScanId !== currentScanId) return;
                    imgContainer.classList.remove('scanning');
                    previewImage.classList.add('scanned');
                    logToTerminal('', '> SCAN COMPLETE. NO READABLE METADATA DETECTED.', 'sys');
                    logToTerminal('STATUS', 'CLEAN', 'safe');
                    statusIndicator.className = "status-badge status-safe";
                    statusIndicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Clean Image`;
                    actionMsg.innerHTML = `<span class="text-emerald-400">Clear:</span> No metadata found. File is safe.`;
                    
                    scrubbedBlob = file;
                    btnDownload.classList.remove('hidden');
                }, 1000);
            }
        }

        function scrubImage() {
            btnScrub.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Removing Data...`;
            logToTerminal('', '> RE-ENCODING PIXELS (STRIPPING HEADERS)...', 'sys');

            setTimeout(() => {
                const canvas = document.getElementById('scrub-canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = originalImageObj.width;
                canvas.height = originalImageObj.height;
                ctx.drawImage(originalImageObj, 0, 0);

                const mimeType = originalFile.type || 'image/jpeg';
                // Restored: Prevent file inflation (0.92 is standard high-quality web export)
                const quality = mimeType === 'image/jpeg' ? 0.92 : undefined;
                
                canvas.toBlob((blob) => {
                    scrubbedBlob = blob;
                    
                    logToTerminal('', '> PROCESS COMPLETE.', 'sys');
                    
                    // Restored: State-Memory Output
                    if (activeCategories.includes('GPS_COORDS')) logToTerminal('GPS_DATA', 'REMOVED', 'safe');
                    if (activeCategories.includes('HARDWARE_TAGS')) logToTerminal('HARDWARE_INFO', 'REMOVED', 'safe');
                    if (activeCategories.includes('SOFTWARE_TAGS')) logToTerminal('SOFTWARE_INFO', 'REMOVED', 'safe');
                    if (activeCategories.includes('TIMESTAMPS')) logToTerminal('TIMESTAMPS', 'REMOVED', 'safe');
                    if (activeCategories.includes('GENERAL_METADATA')) logToTerminal('EXIF_HEADERS', 'REMOVED', 'safe');
                    
                    logToTerminal('IMAGE_STATUS', 'CLEANED', 'safe');
                    
                    statusIndicator.className = "status-badge status-safe";
                    statusIndicator.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Data Removed`;
                    actionMsg.innerHTML = `<span class="text-emerald-400">Success:</span> Metadata successfully stripped.`;
                    
                    fileSizeEl.innerText = formatBytes(blob.size);
                    metaCount.innerText = `0 Tags`;
                    
                    btnScrub.classList.add('hidden');
                    btnDownload.classList.remove('hidden');

                }, mimeType, quality); 
                
            }, 800);
        }

        function downloadImage() {
            if (!scrubbedBlob) return;
            const origName = originalFile.name;
            const dotIndex = origName.lastIndexOf('.');
            const name = origName.substring(0, dotIndex !== -1 ? dotIndex : origName.length);
            const ext = origName.substring(dotIndex !== -1 ? dotIndex : origName.length);
            const newFilename = `${name}_clean${ext}`;

            const url = URL.createObjectURL(scrubbedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = newFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function resetApp() {
            stageWorkspace.classList.add('hidden');
            stageUpload.classList.remove('hidden');
            fileInput.value = '';
            originalImageObj = new Image();
            scrubbedBlob = null;
            activeCategories = [];
            currentScanId++; // Kill any running animations
            terminalOut.innerHTML = '';
            btnScrub.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg> Remove Metadata`;
        }
    </script>
</body>
</html>
