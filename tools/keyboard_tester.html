<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard Tester | SilenVault</title>
    <meta name="description" content="Test your keyboard keys, check for ghosting, track mouse polling, and verify hardware layouts for Windows and Apple.">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5449371042798610" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .mono { font-family: 'Fira Code', monospace; }

        /* Mathematical Keyboard Layout Engine */
        :root {
            --key-size: 3rem; /* 48px base unit */
            --gap: 0.5rem;
        }

        .keyboard-wrapper { display: flex; gap: 1.5rem; justify-content: center; max-width: 1200px; margin: 0 auto; padding: 2rem; background: #0b1120; border-radius: 1.5rem; border: 1px solid #1e293b; box-shadow: inset 0 0 40px rgba(0,0,0,0.5); overflow-x: auto; }
        
        .kb-section { display: flex; flex-direction: column; gap: var(--gap); }
        .kb-row { display: flex; gap: var(--gap); }
        
        /* Grid definitions for perfectly aligned blocks */
        .nav-grid { display: grid; grid-template-columns: repeat(3, var(--key-size)); grid-auto-rows: var(--key-size); gap: var(--gap); margin-bottom: var(--gap); }
        .arrow-grid { display: grid; grid-template-columns: repeat(3, var(--key-size)); grid-auto-rows: var(--key-size); gap: var(--gap); margin-top: auto; }
        .numpad-grid { display: grid; grid-template-columns: repeat(4, var(--key-size)); grid-auto-rows: var(--key-size); gap: var(--gap); margin-top: auto; }
        
        /* Specific Grid Spans for Numpad */
        .num-plus { grid-column: 4; grid-row: 2 / span 2; height: 100%; }
        .num-enter { grid-column: 4; grid-row: 4 / span 2; height: 100%; }
        .num-zero { grid-column: 1 / span 2; width: 100%; }

        /* Key Styling */
        .key {
            background: #1e293b; border: 1px solid #334155; border-bottom-width: 4px;
            color: #94a3b8; font-family: 'Inter', sans-serif; font-weight: 600; font-size: 0.75rem;
            display: flex; align-items: center; justify-content: center; text-align: center;
            border-radius: 0.4rem; padding: 0 0.25rem; box-sizing: border-box;
            transition: all 0.05s; user-select: none; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .key:not(.num-plus):not(.num-enter) {
            height: var(--key-size);
        }

        /* Active & Tested States */
        .key.active {
            background: #3b82f6; color: white; border-color: #2563eb;
            border-bottom-width: 1px; transform: translateY(3px);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
        }

        .key.tested {
            background: rgba(16, 185, 129, 0.15); color: #34d399;
            border-color: #059669;
        }

        /* Data Boxes */
        .data-box { background: #020617; border: 1px solid #1e293b; border-radius: 0.75rem; padding: 1rem; position: relative; overflow: hidden; }
        .data-box::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #3b82f6, transparent); opacity: 0.5; }

        /* Mouse Tester */
        .mouse-btn { background: #1e293b; border: 1px solid #334155; border-radius: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.7rem; color: #64748b; transition: all 0.1s; }
        .mouse-btn.active { background: #10b981; color: white; border-color: #059669; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1400px] mx-auto w-full px-4 py-8 flex flex-col gap-6">
        
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-2">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">
                    Keyboard <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-blue-500">Tester</span>
                </h1>
                <p class="text-sm text-slate-400 mt-1">Hardware diagnostics: Keyboard polling, Ghosting, and Mouse validation.</p>
            </div>

            <div class="glass-panel p-2 rounded-xl flex items-center gap-3">
                <select id="os-select" onchange="updateLayout()" class="bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded p-1.5 outline-none cursor-pointer">
                    <option value="win">Windows PC</option>
                    <option value="mac">Apple macOS</option>
                </select>
                <select id="size-select" onchange="updateLayout()" class="bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded p-1.5 outline-none cursor-pointer">
                    <option value="full">Full Size (104)</option>
                    <option value="tkl">Tenkeyless (87)</option>
                </select>
                <label class="flex items-center gap-2 cursor-pointer text-xs text-slate-400 px-2 border-l border-slate-700">
                    <input type="checkbox" id="sound-toggle" checked class="accent-emerald-500">
                    Key Sound
                </label>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            
            <div class="md:col-span-3 grid grid-cols-3 gap-4">
                <div class="data-box shadow-inner flex flex-col justify-center">
                    <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">event.key</span>
                    <span id="out-key" class="text-xl font-bold text-white mono truncate">-</span>
                </div>
                <div class="data-box shadow-inner flex flex-col justify-center">
                    <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">event.code</span>
                    <span id="out-code" class="text-lg font-bold text-emerald-400 mono truncate">-</span>
                </div>
                <div class="data-box shadow-inner flex flex-col justify-center relative">
                    <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-1">Key Health</span>
                    <span class="text-xl font-bold text-purple-400 mono"><span id="tested-count">0</span> / <span id="total-count">0</span></span>
                    <button onclick="resetTester()" class="absolute right-3 top-3 text-[9px] bg-slate-800 hover:bg-rose-500 hover:text-white text-slate-400 px-2 py-1 rounded transition-colors uppercase font-bold tracking-wider">Reset</button>
                </div>
            </div>

            <div class="md:col-span-2 data-box shadow-inner" id="mouse-tester-zone" oncontextmenu="return false;">
                <div class="flex justify-between items-start mb-2">
                    <span class="block text-[10px] text-slate-500 uppercase tracking-widest font-bold">Mouse Tester</span>
                    <span class="text-[10px] text-slate-600">Test Here</span>
                </div>
                <div class="flex flex-wrap gap-2 mb-3">
                    <div id="mouse-0" class="mouse-btn">Left</div>
                    <div id="mouse-1" class="mouse-btn">Middle</div>
                    <div id="mouse-2" class="mouse-btn">Right</div>
                    <div id="mouse-3" class="mouse-btn">Back</div>
                    <div id="mouse-4" class="mouse-btn">Fwd</div>
                </div>
                <div class="flex justify-between items-end border-t border-slate-800 pt-2">
                    <div>
                        <span class="text-[9px] text-slate-500 uppercase">Wheel Scroll</span>
                        <div id="mouse-wheel" class="text-xs font-bold text-slate-300 mono mt-0.5">Idle</div>
                    </div>
                    <div class="text-right">
                        <span class="text-[9px] text-slate-500 uppercase">Coordinates</span>
                        <div class="text-xs font-bold text-blue-400 mono mt-0.5">X:<span id="mouse-x">0</span> Y:<span id="mouse-y">0</span></div>
                    </div>
                </div>
            </div>

        </div>

        <div id="keyboard-container" class="keyboard-wrapper"></div>

        <div class="grid lg:grid-cols-3 gap-8 mt-4">
            <div class="lg:col-span-2 glass-panel p-8 rounded-2xl border-slate-800 prose prose-invert max-w-none">
                <h2 class="text-xl font-bold text-white mb-4">Hardware Diagnostic Guide</h2>
                <ul class="text-sm text-slate-400 leading-relaxed space-y-3">
                    <li><strong>Key Ghosting Test:</strong> Also known as N-Key Rollover (NKRO). Press and hold multiple keys simultaneously (e.g., A, S, D, F, Space). If a key fails to light up <span class="text-blue-400">Blue</span>, your keyboard hardware cannot process that many inputs at once.</li>
                    <li><strong>Mouse Polling & Buttons:</strong> Move your cursor inside the "Mouse Tester" box to track X/Y coordinate refresh rates. Test side-buttons (Back/Forward) to ensure your drivers are functioning.</li>
                    <li><strong>Apple vs Windows:</strong> Physical hardware codes differ between OS environments. Use the settings dropdown to adapt the visualizer to your specific layout.</li>
                </ul>
            </div>

            <div class="space-y-6">
                <div id="sidebar-ad-wrapper" class="hidden opacity-0 transition-opacity duration-1000">
                    <aside class="smart-ad-unit bg-slate-900/50 border border-slate-800 rounded-2xl flex flex-col items-center justify-center p-4 min-h-[250px]">
                        <span class="text-[10px] uppercase tracking-widest text-slate-600 block mb-2 pointer-events-none">Sponsored</span>
                        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5449371042798610" data-ad-slot="7594122081" data-ad-format="auto" data-full-width-responsive="true"></ins>
                        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
                    </aside>
                </div>
            </div>
        </div>

    </main>

    <sv-footer base-path=".."></sv-footer>

    <script>
        // Mathematical Layout Definitions based on Standard Key Units (U)
        const kbBlocks = {
            main: [
                // Row 0
                [{c:'Escape', l:'Esc'}, {spacer: 1}, {c:'F1', l:'F1'}, {c:'F2', l:'F2'}, {c:'F3', l:'F3'}, {c:'F4', l:'F4'}, {spacer: 0.5}, {c:'F5', l:'F5'}, {c:'F6', l:'F6'}, {c:'F7', l:'F7'}, {c:'F8', l:'F8'}, {spacer: 0.5}, {c:'F9', l:'F9'}, {c:'F10', l:'F10'}, {c:'F11', l:'F11'}, {c:'F12', l:'F12'}],
                // Row 1
                [{c:'Backquote', l:'~'}, {c:'Digit1', l:'1'}, {c:'Digit2', l:'2'}, {c:'Digit3', l:'3'}, {c:'Digit4', l:'4'}, {c:'Digit5', l:'5'}, {c:'Digit6', l:'6'}, {c:'Digit7', l:'7'}, {c:'Digit8', l:'8'}, {c:'Digit9', l:'9'}, {c:'Digit0', l:'0'}, {c:'Minus', l:'-'}, {c:'Equal', l:'='}, {c:'Backspace', l:'Backspace', u: 2}],
                // Row 2
                [{c:'Tab', l:'Tab', u: 1.5}, {c:'KeyQ', l:'Q'}, {c:'KeyW', l:'W'}, {c:'KeyE', l:'E'}, {c:'KeyR', l:'R'}, {c:'KeyT', l:'T'}, {c:'KeyY', l:'Y'}, {c:'KeyU', l:'U'}, {c:'KeyI', l:'I'}, {c:'KeyO', l:'O'}, {c:'KeyP', l:'P'}, {c:'BracketLeft', l:'['}, {c:'BracketRight', l:']'}, {c:'Backslash', l:'\\', u: 1.5}],
                // Row 3
                [{c:'CapsLock', l:'Caps Lock', u: 1.75}, {c:'KeyA', l:'A'}, {c:'KeyS', l:'S'}, {c:'KeyD', l:'D'}, {c:'KeyF', l:'F'}, {c:'KeyG', l:'G'}, {c:'KeyH', l:'H'}, {c:'KeyJ', l:'J'}, {c:'KeyK', l:'K'}, {c:'KeyL', l:'L'}, {c:'Semicolon', l:';'}, {c:'Quote', l:"'"}, {c:'Enter', l:'Enter', u: 2.25}],
                // Row 4
                [{c:'ShiftLeft', l:'Shift', u: 2.25}, {c:'KeyZ', l:'Z'}, {c:'KeyX', l:'X'}, {c:'KeyC', l:'C'}, {c:'KeyV', l:'V'}, {c:'KeyB', l:'B'}, {c:'KeyN', l:'N'}, {c:'KeyM', l:'M'}, {c:'Comma', l:','}, {c:'Period', l:'.'}, {c:'Slash', l:'/'}, {c:'ShiftRight', l:'Shift', u: 2.75}],
                // Row 5
                [{c:'ControlLeft', l:'Ctrl', u: 1.25}, {c:'MetaLeft', l:'Win', u: 1.25}, {c:'AltLeft', l:'Alt', u: 1.25}, {c:'Space', l:'Space', u: 6.25}, {c:'AltRight', l:'Alt', u: 1.25}, {c:'MetaRight', l:'Win', u: 1.25}, {c:'ContextMenu', l:'Menu', u: 1.25}, {c:'ControlRight', l:'Ctrl', u: 1.25}]
            ],
            nav: [
                {c:'PrintScreen', l:'PrtSc'}, {c:'ScrollLock', l:'Scrl\nLock'}, {c:'Pause', l:'Pause'},
                {c:'Insert', l:'Ins'}, {c:'Home', l:'Home'}, {c:'PageUp', l:'PgUp'},
                {c:'Delete', l:'Del'}, {c:'End', l:'End'}, {c:'PageDown', l:'PgDn'}
            ],
            arrows: [
                {spacer: true}, {c:'ArrowUp', l:'↑'}, {spacer: true},
                {c:'ArrowLeft', l:'←'}, {c:'ArrowDown', l:'↓'}, {c:'ArrowRight', l:'→'}
            ],
            numpad: [
                {c:'NumLock', l:'Num'}, {c:'NumpadDivide', l:'/'}, {c:'NumpadMultiply', l:'*'}, {c:'NumpadSubtract', l:'-'},
                {c:'Numpad7', l:'7'}, {c:'Numpad8', l:'8'}, {c:'Numpad9', l:'9'}, {c:'NumpadAdd', l:'+', gridClass: 'num-plus'},
                {c:'Numpad4', l:'4'}, {c:'Numpad5', l:'5'}, {c:'Numpad6', l:'6'},
                {c:'Numpad1', l:'1'}, {c:'Numpad2', l:'2'}, {c:'Numpad3', l:'3'}, {c:'NumpadEnter', l:'Ent', gridClass: 'num-enter'},
                {c:'Numpad0', l:'0', gridClass: 'num-zero'}, {c:'NumpadDecimal', l:'.'}
            ]
        };

        const container = document.getElementById('keyboard-container');
        const testedKeys = new Set();
        let totalKeys = 0;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playClick() {
            if(!document.getElementById('sound-toggle').checked) return;
            if(!audioCtx) initAudio();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.03);
            
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.03);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.03);
        }

        function updateLayout() {
            const os = document.getElementById('os-select').value;
            const size = document.getElementById('size-select').value;
            
            container.innerHTML = '';
            totalKeys = 0;

            // 1. Build Main Keyboard Block
            const mainDiv = document.createElement('div');
            mainDiv.className = 'kb-section';
            
            kbBlocks.main.forEach((row, rowIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'kb-row';
                
                if(rowIndex === 0) rowDiv.style.marginBottom = '0.5rem'; // F-Key gap

                row.forEach(k => {
                    // Handle empty spacer objects
                    if (k.spacer) {
                        const spacerW = `calc(var(--key-size) * ${k.spacer} + var(--gap) * ${k.spacer - 1})`;
                        rowDiv.innerHTML += `<div style="width: ${spacerW};"></div>`;
                        return;
                    }

                    let label = k.l;
                    if(os === 'mac') {
                        if(k.c === 'MetaLeft' || k.c === 'MetaRight') label = '⌘ Cmd';
                        if(k.c === 'AltLeft' || k.c === 'AltRight') label = '⌥ Opt';
                        if(k.c === 'Backspace') label = 'Delete';
                        if(k.c === 'Enter') label = 'Return';
                    }
                    
                    // Exact mathematical width sizing
                    const u = k.u || 1;
                    const width = u === 1 ? 'var(--key-size)' : `calc(var(--key-size) * ${u} + var(--gap) * ${u - 1})`;
                    
                    rowDiv.innerHTML += `<div class="key" id="key-${k.c}" style="width: ${width}; flex-shrink: 0;">${label}</div>`;
                    totalKeys++;
                });
                mainDiv.appendChild(rowDiv);
            });
            container.appendChild(mainDiv);

            // 2. Build Nav/Arrow Block
            const middleCol = document.createElement('div');
            middleCol.className = 'kb-section';
            middleCol.style.justifyContent = 'space-between';

            let navHTML = '<div class="nav-grid">';
            kbBlocks.nav.forEach(k => {
                navHTML += `<div class="key" id="key-${k.c}">${k.l}</div>`;
                totalKeys++;
            });
            navHTML += '</div>';

            let arrowHTML = '<div class="arrow-grid">';
            kbBlocks.arrows.forEach(k => {
                if (k.spacer) {
                    arrowHTML += `<div></div>`;
                } else {
                    arrowHTML += `<div class="key" id="key-${k.c}">${k.l}</div>`;
                    totalKeys++;
                }
            });
            arrowHTML += '</div>';

            middleCol.innerHTML = navHTML + arrowHTML;
            container.appendChild(middleCol);

            // 3. Build Numpad Block
            if (size === 'full') {
                const numDiv = document.createElement('div');
                numDiv.className = 'kb-section';
                numDiv.style.justifyContent = 'flex-end'; // Align to bottom
                
                let numHTML = '<div class="numpad-grid">';
                kbBlocks.numpad.forEach(k => {
                    numHTML += `<div class="key ${k.gridClass || ''}" id="key-${k.c}">${k.l}</div>`;
                    totalKeys++;
                });
                numHTML += '</div>';
                
                numDiv.innerHTML = numHTML;
                container.appendChild(numDiv);
            }

            document.getElementById('total-count').innerText = totalKeys;
            
            // Re-apply visual tested states on re-render
            testedKeys.forEach(code => {
                const k = document.getElementById(`key-${code}`);
                if(k) k.classList.add('tested');
            });
        }

        // Event Handling
        function handleKey(e, isDown) {
            e.preventDefault(); 
            initAudio();

            const code = e.code;
            const keyEl = document.getElementById(`key-${code}`);

            if (isDown) {
                if(!e.repeat) playClick();
                
                document.getElementById('out-key').innerText = e.key === ' ' ? 'Space' : e.key;
                document.getElementById('out-code').innerText = e.code;
                document.getElementById('out-keycode').innerText = e.keyCode;

                if (keyEl) {
                    keyEl.classList.add('active');
                    if (!testedKeys.has(code)) {
                        testedKeys.add(code);
                        document.getElementById('tested-count').innerText = testedKeys.size;
                    }
                }
            } else {
                if (keyEl) {
                    keyEl.classList.remove('active');
                    keyEl.classList.add('tested');
                }
            }
        }

        function resetTester() {
            testedKeys.clear();
            document.getElementById('tested-count').innerText = '0';
            document.querySelectorAll('.key').forEach(k => k.classList.remove('active', 'tested'));
            document.getElementById('out-key').innerText = '-';
            document.getElementById('out-code').innerText = '-';
            document.getElementById('out-keycode').innerText = '-';
            
            // Mouse Reset
            document.querySelectorAll('.mouse-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mouse-wheel').innerText = 'Idle';
            document.getElementById('mouse-wheel').className = 'text-xs font-bold text-slate-300 mono mt-0.5';
        }

        const mouseZone = document.getElementById('mouse-tester-zone');
        
        mouseZone.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const btn = document.getElementById(`mouse-${e.button}`);
            if(btn) btn.classList.add('active');
            playClick();
        });

        mouseZone.addEventListener('mouseup', (e) => {
            e.preventDefault();
            const btn = document.getElementById(`mouse-${e.button}`);
            if(btn) setTimeout(() => btn.classList.remove('active'), 150);
        });

        mouseZone.addEventListener('mousemove', (e) => {
            const rect = mouseZone.getBoundingClientRect();
            document.getElementById('mouse-x').innerText = Math.round(e.clientX - rect.left);
            document.getElementById('mouse-y').innerText = Math.round(e.clientY - rect.top);
        });

        mouseZone.addEventListener('wheel', (e) => {
            e.preventDefault();
            const w = document.getElementById('mouse-wheel');
            if(e.deltaY < 0) {
                w.innerText = 'Scrolling UP';
                w.className = 'text-xs font-bold text-emerald-400 mono mt-0.5';
            } else {
                w.innerText = 'Scrolling DOWN';
                w.className = 'text-xs font-bold text-blue-400 mono mt-0.5';
            }
            clearTimeout(w.timeout);
            w.timeout = setTimeout(() => {
                w.innerText = 'Idle';
                w.className = 'text-xs font-bold text-slate-300 mono mt-0.5';
            }, 300);
        });

        window.addEventListener('keydown', (e) => handleKey(e, true), { passive: false });
        window.addEventListener('keyup', (e) => handleKey(e, false), { passive: false });

        function monitorAds() {
            const adSlot = document.querySelector('#sidebar-ad-wrapper ins.adsbygoogle');
            const container = document.getElementById('sidebar-ad-wrapper');
            if (!adSlot) return;

            const observer = new MutationObserver(() => {
                if (adSlot.getAttribute('data-ad-status') === 'filled' || adSlot.innerHTML.includes('iframe')) {
                    container.classList.remove('hidden');
                    setTimeout(() => container.classList.add('opacity-100'), 50);
                    observer.disconnect();
                }
            });
            observer.observe(adSlot, { attributes: true, childList: true });
        }

        window.onload = () => {
            updateLayout();
            monitorAds();
        };
    </script>
</body>
</html>
