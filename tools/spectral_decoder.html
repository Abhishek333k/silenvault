<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Morse Decoder | Acoustic Forensics | SilenVault</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>
    <link rel="stylesheet" href="../assets/css/components.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(16px); border: 1px solid #334155; }
        .mono { font-family: 'Fira Code', monospace; }
        canvas { image-rendering: pixelated; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[800px] mx-auto w-full px-4 py-8 flex flex-col gap-6">
        <div class="mb-2 text-center">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight">Visual <span class="text-emerald-400">Forensics</span></h1>
            <p class="text-sm text-slate-400 mt-2">Point microphone at target device to visually intercept On-Off Keying (Morse) signals.</p>
        </div>

        <div id="mic-alert" class="hidden glass-panel border-rose-500/50 bg-rose-950/20 p-4 rounded-xl flex items-center gap-3">
            <span class="text-rose-200 font-medium text-sm">Microphone Access Denied. You must run this on localhost or HTTPS.</span>
        </div>

        <div class="glass-panel p-6 rounded-2xl shadow-xl flex flex-col gap-4">
            
            <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                <h2 class="text-lg font-bold text-white">Target Frequency: 17.5 kHz</h2>
                <span id="rx-status" class="text-[10px] font-mono font-bold uppercase text-rose-500">Offline</span>
            </div>

            <div class="w-full h-64 bg-[#020617] rounded-xl border border-slate-700 overflow-hidden relative shadow-inner">
                <div class="absolute top-2 left-2 text-[9px] text-slate-500 font-mono z-10 font-bold uppercase tracking-widest">Live Spectrum Waterfall (Scrolls Right)</div>
                <canvas id="spectrogram" class="w-full h-full absolute inset-0"></canvas>
            </div>

            <button id="btn-listen" onclick="toggleScanner()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg border border-emerald-500 uppercase tracking-widest text-sm mt-4">
                Engage Microphone
            </button>
        </div>
        
        <div class="glass-panel p-6 rounded-2xl border-l-4 border-emerald-500 text-sm text-slate-300">
            <strong>How to read the radar:</strong> When the beacon is active, you will see bright green blocks appear in the radar above. Short blocks are "Dots", long blocks are "Dashes". They will paint the Morse Code message directly onto your screen.
        </div>
    </main>
    
    <sv-footer base-path=".."></sv-footer>

    <script>
        let audioCtx = null;
        let isListening = false;
        let micStream = null;
        let analyser = null;
        let drawRaf = null;

        async function toggleScanner() {
            if (isListening) {
                isListening = false;
                if (micStream) micStream.getTracks().forEach(t => t.stop());
                cancelAnimationFrame(drawRaf);
                document.getElementById('btn-listen').innerText = "Engage Microphone";
                document.getElementById('btn-listen').className = "w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg border border-emerald-500 uppercase tracking-widest text-sm mt-4";
                document.getElementById('rx-status').innerText = "Offline";
                document.getElementById('rx-status').className = 'text-[10px] font-mono font-bold uppercase text-rose-500';
                return;
            }

            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false } });
                document.getElementById('mic-alert').classList.add('hidden');
                
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(micStream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048; 
                analyser.smoothingTimeConstant = 0.0;
                source.connect(analyser);

                isListening = true;
                document.getElementById('btn-listen').innerText = "Stop Scanner";
                document.getElementById('btn-listen').className = "w-full bg-rose-600 hover:bg-rose-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg border border-rose-500 uppercase tracking-widest text-sm mt-4";
                document.getElementById('rx-status').innerText = "Scanning...";
                document.getElementById('rx-status').className = 'text-[10px] font-mono font-bold uppercase text-emerald-400';

                resizeCanvas();
                drawWaterfall();

            } catch (err) {
                document.getElementById('mic-alert').classList.remove('hidden');
            }
        }

        // ==========================================
        // UI WATERFALL RADAR
        // ==========================================
        const specCanvas = document.getElementById('spectrogram');
        const specCtx = specCanvas.getContext('2d');
        let sliceX = 0;

        function resizeCanvas() {
            specCanvas.width = specCanvas.parentElement.clientWidth;
            specCanvas.height = specCanvas.parentElement.clientHeight;
        }

        function drawWaterfall() {
            if (!isListening) return;
            drawRaf = requestAnimationFrame(drawWaterfall);

            const buffer = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(buffer);

            const w = specCanvas.width;
            const h = specCanvas.height;

            if (sliceX >= w) sliceX = 0;

            // Radar sweep clear
            specCtx.fillStyle = '#020617';
            specCtx.fillRect(sliceX + 1, 0, 5, h); 

            // Focus purely on 17kHz - 18kHz
            const binWidth = audioCtx.sampleRate / analyser.fftSize;
            const startIdx = Math.floor(17000 / binWidth);
            const range = Math.floor(1000 / binWidth);

            for (let y = 0; y < h; y++) {
                const index = startIdx + Math.floor((y / h) * range); 
                const value = buffer[index];
                
                let r=2, g=6, b=23; 
                if (value > 200) { r=255; g=255; b=255; } // White Peak
                else if (value > 120) { r=16; g=185; b=129; } // Emerald Hit
                else if (value > 70) { r=30; g=58; b=138; } // Blue Noise

                specCtx.fillStyle = `rgb(${r},${g},${b})`;
                specCtx.fillRect(sliceX, h - y, 1, 1);
            }
            sliceX += 2; // Move faster so Morse dots are visibly long
        }
    </script>
</body>
</html>
