<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectral Decoder | Acoustic Steganography | SilenVault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>
    <link rel="stylesheet" href="../assets/css/components.css">

    <style>
        :root { --bg-color: #0f172a; --panel-bg: rgba(30, 41, 59, 0.85); --primary-text: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(16px); border: 1px solid #334155; }
        .mono { font-family: 'Fira Code', monospace; }
        .terminal-scroll { overflow-y: auto; scroll-behavior: smooth; }
        .terminal-scroll::-webkit-scrollbar { width: 4px; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        canvas { image-rendering: pixelated; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1200px] mx-auto w-full px-4 py-8 flex flex-col gap-6">
        <div class="mb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight">Spectral <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">Decoder</span></h1>
            <p class="text-sm text-slate-400 mt-2">Transmit and demodulate dual-tone acoustic steganography (Text-to-Sound).</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            
            <div class="lg:col-span-5 glass-panel p-6 rounded-2xl shadow-xl flex flex-col gap-4">
                <div class="border-b border-slate-700 pb-3 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                        Acoustic Injector
                    </h2>
                    <span id="tx-status" class="text-[10px] font-mono font-bold uppercase text-slate-500">Idle</span>
                </div>
                
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Text Payload</label>
                    <textarea id="tx-input" class="w-full h-32 bg-[#020617] border border-slate-700 rounded-xl p-3 text-sm text-blue-400 mono focus:border-blue-500 resize-none shadow-inner" placeholder="Enter custom message to broadcast..."></textarea>
                </div>

                <div class="flex flex-col gap-2 mb-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Frequency Profile</label>
                    <select id="freq-profile" class="w-full bg-[#020617] border border-slate-700 text-slate-300 text-xs font-bold rounded-lg px-3 py-2 outline-none">
                        <option value="covert">Ultrasonic (18kHz - Silent)</option>
                        <option value="audible">Audible DTMF (2kHz - Melodic)</option>
                    </select>
                </div>

                <button id="btn-transmit" onclick="transmitPayload()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg border border-blue-500 uppercase tracking-widest text-xs">
                    Broadcast Audio
                </button>
            </div>

            <div class="lg:col-span-7 glass-panel p-6 rounded-2xl shadow-xl flex flex-col gap-4 min-h-[400px]">
                <div class="border-b border-slate-700 pb-3 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                        Spectral Scanner
                    </h2>
                    <span id="rx-status" class="text-[10px] font-mono font-bold uppercase text-rose-500">Offline</span>
                </div>

                <div class="w-full h-32 bg-[#020617] rounded-xl border border-slate-700 overflow-hidden relative shadow-inner">
                    <div class="absolute top-2 left-2 text-[9px] text-slate-500 font-mono z-10 font-bold uppercase tracking-widest">FFT Waterfall Array</div>
                    <canvas id="spectrogram" class="w-full h-full absolute inset-0"></canvas>
                </div>

                <div class="flex-1 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-widest pl-1">Intercepted Data</label>
                        <button onclick="document.getElementById('rx-out').innerText=''" class="text-[10px] text-slate-500 hover:text-white font-mono uppercase tracking-widest">Clear</button>
                    </div>
                    <div class="flex-1 bg-[#020617] border border-slate-700 rounded-xl p-4 terminal-scroll shadow-inner">
                        <span id="rx-out" class="text-emerald-400 mono text-sm font-bold tracking-wide break-words"></span>
                        <span id="cursor" class="inline-block w-2 h-4 bg-emerald-500 align-middle hidden animate-pulse"></span>
                    </div>
                </div>

                <button id="btn-listen" onclick="toggleScanner()" class="w-full bg-slate-800 hover:bg-slate-700 text-emerald-400 font-bold py-3 rounded-xl transition-all shadow-lg border border-slate-600 uppercase tracking-widest text-xs">
                    Engage Microphone
                </button>
            </div>
        </div>
    </main>
    <sv-footer base-path=".."></sv-footer>

    <script>
        let audioCtx = null;
        let isTransmitting = false;
        
        let isListening = false;
        let micStream = null;
        let analyser = null;
        let scanInterval = null;
        let drawRaf = null;

        const FREQ_STEP = 100;
        const CHAR_DUR = 0.2; 
        const PAUSE_DUR = 0.05;

        // ==========================================
        // TRANSMITTER (Text to Clear Sound)
        // ==========================================
        function getBaseFreq() {
            return document.getElementById('freq-profile').value === 'covert' ? 18000 : 2000;
        }

        function transmitPayload() {
            if (isTransmitting) return;
            const text = document.getElementById('tx-input').value;
            if (!text) return;

            isTransmitting = true;
            document.getElementById('btn-transmit').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('tx-status').innerText = 'Transmitting...';
            document.getElementById('tx-status').className = 'text-[10px] font-mono font-bold uppercase text-blue-400';

            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const baseFreq = getBaseFreq();
            let time = audioCtx.currentTime + 0.1;

            for (let i = 0; i < text.length; i++) {
                const hex = text.charCodeAt(i).toString(16).padStart(2, '0');
                const f1 = baseFreq + (parseInt(hex[0], 16) * FREQ_STEP);
                const f2 = baseFreq + (parseInt(hex[1], 16) * FREQ_STEP);

                const osc1 = audioCtx.createOscillator();
                const osc2 = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc1.frequency.value = f1;
                osc2.frequency.value = f2;
                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(audioCtx.destination);

                gain.gain.setValueAtTime(0, time);
                gain.gain.setTargetAtTime(0.5, time, 0.01);
                gain.gain.setTargetAtTime(0, time + CHAR_DUR - 0.02, 0.01);

                osc1.start(time);
                osc2.start(time);
                osc1.stop(time + CHAR_DUR);
                osc2.stop(time + CHAR_DUR);

                time += CHAR_DUR + PAUSE_DUR;
            }

            setTimeout(() => {
                isTransmitting = false;
                document.getElementById('btn-transmit').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('tx-status').innerText = 'Idle';
                document.getElementById('tx-status').className = 'text-[10px] font-mono font-bold uppercase text-slate-500';
            }, (time - audioCtx.currentTime) * 1000);
        }

        // ==========================================
        // RECEIVER (FFT Spectrum Scanner)
        // ==========================================
        async function toggleScanner() {
            if (isListening) {
                stopScanner();
                return;
            }

            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false } });
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();

                const source = audioCtx.createMediaStreamSource(micStream);
                analyser = audioCtx.createAnalyser();
                // 8192 provides extreme precision (5.3Hz bins) needed to isolate 100Hz steps
                analyser.fftSize = 8192; 
                analyser.smoothingTimeConstant = 0.2;
                source.connect(analyser);

                isListening = true;
                document.getElementById('btn-listen').innerText = "Stop Scanner";
                document.getElementById('btn-listen').classList.replace('text-emerald-400', 'text-rose-400');
                document.getElementById('rx-status').innerText = "Scanning Array...";
                document.getElementById('rx-status').className = 'text-[10px] font-mono font-bold uppercase text-emerald-400';
                document.getElementById('cursor').classList.remove('hidden');

                resizeCanvas();
                startDemodulator();
                drawWaterfall();

            } catch (err) {
                alert("Microphone Access Denied. Cannot read spectral data.");
            }
        }

        function stopScanner() {
            isListening = false;
            if (micStream) micStream.getTracks().forEach(t => t.stop());
            clearInterval(scanInterval);
            cancelAnimationFrame(drawRaf);
            
            document.getElementById('btn-listen').innerText = "Engage Microphone";
            document.getElementById('btn-listen').classList.replace('text-rose-400', 'text-emerald-400');
            document.getElementById('rx-status').innerText = "Offline";
            document.getElementById('rx-status').className = 'text-[10px] font-mono font-bold uppercase text-rose-500';
            document.getElementById('cursor').classList.add('hidden');
        }

        function startDemodulator() {
            const buffer = new Float32Array(analyser.frequencyBinCount);
            const binWidth = audioCtx.sampleRate / analyser.fftSize;
            
            let lastChar = '';
            let lastTime = 0;

            // Poll every 50ms to catch the 200ms dual-tones
            scanInterval = setInterval(() => {
                if (!isListening) return;
                analyser.getFloatFrequencyData(buffer);

                const baseFreq = getBaseFreq();
                const startIdx = Math.floor((baseFreq - 100) / binWidth);
                const endIdx = Math.ceil((baseFreq + 1600) / binWidth);

                let peaks = [];
                const THRESHOLD = -70; // dB Threshold for detection

                // Scan target range for magnitude spikes
                for (let i = startIdx; i <= endIdx; i++) {
                    if (buffer[i] > THRESHOLD && buffer[i] > buffer[i-1] && buffer[i] > buffer[i+1]) {
                        peaks.push({ index: i, freq: i * binWidth, mag: buffer[i] });
                    }
                }

                // Sort by loudest frequencies
                peaks.sort((a, b) => b.mag - a.mag);

                if (peaks.length > 0) {
                    let hex1 = -1, hex2 = -1;

                    if (peaks.length === 1 || (peaks.length > 1 && peaks[1].mag < THRESHOLD + 10)) {
                        // Only 1 loud tone detected. This means the character uses the same hex nibble twice (e.g. 'U' = 0x55)
                        const val = Math.round((peaks[0].freq - baseFreq) / FREQ_STEP);
                        if (val >= 0 && val <= 15) { hex1 = val; hex2 = val; }
                    } else if (peaks.length >= 2) {
                        // 2 distinct tones detected
                        const v1 = Math.round((peaks[0].freq - baseFreq) / FREQ_STEP);
                        const v2 = Math.round((peaks[1].freq - baseFreq) / FREQ_STEP);
                        
                        if (v1 >= 0 && v1 <= 15 && v2 >= 0 && v2 <= 15) {
                            // Assign higher frequency to the first nibble (standardized design)
                            hex1 = Math.max(v1, v2);
                            hex2 = Math.min(v1, v2);
                        }
                    }

                    if (hex1 !== -1 && hex2 !== -1) {
                        const charCode = parseInt(hex1.toString(16) + hex2.toString(16), 16);
                        const char = String.fromCharCode(charCode);
                        
                        // Prevent double-printing the same character if it spans multiple 50ms polls
                        if (char !== lastChar || (Date.now() - lastTime > 250)) {
                            // Filter out garbage characters
                            if (charCode >= 32 && charCode <= 126) {
                                document.getElementById('rx-out').innerText += char;
                                lastChar = char;
                                lastTime = Date.now();
                            }
                        }
                    }
                }
            }, 50);
        }

        // ==========================================
        // UI WATERFALL
        // ==========================================
        const specCanvas = document.getElementById('spectrogram');
        const specCtx = specCanvas.getContext('2d');
        let sliceX = 0;

        function resizeCanvas() {
            specCanvas.width = specCanvas.parentElement.clientWidth;
            specCanvas.height = specCanvas.parentElement.clientHeight;
        }

        function drawWaterfall() {
            if (!isListening) return;
            drawRaf = requestAnimationFrame(drawWaterfall);

            const buffer = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(buffer);

            if (sliceX >= specCanvas.width) {
                const imgData = specCtx.getImageData(1, 0, specCanvas.width - 1, specCanvas.height);
                specCtx.putImageData(imgData, 0, 0);
                sliceX = specCanvas.width - 1;
            }

            // Paint sweeping radar bar
            specCtx.fillStyle = '#020617';
            specCtx.fillRect(sliceX + 1, 0, 5, specCanvas.height);

            const baseFreq = getBaseFreq();
            const binWidth = audioCtx.sampleRate / analyser.fftSize;
            
            // Map canvas Y directly to our target frequency range (BaseFreq to BaseFreq + 2000Hz)
            const startIdx = Math.floor(baseFreq / binWidth);
            const range = Math.floor(2000 / binWidth);
            const h = specCanvas.height;

            for (let y = 0; y < h; y++) {
                const index = startIdx + Math.floor((y / h) * range); 
                const value = buffer[index];
                
                let r=2, g=6, b=23; 
                if (value > 200) { r=255; g=255; b=255; } // White Peak
                else if (value > 120) { r=16; g=185; b=129; } // Emerald Hit
                else if (value > 60) { r=30; g=58; b=138; } // Blue Noise

                specCtx.fillStyle = `rgb(${r},${g},${b})`;
                specCtx.fillRect(sliceX, h - y, 1, 1);
            }
            sliceX++;
        }
    </script>
</body>
</html>
