<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>EXIF Remover & Image Metadata Scrubber | SilenVault</title>
    <meta name="description" content="Free, local-first forensic tool to permanently remove hidden EXIF data, GPS coordinates, and XMP trackers from images. Lossless support for JPEG, PNG, WebP, and RAW (CR2, DNG) formats.">
    <meta name="keywords" content="exif remover, metadata scrubber, remove gps from photo, clear cr2 metadata, raw image metadata cleaner, local exif tool, privacy image editor">
    <meta name="author" content="SilenVault">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5449371042798610" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* BRIGHTER, MORE READABLE BASE THEME */
        :root {
            --bg-color: #0f172a; /* Lighter Slate Navy */
            --panel-bg: rgba(30, 41, 59, 0.85); /* Brighter Glass Panels */
            --border-color: #334155;
            --accent-glow: rgba(59, 130, 246, 0.25);
            --primary-text: #f8fafc;
            --secondary-text: #cbd5e1;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); overflow-x: hidden; transition: background-color 0.8s ease; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(16px); border: 1px solid var(--border-color); transition: all 0.5s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .mono { font-family: 'Fira Code', monospace; }

        /* BRIGHTER FORGE THEME (Deep Crimson, highly readable) */
        body.forge-mode {
            --bg-color: #22050f; /* Deep but legible crimson */
            --panel-bg: rgba(60, 10, 24, 0.85);
            --border-color: #9f1239; /* Bright Rose border */
            --accent-glow: rgba(244, 63, 94, 0.25);
            background-image: linear-gradient(rgba(244, 63, 94, 0.07) 1px, transparent 1px), linear-gradient(90deg, rgba(244, 63, 94, 0.07) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .forge-mode .status-scan { background: rgba(244, 63, 94, 0.15) !important; color: #fda4af !important; border-color: rgba(244, 63, 94, 0.5) !important; }
        .forge-mode .scanner-line { background: #f43f5e !important; box-shadow: 0 0 15px #f43f5e, 0 0 30px #f43f5e !important; }

        .portal-transition { animation: portalFade 0.6s ease-in-out forwards; }
        @keyframes portalFade { 0% { filter: contrast(1); opacity: 1; } 50% { filter: blur(3px); opacity: 0.8; } 100% { filter: blur(0px); opacity: 1; } }

        /* DROP ZONE */
        .drop-zone { border: 2px dashed var(--border-color); border-radius: 1rem; background: rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 350px; transition: all 0.4s ease; cursor: pointer; position: relative; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #60a5fa; background: var(--accent-glow); }
        .forge-mode .drop-zone:hover { border-color: #fb7185; }
        .drop-zone input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        /* PREVIEWS */
        .preview-box { border: 2px solid var(--border-color); border-radius: 8px; background: rgba(0,0,0,0.4); overflow: hidden; position: relative; height: 250px; display: flex; align-items: center; justify-content: center; }
        .preview-img { max-width: 100%; max-height: 100%; object-fit: contain; opacity: 0.7; transition: opacity 0.5s ease; }
        .preview-img.scanned { opacity: 1; }
        .preview-label { position: absolute; top: 8px; left: 8px; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #f8fafc; z-index: 10; }
        .filename-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block; font-size: 12px; color: var(--secondary-text); margin-top: 8px; text-align: center; font-weight: 500;}

        .scanner-line { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: #60a5fa; box-shadow: 0 0 15px #60a5fa, 0 0 30px #60a5fa; animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; z-index: 20; display: none; }
        .scanning .scanner-line { display: block; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* TERMINAL LOGS */
        .terminal { background: rgba(2, 6, 23, 0.9); border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Fira Code', monospace; font-size: 13px; height: 300px; display: flex; flex-direction: column; transition: all 0.5s ease; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); }
        .terminal-header { background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border-color); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .terminal-body { padding: 16px; overflow-y: auto; flex: 1; color: #e2e8f0; scroll-behavior: smooth; }
        .terminal-body::-webkit-scrollbar { width: 6px; }
        .terminal-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .log-line { margin-bottom: 6px; display: flex; align-items: flex-start; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; animation: fadeIn 0.2s ease-in;}
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
        
        .log-key { color: #f8fafc; font-weight: bold; width: 40%; flex-shrink: 0; word-break: break-all; }
        .log-val { word-break: break-all; }
        .val-high { color: #fda4af; font-weight: bold; text-shadow: 0 0 10px rgba(244,63,94,0.4); }
        .val-med { color: #fde047; }
        .val-low { color: #cbd5e1; }
        .val-sys { color: #93c5fd; width: 100%; font-weight: bold;}
        .forge-mode .val-sys { color: #fca5a5; }
        .val-safe { color: #86efac; font-weight: bold; text-shadow: 0 0 10px rgba(16,185,129,0.3);}

        /* MAP & BADGES */
        #location-map-container { transition: max-height 0.8s ease, opacity 0.5s ease; overflow: hidden; max-height: 0; opacity: 0; border-radius: 8px; }
        #location-map-container.active { max-height: 250px; opacity: 1; border: 1px solid rgba(244,63,94,0.4); margin-top: 1rem; }
        #leaflet-map { height: 200px; width: 100%; z-index: 1; }

        .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 999px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .status-warn { background: rgba(251, 191, 36, 0.15); color: #fde047; border: 1px solid rgba(251, 191, 36, 0.4); }
        .status-danger { background: rgba(244, 63, 94, 0.15); color: #fda4af; border: 1px solid rgba(244, 63, 94, 0.5); box-shadow: 0 0 15px rgba(244, 63, 94, 0.3); animation: pulse-danger 2s infinite; }
        @keyframes pulse-danger { 0%, 100% { box-shadow: 0 0 15px rgba(244, 63, 94, 0.3); } 50% { box-shadow: 0 0 25px rgba(244, 63, 94, 0.7); } }
        .status-safe { background: rgba(16, 185, 129, 0.15); color: #86efac; border: 1px solid rgba(16, 185, 129, 0.4); }
        .status-scan { background: rgba(59, 130, 246, 0.15); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.4); }
        
        /* CENTERED MODAL */
        #crossroads-modal-wrapper { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #crossroads-modal-wrapper.active { opacity: 1; pointer-events: auto; }
        #crossroads-modal-inner { transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #crossroads-modal-wrapper.active #crossroads-modal-inner { transform: scale(1); }
    </style>
</head>
<body class="flex flex-col min-h-screen transition-colors duration-1000" id="main-body">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1400px] mx-auto w-full px-4 py-8 flex flex-col gap-8 relative">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
            <div>
                <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-tight transition-all duration-1000" id="main-title">
                    Metadata <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 transition-all duration-1000" id="title-accent">Scrubber</span>
                </h1>
                <p class="text-base text-slate-300 mt-2 font-medium">Scan, verify, and securely purge tracking data from your images locally.</p>
            </div>
        </div>

        <div id="upload-stage" class="glass-panel p-3 rounded-2xl transition-all duration-500 shadow-xl">
            <div id="drop-zone" class="drop-zone">
                <div class="bg-blue-500/10 p-6 rounded-full mb-6 border border-blue-500/20 transition-all duration-500 shadow-[0_0_20px_rgba(59,130,246,0.15)]" id="dz-icon-wrap">
                    <svg class="w-14 h-14 text-blue-400 transition-colors duration-500" id="dz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2 pointer-events-none tracking-tight">Select Image to Audit</h3>
                <div class="flex flex-wrap gap-2 justify-center pointer-events-none mb-8 mt-2">
                    <span class="px-3 py-1 rounded bg-slate-800 text-[11px] text-white font-bold border border-slate-600 shadow-sm">JPEG / PNG / WEBP</span>
                    <span class="px-3 py-1 rounded bg-slate-800 text-[11px] text-blue-300 font-bold border border-blue-600 shadow-sm">HEIC / HEIF</span>
                    <span class="px-3 py-1 rounded bg-slate-800 text-[11px] text-rose-300 font-bold border border-rose-600 shadow-sm">CR2 / DNG / NEF</span>
                </div>
                <div class="px-8 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold pointer-events-none border border-blue-500 shadow-lg transition-colors">Browse Local Files</div>
                <input type="file" id="file-input" accept="image/*, .dng, .cr2, .nef, .arw, .webp, .png, .jpg, .jpeg">
            </div>
        </div>

        <div id="crossroads-modal-wrapper">
            <div id="crossroads-modal-inner" class="glass-panel p-8 rounded-2xl max-w-xl w-full border-rose-500/60 relative overflow-hidden shadow-[0_0_50px_rgba(225,29,72,0.15)] mx-4">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-rose-500 to-amber-500"></div>
                <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-3">
                    <svg class="w-7 h-7 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    Advanced RAW Format Detected
                </h2>
                <p class="text-sm text-slate-300 mb-6 leading-relaxed font-medium">
                    You uploaded a DSLR format (<span id="raw-ext-badge" class="font-bold text-rose-300"></span>). Choose your processing path:
                </p>
                <div class="space-y-4 mt-6">
                    <button id="btn-modal-standard" class="w-full text-left p-5 rounded-xl border border-slate-600 bg-slate-800/80 hover:bg-slate-700 transition-all group shadow-md">
                        <span class="font-bold text-blue-400 block mb-1 text-lg">Standard Conversion (Fast)</span>
                        <span class="text-sm text-slate-400">Extracts the secret preview and safely exports a clean, highly-compatible JPEG.</span>
                    </button>
                    
                    <button id="btn-modal-forge" class="w-full text-left p-5 rounded-xl border border-rose-600 bg-rose-900/40 hover:bg-rose-800/60 transition-all group shadow-[0_0_15px_rgba(225,29,72,0.2)]">
                        <span id="btn-wasm-text" class="font-bold text-rose-300 flex items-center gap-2 mb-1 text-lg">
                            Execute Double-Pass Wiper
                        </span>
                        <span class="text-sm text-rose-200/80">Chains WebAssembly C++ and Native Algorithms to strictly retain your exact file extension losslessly.</span>
                    </button>
                    
                    <button id="btn-modal-cancel" class="w-full text-center p-3 rounded-xl border border-slate-700 bg-slate-800/50 hover:bg-slate-800 text-sm font-bold text-slate-300 transition-all">Cancel</button>
                </div>
            </div>
        </div>

        <div id="workspace-stage" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 items-start transition-all duration-500">
            <div class="lg:col-span-5 flex flex-col gap-4">
                <div class="glass-panel p-5 rounded-2xl flex flex-col gap-5 shadow-xl">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div id="input-box" class="preview-box scanning"><div class="scanner-line"></div><span class="preview-label">Original Input</span><img id="img-input" class="preview-img" alt="Input Preview"></div>
                            <span id="label-filename-input" class="filename-text text-slate-300">...</span>
                        </div>
                        <div>
                            <div class="preview-box border-emerald-600/50">
                                <span class="preview-label text-emerald-300 border-emerald-700 bg-emerald-900/80">Scrubbed Output</span>
                                <div id="output-placeholder" class="text-xs text-slate-500 font-mono text-center flex flex-col items-center gap-2">
                                    <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                    Awaiting Processing
                                </div>
                                <img id="img-output" class="preview-img hidden" alt="Output Preview">
                            </div>
                            <span id="label-filename-output" class="filename-text text-emerald-400 opacity-0 transition-opacity duration-500 font-bold">...</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 shadow-inner"><span class="block text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-bold">Input Size</span><span id="file-size" class="text-white font-mono text-sm">0 KB</span></div>
                        <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 shadow-inner text-right"><span class="block text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-bold">Engine</span><span id="badge-engine" class="text-white font-mono text-sm">Determining...</span></div>
                    </div>
                    <button id="btn-reset-app" class="w-full bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold px-4 py-4 rounded-xl transition-all border border-slate-600 shadow-lg">Abort & Load New Target</button>
                </div>
            </div>

            <div class="lg:col-span-7 flex flex-col gap-4">
                <div class="terminal shadow-2xl" id="main-terminal">
                    <div class="terminal-header">
                        <span class="text-white font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                            <svg class="w-4 h-4 text-current" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg> Forensic Audit Log
                        </span>
                        
                        <div id="export-options" class="hidden flex items-center gap-2">
                            <span class="text-[10px] text-slate-400 uppercase tracking-widest mr-1 font-bold">Save As:</span>
                            <button id="btn-export-txt" class="text-[10px] font-bold bg-slate-800 hover:bg-slate-700 text-white px-3 py-1 rounded border border-slate-600 transition-colors">TXT</button>
                            <button id="btn-export-json" class="text-[10px] font-bold bg-slate-800 hover:bg-slate-700 text-white px-3 py-1 rounded border border-slate-600 transition-colors">JSON</button>
                            <button id="btn-export-csv" class="text-[10px] font-bold bg-slate-800 hover:bg-slate-700 text-white px-3 py-1 rounded border border-slate-600 transition-colors">CSV</button>
                        </div>
                        
                        <span id="meta-count" class="bg-blue-900/30 text-blue-300 px-3 py-1 rounded-md text-[11px] font-mono font-bold border border-blue-800/50">0 Tags</span>
                    </div>
                    <div class="terminal-body" id="terminal-out"></div>
                </div>

                <div id="location-map-container">
                    <div class="relative w-full h-full rounded-xl overflow-hidden shadow-xl border border-rose-500/30">
                        <div class="absolute top-3 left-3 z-[400] bg-rose-950/90 text-rose-300 text-[10px] font-bold uppercase tracking-widest px-3 py-1.5 rounded border border-rose-500/50 shadow-lg backdrop-blur flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span> Location Data Found
                        </div>
                        <div id="leaflet-map" class="rounded-xl"></div>
                    </div>
                </div>

                <div id="action-area" class="glass-panel p-5 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-4 shadow-xl">
                    <div id="action-msg-container" class="flex flex-col gap-1">
                        <span id="status-indicator" class="status-badge status-scan w-max transition-colors duration-500">
                            <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Scanning
                        </span>
                        <span id="action-msg" class="text-sm mt-1 block text-slate-300 font-medium">Analyzing binary structure...</span>
                    </div>
                    
                    <button id="btn-scrub" disabled class="hidden w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold px-8 py-4 rounded-xl transition-all duration-300 opacity-50 cursor-not-allowed shadow-lg">
                        <span id="btn-scrub-text">Remove Metadata</span>
                    </button>
                    <button id="btn-download" class="hidden w-full md:w-auto bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold px-8 py-4 rounded-xl transition-all duration-300 shadow-[0_0_20px_rgba(16,185,129,0.3)]">Download Secure File</button>
                </div>
            </div>
        </div>

        <article class="mt-20 flex flex-col gap-16 border-t border-slate-800 pt-16">
            
            <section class="prose prose-invert prose-slate max-w-none glass-panel p-8 md:p-12 rounded-2xl shadow-xl">
                <h2 class="text-white text-3xl font-extrabold mb-6">Understanding EXIF and Image Metadata</h2>
                <p class="text-lg text-slate-300 leading-relaxed mb-6">Every time you take a picture with a smartphone or digital camera, the device invisibly attaches a massive payload of text-based information directly into the image file. This umbrella of information is known as <strong>Metadata</strong> (data about data). While some metadata is structurally required to render the image on a screen, much of it poses a severe privacy risk.</p>
                
                <h3 class="text-slate-200 text-xl font-bold mt-8 mb-4">The Three Layers of Hidden Data</h3>
                <ul class="space-y-4 list-none pl-0">
                    <li class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                        <strong class="text-blue-400 font-bold block mb-1 text-lg">EXIF (Exchangeable Image File Format):</strong> 
                        <span class="text-slate-300 text-sm">The most common tracking payload. Created by camera manufacturers, EXIF data records the exact make and model of your device, the camera's unique hardware serial number, the date and time the photo was taken, and crucially, the precise GPS latitude and longitude coordinates.</span>
                    </li>
                    <li class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                        <strong class="text-rose-400 font-bold block mb-1 text-lg">XMP (Extensible Metadata Platform):</strong> 
                        <span class="text-slate-300 text-sm">An XML-based standard created by Adobe. If you edit a photo in Lightroom or Photoshop, an XMP packet is injected into the file detailing your edit history, software versions, and custom creator tags.</span>
                    </li>
                    <li class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                        <strong class="text-emerald-400 font-bold block mb-1 text-lg">Structural Data:</strong> 
                        <span class="text-slate-300 text-sm">Non-threatening machine data such as Image Width, Height, Bit Depth, and Color Space. SilenVault automatically whitelists structural data to ensure your files remain visually flawless after purging.</span>
                    </li>
                </ul>

                <h3 class="text-slate-200 text-2xl font-bold mt-10 mb-4">Why You Must Scrub Your Images</h3>
                <p class="text-slate-300 leading-relaxed text-base">When you share an un-scrubbed image on forums, personal blogs, or via direct messaging apps, anyone can download that image and extract its EXIF payload in seconds. If the photo was taken at your home, the embedded GPS coordinates reveal your exact physical address to strangers. SilenVault acts as a cryptographic firewall, allowing you to audit the contents of your files, export the reports for your own records, and permanently obliterate the tracking data before you publish.</p>
            </section>

            <section>
                <div class="mb-10 text-center max-w-2xl mx-auto">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight">Standard Operating Procedure</h2>
                    <p class="text-slate-400 mt-4 text-lg">How to securely audit and annihilate image metadata using SilenVault.</p>
                </div>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-panel p-8 rounded-2xl relative overflow-hidden group shadow-lg">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="text-7xl font-black font-mono text-blue-500">01</span></div>
                        <h3 class="text-xl font-bold text-white mb-3 relative z-10">Establish Target</h3>
                        <p class="text-sm text-slate-300 leading-relaxed relative z-10">Upload any standard web image or heavy DSLR RAW file. Processing occurs 100% within your browser's local RAM. No uploads.</p>
                    </div>
                    <div class="glass-panel p-8 rounded-2xl relative overflow-hidden group shadow-lg">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="text-7xl font-black font-mono text-amber-500">02</span></div>
                        <h3 class="text-xl font-bold text-white mb-3 relative z-10">Forensic Audit</h3>
                        <p class="text-sm text-slate-300 leading-relaxed relative z-10">Our engine parses the binary file, extracting hidden structural headers, EXIF data, XMP XML packets, and embedded GPS coordinates.</p>
                    </div>
                    <div class="glass-panel p-8 rounded-2xl relative overflow-hidden group shadow-lg">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="text-7xl font-black font-mono text-rose-500">03</span></div>
                        <h3 class="text-xl font-bold text-white mb-3 relative z-10">Execute Purge</h3>
                        <p class="text-sm text-slate-300 leading-relaxed relative z-10">Depending on the format, the system deploys HTML5 Canvas re-encoding or a Native Deep TIFF Wiper to annihilate privacy threats.</p>
                    </div>
                    <div class="glass-panel p-8 rounded-2xl relative overflow-hidden group shadow-lg">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="text-7xl font-black font-mono text-emerald-500">04</span></div>
                        <h3 class="text-xl font-bold text-white mb-3 relative z-10">Verification Gate</h3>
                        <p class="text-sm text-slate-300 leading-relaxed relative z-10">The newly generated file is intercepted and re-scanned. If even a single metadata tag survives, the download is blocked to guarantee safety.</p>
                    </div>
                </div>
            </section>

            <section class="grid lg:grid-cols-12 gap-12 items-start bg-slate-900/50 p-8 md:p-12 rounded-3xl border border-slate-800">
                <div class="lg:col-span-5 sticky top-8">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight mb-4">The Architecture</h2>
                    <p class="text-slate-300 mb-8 text-lg leading-relaxed">Unlike standard online converters that upload your personal files to a remote server, SilenVault utilizes a <strong>Tree-Branching Architecture</strong> to process files locally.</p>
                    <div class="p-6 bg-blue-900/20 border border-blue-500/30 rounded-2xl shadow-inner">
                        <h4 class="text-blue-400 font-bold mb-3 flex items-center gap-2 text-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg> Zero-Trust Promise
                        </h4>
                        <p class="text-sm text-blue-200/80 leading-relaxed">Your files are processed strictly in your device's memory. We have no servers, no databases, and absolutely no access to your images or their contents.</p>
                    </div>
                </div>
                <div class="lg:col-span-7 space-y-6">
                    <div class="glass-panel p-8 rounded-2xl shadow-md border-slate-700 hover:border-blue-500/50 transition-colors">
                        <div class="flex items-center gap-4 mb-4"><span class="p-2 bg-slate-800 rounded text-white font-mono text-xs font-bold border border-slate-600 shadow-inner">CANVAS API</span><h3 class="text-xl font-bold text-white">Pixel-Matrix Re-encoding</h3></div>
                        <p class="text-slate-400 leading-relaxed text-sm">Used for standard web formats. The browser unpacks the image into a raw matrix of RGB pixels, paints it onto an invisible HTML5 canvas, and exports a brand new file. Painting only the pixels guarantees that 100% of the tracking data is left behind.</p>
                    </div>
                    
                    <div class="glass-panel p-8 rounded-2xl shadow-md border-rose-900/30 hover:border-rose-500/50 transition-colors bg-rose-950/10">
                        <div class="flex flex-col gap-2 mb-4">
                            <div class="flex gap-2">
                                <span class="p-2 bg-indigo-900/40 rounded text-indigo-300 font-mono text-xs font-bold border border-indigo-500/50 shadow-inner">WASM EXIV2</span>
                                <span class="p-2 bg-rose-900/40 rounded text-rose-300 font-mono text-xs font-bold border border-rose-500/50 shadow-inner">NATIVE TIFF WIPER</span>
                            </div>
                            <h3 class="text-xl font-bold text-white mt-2">The Double-Pass Wiper</h3>
                        </div>
                        <p class="text-slate-400 leading-relaxed text-sm">Deployed for advanced proprietary formats (CR2, DNG). SilenVault dynamically injects a WebAssembly C++ engine to perform a structural sweep. Immediately after, a custom Native Javascript Algorithm mathematically walks the binary tree, validates structural tags necessary for the image to exist, and physically overwrites any surviving pointers to GPS or MakerNotes with null bytes.</p>
                    </div>
                </div>
            </section>
            
            <div class="text-center pb-8 mt-8">
                <p class="text-xs text-slate-500 border-t border-slate-800 pt-8 max-w-3xl mx-auto leading-relaxed">
                    <strong>LEGAL DISCLAIMER:</strong> SilenVault provides this tool for personal privacy protection and forensic auditing. The removal of EXIF metadata and XMP packets is an irreversible cryptographic process. Always maintain backups of your original RAW files before initiating a Deep Forge wipe.
                </p>
            </div>
        </article>
    </main>

    <script type="module">
        'use strict'; 

        // ==========================================
        // 1. MONOLITH CLASSES & DOUBLE-PASS ENGINE
        // ==========================================
        class BaseProcessor {
            constructor(file, ext) { this.file = file; this.ext = ext; }
            async parse() {
                const buffer = await this.file.arrayBuffer(); 
                return await window.exifr.parse(buffer, {tiff: true, ifd0: true, exif: true, gps: true, xmp: true, iptc: true});
            }
            async getPreviewUrl() { return URL.createObjectURL(this.file); }
        }

        class CanvasProcessor extends BaseProcessor {
            constructor(file, ext, outputMime) {
                super(file, ext);
                this.outputMime = outputMime || 'image/jpeg';
                this.engineName = 'HTML5 Canvas API';
                this.engineClass = 'text-blue-300 font-mono';
                this.buttonText = 'Remove Metadata';
            }

            async getPreviewUrl() {
                if (['CR2', 'DNG', 'NEF', 'ARW'].includes(this.ext.toUpperCase())) {
                    try {
                        const thumbBuffer = await window.exifr.thumbnail(this.file);
                        if(thumbBuffer) return URL.createObjectURL(new Blob([thumbBuffer], {type: 'image/jpeg'}));
                        throw new Error();
                    } catch(e) {
                        try {
                            const buffer = await this.file.arrayBuffer();
                            const ifds = window.UTIF.decode(buffer);
                            window.UTIF.decodeImage(buffer, ifds[0]);
                            const rgba = window.UTIF.toRGBA8(ifds[0]);
                            const canvas = document.createElement('canvas');
                            canvas.width = ifds[0].width; canvas.height = ifds[0].height;
                            canvas.getContext('2d').putImageData(new ImageData(new Uint8ClampedArray(rgba.buffer), ifds[0].width, ifds[0].height), 0, 0);
                            return canvas.toDataURL('image/png');
                        } catch(err) { return null; }
                    }
                }
                return URL.createObjectURL(this.file);
            }

            async scrub(imgElement) {
                const canvas = document.createElement('canvas');
                canvas.width = imgElement.naturalWidth;
                canvas.height = imgElement.naturalHeight;
                canvas.getContext('2d').drawImage(imgElement, 0, 0);
                const quality = (this.outputMime === 'image/jpeg' || this.outputMime === 'image/webp') ? 0.92 : undefined;
                return new Promise((resolve) => canvas.toBlob(blob => resolve(blob), this.outputMime, quality));
            }
        }

        class WebpProcessor extends CanvasProcessor {
            constructor(file, ext) { super(file, ext, 'image/webp'); this.engineName = 'WebP Canvas Engine'; }
        }

        class DoublePassRawProcessor extends BaseProcessor {
            constructor(file, ext) {
                super(file, ext);
                this.engineName = 'Double-Pass Wiper (WASM + Native)';
                this.engineClass = 'text-rose-400 font-mono';
                this.buttonText = 'Execute Double-Pass Wiper';
                this.exifCache = {};
            }
            async getPreviewUrl() { return new CanvasProcessor(this.file, this.ext).getPreviewUrl(); }
            
            setCache(cache) { this.exifCache = cache; }

            async loadWasm() {
                if (window.exiv2Api) return; 
                try {
                    const module = await import('../assets/wasm/exiv2.esm.js');
                    const exiv2Factory = module.default || module;
                    window.exiv2Api = await exiv2Factory({
                        locateFile: (path) => {
                            if (path.endsWith('.wasm')) return '../assets/wasm/exiv2.esm.wasm';
                            return path;
                        }
                    });
                } catch (err) {
                    console.warn("WASM Engine failed to load. Will rely entirely on Native Wiper.");
                }
            }

            async scrub() {
                let bufferToProcess = await this.file.arrayBuffer();
                
                // PASS 1: WASM C++ Engine
                if (window.exiv2Api) {
                    try {
                        const terminalOut = document.getElementById('terminal-out');
                        terminalOut.innerHTML += `<div class="log-line"><span class="val-sys">> INITIATING PASS 1: WASM C++ ENGINE...</span></div>`;
                        const img = new window.exiv2Api.Image(new Uint8Array(bufferToProcess));
                        img.clearExif();
                        img.clearIptc();
                        img.clearXmp();
                        // Update buffer with WASM-cleaned data
                        bufferToProcess = img.getBytes().buffer;
                        img.delete();
                        terminalOut.innerHTML += `<div class="log-line"><span class="log-key">PASS 1</span><span class="val-safe">WASM EXECUTION SUCCESSFUL</span></div>`;
                    } catch (e) {
                        const terminalOut = document.getElementById('terminal-out');
                        terminalOut.innerHTML += `<div class="log-line"><span class="log-key">PASS 1</span><span class="val-med">WASM REJECTED FORMAT. BYPASSING...</span></div>`;
                    }
                }

                // PASS 2: Native Deep TIFF Wiper
                const terminalOut = document.getElementById('terminal-out');
                terminalOut.innerHTML += `<div class="log-line"><span class="val-sys">> INITIATING PASS 2: NATIVE DEEP TIFF WIPER...</span></div>`;
                
                const finalUint8Array = this.runNativeTiffWiper(bufferToProcess);
                
                terminalOut.innerHTML += `<div class="log-line"><span class="log-key">PASS 2</span><span class="val-safe">NATIVE ORPHANING COMPLETE</span></div>`;
                return new Blob([finalUint8Array], { type: this.file.type || '' });
            }

            runNativeTiffWiper(arrayBuffer) {
                let dataView = new DataView(arrayBuffer);
                let uint8Array = new Uint8Array(arrayBuffer);
                let isLittle = dataView.getUint16(0) === 0x4949; 

                const structuralTags = [
                    0x00FE, 0x0100, 0x0101, 0x0102, 0x0103, 0x0106, 0x0111, 0x0112, 0x0115, 0x0116, 0x0117,
                    0x011A, 0x011B, 0x011C, 0x0128, 0x014A, 0x0214, 0x0133, 0x0142, 0x0143, 0x0144,
                    0x828D, 0x828E, 0x9216, 0xC612, 0xC613, 0xC614, 0xC615, 0xC61F, 0xC620, 0xC621,
                    0xC622, 0xC623, 0xC624, 0xC627, 0xC628, 0xC62A, 0xC62B, 0xC62C, 0xC62D, 0xC62E,
                    0xC62F, 0xC630, 0xC632, 0xC633, 0xC634, 0xC635, 0xC65A, 0xC65B, 0xC68D, 0xC68E
                ];

                const wipeIfd = (offset) => {
                    if (offset === 0 || offset >= dataView.byteLength - 2) return;
                    const numEntries = dataView.getUint16(offset, isLittle);
                    let currentOffset = offset + 2;

                    for (let i = 0; i < numEntries; i++) {
                        if (currentOffset + 12 > dataView.byteLength) break;
                        const tagId = dataView.getUint16(currentOffset, isLittle);
                        const type = dataView.getUint16(currentOffset + 2, isLittle);
                        const count = dataView.getUint32(currentOffset + 4, isLittle);
                        const valueOffset = dataView.getUint32(currentOffset + 8, isLittle);

                        let bytesPerComponent = [0, 1, 1, 2, 4, 8, 1, 1, 2, 4, 8, 4, 8][type] || 1;
                        let totalSize = count * bytesPerComponent;

                        if (tagId === 0x8769 || tagId === 0x8825 || tagId === 0x927C || tagId === 0x02BC) { 
                            if(valueOffset > 0 && valueOffset < dataView.byteLength && type === 4) wipeIfd(valueOffset);
                            for (let j = 0; j < 12; j++) uint8Array[currentOffset + j] = 0;
                        } else if (!structuralTags.includes(tagId)) {
                            if (totalSize > 4 && valueOffset > 0 && valueOffset + totalSize <= dataView.byteLength) {
                                for (let j = 0; j < totalSize; j++) uint8Array[valueOffset + j] = 0;
                            }
                            for (let j = 0; j < 12; j++) uint8Array[currentOffset + j] = 0;
                        }
                        currentOffset += 12;
                    }
                    if (currentOffset + 4 <= dataView.byteLength) {
                        const nextIfd = dataView.getUint32(currentOffset, isLittle);
                        if (nextIfd > 0 && nextIfd < dataView.byteLength) wipeIfd(nextIfd);
                    }
                };

                try { wipeIfd(dataView.getUint32(4, isLittle)); } catch(e) {}

                const encoder = new TextEncoder();
                const targets = ['<?xpacket', 'x:xmpmeta', 'http://ns.adobe.com', 'Exif', 'Canon', 'Nikon', 'Sony'];
                Object.values(this.exifCache).forEach(val => { if (typeof val === 'string' && val.length > 3) targets.push(val); });

                targets.forEach(str => {
                    const bytes = encoder.encode(str);
                    for (let i = 0; i < uint8Array.length - bytes.length; i++) {
                        let match = true;
                        for (let j = 0; j < bytes.length; j++) if (uint8Array[i + j] !== bytes[j]) { match = false; break; }
                        if (match) {
                            for (let j = 0; j < Math.min(1000, uint8Array.length - i); j++) {
                                if (uint8Array[i + j] === 0) break;
                                uint8Array[i + j] = 0x20; 
                            }
                        }
                    }
                });

                return uint8Array;
            }
        }

        class ProcessorFactory {
            static create(file, ext, isAdvancedMode = false) {
                const extension = ext.toUpperCase();
                switch(extension) {
                    case 'WEBP': return new WebpProcessor(file, extension);
                    case 'PNG': return new CanvasProcessor(file, extension, 'image/png');
                    case 'DNG': case 'CR2': case 'NEF': case 'ARW':
                        return isAdvancedMode ? new DoublePassRawProcessor(file, extension) : new CanvasProcessor(file, extension, 'image/jpeg');
                    case 'JPG': case 'JPEG': case 'JFIF': return new CanvasProcessor(file, extension, 'image/jpeg');
                    default: return new CanvasProcessor(file, extension, 'image/jpeg'); 
                }
            }
        }

        // ==========================================
        // 2. STATE & MEMORY MANAGEMENT
        // ==========================================
        let originalFile = null;
        let scrubbedBlob = null;
        let sourceImageObj = new Image(); 
        let processorInstance = null;
        let fileExt = '';
        let outputExt = ''; 
        let isAdvancedMode = false;
        let rawExifCache = {}; 
        let currentScanId = 0;
        let threatMap = null;
        let mapMarker = null;
        let activeUrls = []; 

        const STRUCTURAL_WHITELIST = ['ImageWidth', 'ImageHeight', 'ExifImageWidth', 'ExifImageHeight', 'Orientation', 'ColorSpace', 'Compression', 'XResolution', 'YResolution', 'ResolutionUnit', 'BitDepth', 'ColorType', 'Filter', 'Interlace', 'SamplesPerPixel'];

        // ==========================================
        // 3. UI EVENT BINDING
        // ==========================================
        const dz = document.getElementById('drop-zone');
        dz.addEventListener('dragenter', e => { e.preventDefault(); e.stopPropagation(); dz.classList.add('dragover'); });
        dz.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('dragover'); });
        dz.addEventListener('drop', e => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
        document.getElementById('file-input').addEventListener('change', e => handleFile(e.target.files[0]));

        document.getElementById('btn-modal-standard').addEventListener('click', () => executeCrossroads('standard'));
        document.getElementById('btn-modal-forge').addEventListener('click', () => executeCrossroads('forge'));
        document.getElementById('btn-modal-cancel').addEventListener('click', cancelCrossroads);

        document.getElementById('btn-reset-app').addEventListener('click', () => resetApp(false));
        document.getElementById('btn-scrub').addEventListener('click', executeImageProcessing);
        document.getElementById('btn-download').addEventListener('click', downloadImage);

        document.getElementById('btn-export-txt').addEventListener('click', () => exportReport('txt'));
        document.getElementById('btn-export-json').addEventListener('click', () => exportReport('json'));
        document.getElementById('btn-export-csv').addEventListener('click', () => exportReport('csv'));

        // ==========================================
        // 4. CORE LOGIC
        // ==========================================
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024, i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + ['Bytes', 'KB', 'MB'][i];
        }

        function isPrivacyThreat(key, val) {
            if (STRUCTURAL_WHITELIST.includes(key)) return false; 
            if (typeof val === 'object' && val !== null && !(val instanceof Date)) return false; 
            return true;
        }

        function getSeverity(key) {
            if (['latitude', 'longitude', 'gps', 'serial'].some(h => key.toLowerCase().includes(h))) return 'high';
            return 'low';
        }

        function logToTerminal(key, val, severity = 'low') {
            const terminalOut = document.getElementById('terminal-out');
            const line = document.createElement('div');
            line.className = 'log-line';
            const safeVal = (typeof val === 'string') ? val.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : val;
            if (severity === 'sys') line.innerHTML = `<span class="val-sys">${safeVal}</span>`;
            else if (severity === 'safe') line.innerHTML = `<span class="log-key">${key}</span><span class="val-safe">${safeVal}</span>`;
            else line.innerHTML = `<span class="log-key">${key}</span><span class="log-val val-${severity}">${safeVal}</span>`;
            terminalOut.appendChild(line);
            terminalOut.scrollTop = terminalOut.scrollHeight;
        }

        function handleFile(file) {
            if (!file) return;
            activeUrls.forEach(url => URL.revokeObjectURL(url));
            activeUrls = [];

            originalFile = file;
            fileExt = file.name.split('.').pop().toUpperCase();
            document.getElementById('label-filename-input').innerText = file.name;
            
            if (['CR2', 'DNG', 'NEF', 'ARW'].includes(fileExt)) {
                if (isAdvancedMode) {
                    processorInstance = ProcessorFactory.create(originalFile, fileExt, true);
                    startWorkspace(); return;
                }
                document.getElementById('raw-ext-badge').innerText = `.${fileExt}`;
                document.getElementById('crossroads-modal-wrapper').classList.add('active');
                return;
            }
            
            isAdvancedMode = false;
            processorInstance = ProcessorFactory.create(originalFile, fileExt, false);
            startWorkspace(); 
        }

        async function executeCrossroads(mode) {
            if (mode === 'forge') {
                isAdvancedMode = true;
                const btnText = document.getElementById('btn-wasm-text');
                const originalText = btnText.innerHTML;
                btnText.innerHTML = `<svg class="w-5 h-5 animate-spin inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Loading Resources...`;
                
                processorInstance = ProcessorFactory.create(originalFile, fileExt, true);
                
                try {
                    await processorInstance.loadWasm(); 
                    
                    document.getElementById('crossroads-modal-wrapper').classList.remove('active');
                    document.body.classList.add('portal-transition'); 
                    document.getElementById('main-body').classList.add('forge-mode');
                    document.getElementById('title-accent').className = "text-transparent bg-clip-text bg-gradient-to-r from-rose-500 to-amber-500 transition-all duration-1000";
                    document.getElementById('dz-icon-wrap').className = "bg-rose-500/10 p-6 rounded-full mb-6 border border-rose-500/20";
                    document.getElementById('dz-icon').setAttribute('class', "w-14 h-14 text-rose-500 transition-colors duration-500");
                    
                    startWorkspace();
                    setTimeout(() => document.body.classList.remove('portal-transition'), 600);
                } catch(e) {
                    // Fallback to purely native if WASM fails to load
                    document.getElementById('crossroads-modal-wrapper').classList.remove('active');
                    document.body.classList.add('portal-transition'); 
                    document.getElementById('main-body').classList.add('forge-mode');
                    document.getElementById('title-accent').className = "text-transparent bg-clip-text bg-gradient-to-r from-rose-500 to-amber-500 transition-all duration-1000";
                    startWorkspace();
                    setTimeout(() => document.body.classList.remove('portal-transition'), 600);
                } finally {
                    btnText.innerHTML = originalText;
                }
            } else {
                isAdvancedMode = false;
                processorInstance = ProcessorFactory.create(originalFile, fileExt, false);
                document.getElementById('crossroads-modal-wrapper').classList.remove('active');
                startWorkspace();
            }
        }

        function cancelCrossroads() {
            document.getElementById('crossroads-modal-wrapper').classList.remove('active');
            document.getElementById('file-input').value = '';
            originalFile = null;
        }

        function startWorkspace() {
            currentScanId++;
            let thisScanId = currentScanId;

            rawExifCache = {};
            if (threatMap) document.getElementById('location-map-container').classList.remove('active');
            document.getElementById('export-options').classList.add('hidden');
            
            document.getElementById('file-size').innerText = formatBytes(originalFile.size);
            document.getElementById('upload-stage').classList.add('hidden');
            document.getElementById('workspace-stage').classList.remove('hidden');
            
            document.getElementById('terminal-out').innerHTML = '';
            document.getElementById('input-box').classList.add('scanning');
            document.getElementById('img-input').classList.remove('scanned');
            
            document.getElementById('btn-scrub').disabled = true;
            document.getElementById('btn-scrub').classList.add('opacity-50', 'cursor-not-allowed', 'hidden');
            document.getElementById('btn-download').classList.add('hidden');

            document.getElementById('badge-engine').innerText = processorInstance.engineName;
            
            if(isAdvancedMode) {
                document.getElementById('badge-engine').className = processorInstance.engineClass;
                document.getElementById('btn-scrub').className = "hidden w-full md:w-auto bg-rose-700 hover:bg-rose-600 text-white text-sm font-bold px-8 py-4 rounded-xl transition-all duration-300 shadow-[0_0_20px_rgba(225,29,72,0.4)] flex items-center justify-center opacity-50 cursor-not-allowed";
            } else {
                document.getElementById('badge-engine').className = processorInstance.engineClass;
                document.getElementById('btn-scrub').className = "hidden w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold px-8 py-4 rounded-xl transition-all duration-300 shadow-[0_0_20px_rgba(59,130,246,0.3)] flex items-center justify-center opacity-50 cursor-not-allowed";
            }
            document.getElementById('btn-scrub-text').innerText = processorInstance.buttonText;

            logToTerminal('', '> INITIALIZING SECURE METADATA AUDIT...', 'sys');

            requestAnimationFrame(() => setTimeout(() => runHeavyProcessing(thisScanId), 50));
        }

        async function runHeavyProcessing(thisScanId) {
            try {
                let urlToLoad = await processorInstance.getPreviewUrl();
                if (urlToLoad) {
                    activeUrls.push(urlToLoad);
                    await new Promise((resolve, reject) => {
                        sourceImageObj.onload = () => resolve();
                        sourceImageObj.onerror = () => reject();
                        sourceImageObj.src = urlToLoad;
                    });
                    document.getElementById('img-input').src = urlToLoad;
                }
            } catch(e) {}
            scanMetadata(thisScanId);
        }

        async function scanMetadata(thisScanId) {
            try {
                const buffer = await originalFile.arrayBuffer();
                const exifData = await window.exifr.parse(buffer, {tiff: true, ifd0: true, exif: true, gps: true, xmp: true, iptc: true});
                if (thisScanId !== currentScanId) return; 

                if (exifData && Object.keys(exifData).length > 0) {
                    const usefulKeys = Object.keys(exifData).filter(key => isPrivacyThreat(key, exifData[key]));
                    if (usefulKeys.length === 0) return handleCleanFile();
                    
                    document.getElementById('meta-count').innerText = `${usefulKeys.length} Tags`;
                    
                    let idx = 0;
                    function printNextLog() {
                        if (thisScanId !== currentScanId) return;
                        if (idx >= usefulKeys.length) {
                            document.getElementById('input-box').classList.remove('scanning');
                            document.getElementById('img-input').classList.add('scanned');
                            logToTerminal('', `> SCAN COMPLETE. [${usefulKeys.length}] THREAT TAGS FOUND.`, 'sys');

                            if (exifData.latitude && exifData.longitude) {
                                triggerMap(exifData.latitude, exifData.longitude);
                                document.getElementById('status-indicator').className = "status-badge status-danger";
                                document.getElementById('status-indicator').innerHTML = `CRITICAL THREAT`;
                                document.getElementById('action-msg').innerHTML = `<span class="text-rose-400 font-bold">Location Exposed:</span> Immediate purge required.`;
                            } else {
                                document.getElementById('status-indicator').className = "status-badge status-warn";
                                document.getElementById('status-indicator').innerHTML = `Metadata Present`;
                                document.getElementById('action-msg').innerHTML = `<span class="text-amber-400 font-bold">Action Required:</span> Hidden trackers found.`;
                            }

                            document.getElementById('btn-scrub').disabled = false;
                            document.getElementById('btn-scrub').classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
                            document.getElementById('export-options').classList.remove('hidden'); 
                            
                            // Pass the extracted cache to the processor so it knows exactly what strings to wipe in Pass 2
                            if (processorInstance.setCache) processorInstance.setCache(rawExifCache);
                            return;
                        }

                        let key = usefulKeys[idx];
                        let val = exifData[key];
                        if (val instanceof Date) val = val.toISOString();
                        rawExifCache[key] = val; 

                        logToTerminal(key, val, getSeverity(key));
                        idx++;
                        setTimeout(printNextLog, isAdvancedMode ? 5 : 15);
                    }
                    setTimeout(printNextLog, 100);

                } else {
                    handleCleanFile();
                }
            } catch (error) {
                handleCleanFile();
            }
        }

        function triggerMap(lat, lng) {
            document.getElementById('location-map-container').classList.add('active'); 
            const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            if (!threatMap) {
                threatMap = L.map('leaflet-map').setView([lat, lng], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(threatMap);
                mapMarker = L.marker([lat, lng], {icon: redIcon}).addTo(threatMap);
            } else {
                threatMap.setView([lat, lng], 14);
                mapMarker.setLatLng([lat, lng]);
            }
            setTimeout(() => { threatMap.invalidateSize(); }, 300);
        }

        function handleCleanFile() {
            setTimeout(() => {
                document.getElementById('input-box').classList.remove('scanning');
                document.getElementById('img-input').classList.add('scanned');
                document.getElementById('meta-count').innerText = `0 Tags`;
                logToTerminal('', '> SCAN COMPLETE. NO PRIVACY DATA DETECTED.', 'sys');
                logToTerminal('STATUS', 'CLEAN', 'safe');
                
                document.getElementById('status-indicator').className = "status-badge status-safe";
                document.getElementById('status-indicator').innerHTML = `Safe File`;
                document.getElementById('action-msg').innerHTML = `<span class="text-emerald-400 font-bold">Verified:</span> Image is natively safe. You may still Force Purge.`;

                scrubbedBlob = originalFile; 
                outputExt = `.${fileExt.toLowerCase()}`;
                document.getElementById('img-output').src = document.getElementById('img-input').src;
                document.getElementById('output-placeholder').classList.add('hidden');
                document.getElementById('img-output').classList.remove('hidden');
                
                document.getElementById('label-filename-output').innerText = originalFile.name;
                document.getElementById('label-filename-output').classList.remove('opacity-0');
                
                document.getElementById('btn-scrub-text').innerText = "Force Purge";
                document.getElementById('btn-scrub').disabled = false;
                document.getElementById('btn-scrub').classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
                document.getElementById('btn-download').classList.remove('hidden');
            }, 1000);
        }

        function executeImageProcessing() {
            document.getElementById('btn-scrub').disabled = true;
            document.getElementById('btn-scrub').classList.add('opacity-50', 'cursor-not-allowed');

            setTimeout(async () => {
                try {
                    const blob = await processorInstance.scrub(sourceImageObj);
                    outputExt = processorInstance.outputMime ? `.${processorInstance.outputMime.split('/')[1]}` : `.${fileExt.toLowerCase()}`;
                    if (outputExt === '.jpeg') outputExt = '.jpg';
                    verifyAndFinalize(blob);
                } catch(e) {
                    logToTerminal('CRITICAL_ERROR', e.message || 'Processing engine failed.', 'high');
                    document.getElementById('btn-scrub-text').innerText = "Failed";
                }
            }, 50);
        }

        async function verifyAndFinalize(blob) {
            logToTerminal('', '> RUNNING POST-SCRUB VERIFICATION AUDIT...', 'sys');
            try {
                const fileBuffer = await blob.arrayBuffer();
                const checkData = await window.exifr.parse(fileBuffer, {tiff: true, ifd0: true, exif: true, gps: true});
                if (checkData) {
                    const surviving = Object.keys(checkData).filter(k => isPrivacyThreat(k, checkData[k]));
                    if (surviving.length > 0) {
                        logToTerminal('VERIFICATION_FAILED', `${surviving.length} privacy tags survived.`, 'high');
                        document.getElementById('btn-scrub-text').innerText = "Verification Failed";
                        document.getElementById('action-msg').innerHTML = `<span class="text-rose-400 font-bold">Error:</span> Output failed safety verification.`;
                        return;
                    }
                }
            } catch(e) {}

            logToTerminal('VERIFICATION', 'PASSED. 0 PII THREATS DETECTED.', 'safe');
            logToTerminal('FORMAT', `${outputExt.toUpperCase()} EXACT RETENTION`, 'safe');
            
            scrubbedBlob = blob;
            document.getElementById('location-map-container').classList.remove('active'); 
            
            document.getElementById('status-indicator').className = "status-badge status-safe";
            document.getElementById('status-indicator').innerHTML = `Threat Neutralized`;
            document.getElementById('action-msg').innerHTML = `<span class="text-emerald-400 font-bold">Success:</span> Metadata completely stripped.`;
            
            document.getElementById('file-size').innerText = formatBytes(blob.size);

            const outputUrl = URL.createObjectURL(blob);
            activeUrls.push(outputUrl);
            
            if (processorInstance.outputMime) document.getElementById('img-output').src = outputUrl;
            else document.getElementById('img-output').src = document.getElementById('img-input').src; 
            
            document.getElementById('output-placeholder').classList.add('hidden');
            document.getElementById('img-output').classList.remove('hidden');
            
            const nameBase = originalFile.name.substring(0, originalFile.name.lastIndexOf('.'));
            document.getElementById('label-filename-output').innerText = `${nameBase}_clean${outputExt}`;
            document.getElementById('label-filename-output').classList.remove('opacity-0');
            
            document.getElementById('btn-scrub').classList.add('hidden');
            document.getElementById('export-options').classList.add('hidden'); 
            document.getElementById('btn-download').classList.remove('hidden');
        }

        function downloadImage() {
            if (!scrubbedBlob) return;
            const nameBase = originalFile.name.substring(0, originalFile.name.lastIndexOf('.'));
            const url = URL.createObjectURL(scrubbedBlob);
            activeUrls.push(url);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${nameBase}_clean${outputExt}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function exportReport(format = 'txt') {
            let content = '';
            let mimeType = 'text/plain';
            let fileExt = 'txt';

            if (format === 'txt') {
                content = `SilenVault EXIF Audit Report\nFilename: ${originalFile.name}\nScanned: ${new Date().toLocaleString()}\n----------------------------------------\n\n`;
                for (const [key, value] of Object.entries(rawExifCache)) content += `${key}: ${value}\n`;
            } else if (format === 'json') {
                content = JSON.stringify(rawExifCache, null, 2);
                mimeType = 'application/json';
                fileExt = 'json';
            } else if (format === 'csv') {
                content = "Key,Value\n";
                for (const [key, value] of Object.entries(rawExifCache)) {
                    let safeVal = String(value).replace(/"/g, '""'); 
                    content += `"${key}","${safeVal}"\n`;
                }
                mimeType = 'text/csv';
                fileExt = 'csv';
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            activeUrls.push(url);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${originalFile.name}_EXIF_Report.${fileExt}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function resetApp(retainMode = false) {
            activeUrls.forEach(url => URL.revokeObjectURL(url));
            activeUrls = [];
            
            if (threatMap) { threatMap.remove(); threatMap = null; }
            document.getElementById('location-map-container').classList.remove('active');
            
            if (!retainMode) {
                isAdvancedMode = false;
                document.getElementById('main-body').classList.remove('forge-mode');
                document.body.classList.remove('portal-transition');
                document.getElementById('title-accent').className = "text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 transition-all duration-1000";
                document.getElementById('title-accent').innerText = "Scrubber";
                document.getElementById('dz-icon-wrap').className = "bg-blue-500/10 p-6 rounded-full mb-6 border border-blue-500/20 shadow-[0_0_20px_rgba(59,130,246,0.15)]";
                document.getElementById('dz-icon').setAttribute('class', "w-14 h-14 text-blue-400");
            }
            
            document.getElementById('workspace-stage').classList.add('hidden');
            document.getElementById('upload-stage').classList.remove('hidden');
            document.getElementById('export-options').classList.add('hidden');
            
            document.getElementById('file-input').value = '';
            originalFile = null; scrubbedBlob = null; processorInstance = null;
            rawExifCache = {}; currentScanId++; sourceImageObj = new Image();
            
            document.getElementById('terminal-out').innerHTML = '';
            document.getElementById('img-input').src = ''; document.getElementById('img-output').src = '';
            document.getElementById('input-box').classList.add('scanning'); 
            document.getElementById('img-input').classList.remove('scanned');
            document.getElementById('output-placeholder').classList.remove('hidden'); 
            document.getElementById('img-output').classList.add('hidden');
            document.getElementById('label-filename-input').innerText = '...'; 
            document.getElementById('label-filename-output').classList.add('opacity-0');

            document.getElementById('btn-scrub').disabled = true;
            document.getElementById('btn-scrub').classList.add('opacity-50', 'cursor-not-allowed', 'hidden');
            document.getElementById('btn-download').classList.add('hidden');
        }
    </script>
</body>
</html>
