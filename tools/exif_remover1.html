<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF Remover & Image Metadata Scrubber | SilenVault</title>
    <meta name="description" content="Local-first forensic tool to permanently remove hidden EXIF data.">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5449371042798610" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --bg-color: #020617; --panel-bg: rgba(15, 23, 42, 0.6); --border-color: #1e293b; --accent-glow: rgba(59, 130, 246, 0.2); --primary-text: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); overflow-x: hidden; transition: background-color 0.8s ease; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(12px); border: 1px solid var(--border-color); transition: all 0.5s ease; }
        .mono { font-family: 'Fira Code', monospace; }

        body.forge-mode { --bg-color: #0a0002; --panel-bg: rgba(20, 0, 5, 0.7); --border-color: #4c0519; --accent-glow: rgba(225, 29, 72, 0.2); background-image: linear-gradient(rgba(225, 29, 72, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(225, 29, 72, 0.05) 1px, transparent 1px); background-size: 30px 30px; }
        .forge-mode .status-scan { background: rgba(225, 29, 72, 0.1) !important; color: #e11d48 !important; border-color: rgba(225, 29, 72, 0.3) !important; }
        .forge-mode .scanner-line { background: #e11d48 !important; box-shadow: 0 0 15px #e11d48, 0 0 30px #e11d48 !important; }

        .portal-transition { animation: portalFade 0.6s ease-in-out forwards; }
        @keyframes portalFade { 0% { filter: contrast(1); opacity: 1; } 50% { filter: blur(2px); opacity: 0.8; } 100% { filter: blur(0px); opacity: 1; } }

        .drop-zone { border: 2px dashed var(--border-color); border-radius: 1rem; background: rgba(0,0,0,0.4); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 350px; transition: all 0.4s ease; cursor: pointer; position: relative; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background: var(--accent-glow); }
        .forge-mode .drop-zone:hover { border-color: #e11d48; }
        .drop-zone input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        .preview-box { border: 2px solid var(--border-color); border-radius: 8px; background: #000; overflow: hidden; position: relative; height: 250px; display: flex; align-items: center; justify-content: center; }
        .preview-img { max-width: 100%; max-height: 100%; object-fit: contain; opacity: 0.5; transition: opacity 0.5s ease; }
        .preview-img.scanned { opacity: 1; }
        .preview-label { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.8); border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #cbd5e1; z-index: 10; }
        .scanner-line { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: #3b82f6; box-shadow: 0 0 15px #3b82f6; animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; z-index: 20; display: none; }
        .scanning .scanner-line { display: block; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        .terminal { background: rgba(0,0,0,0.8); border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Fira Code', monospace; font-size: 12px; height: 300px; display: flex; flex-direction: column; transition: all 0.5s ease; }
        .terminal-header { background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border-color); padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .terminal-body { padding: 16px; overflow-y: auto; flex: 1; color: #e2e8f0; scroll-behavior: smooth; }
        .terminal-body::-webkit-scrollbar { width: 6px; }
        .terminal-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .log-line { margin-bottom: 6px; display: flex; align-items: flex-start; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; animation: fadeIn 0.2s ease-in;}
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-5px); } to { opacity: 1; transform: translateX(0); } }
        
        .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 4px 12px; border-radius: 999px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .status-danger { background: rgba(244, 63, 94, 0.1); color: #fca5a5; border: 1px solid rgba(244, 63, 94, 0.3); box-shadow: 0 0 15px rgba(244, 63, 94, 0.2); animation: pulse-danger 2s infinite; }
        @keyframes pulse-danger { 0%, 100% { box-shadow: 0 0 15px rgba(244, 63, 94, 0.2); } 50% { box-shadow: 0 0 25px rgba(244, 63, 94, 0.6); } }
        
        #crossroads-modal-wrapper { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #crossroads-modal-wrapper.active { opacity: 1; pointer-events: auto; }
        #crossroads-modal-inner { transform: scale(0.95); transition: transform 0.3s ease; }
        #crossroads-modal-wrapper.active #crossroads-modal-inner { transform: scale(1); }
    </style>
</head>
<body class="flex flex-col min-h-screen transition-colors duration-1000" id="main-body">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1400px] mx-auto w-full px-4 py-8 flex flex-col gap-6 relative">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-2">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight" id="main-title">
                    Metadata <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500 transition-all duration-1000" id="title-accent">Scrubber</span>
                </h1>
            </div>
        </div>

        <div id="upload-stage" class="glass-panel p-2 rounded-2xl transition-all duration-500">
            <div id="drop-zone" class="drop-zone">
                <div class="bg-blue-500/10 p-6 rounded-full mb-6 border border-blue-500/20" id="dz-icon-wrap">
                    <svg class="w-12 h-12 text-blue-500" id="dz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2 pointer-events-none tracking-tight">Select Image to Audit</h3>
                <input type="file" id="file-input" accept="image/*, .dng, .cr2, .nef, .arw, .webp, .png, .jpg, .jpeg">
            </div>
        </div>

        <div id="crossroads-modal-wrapper">
            <div id="crossroads-modal-inner" class="glass-panel p-8 rounded-2xl max-w-xl w-full border-rose-500/50 shadow-[0_0_50px_rgba(0,0,0,0.8)] mx-4">
                <h2 class="text-2xl font-bold text-white mb-2">RAW Sensor Data Detected</h2>
                <p class="text-sm text-slate-300 mb-6">Format: <span id="raw-ext-badge" class="font-bold text-rose-300"></span>. Choose processing path:</p>
                <div class="space-y-4">
                    <button id="btn-modal-standard" class="w-full text-left p-4 rounded-xl border border-slate-700 bg-slate-900/50 hover:bg-slate-800 transition-all">
                        <span class="font-bold text-blue-400 block mb-1">Standard Conversion (Fast)</span>
                        <span class="text-xs text-slate-400">Extracts preview and exports clean JPEG via Canvas API.</span>
                    </button>
                    <button id="btn-modal-wasm" class="w-full text-left p-4 rounded-xl border border-rose-700 bg-rose-900/30 hover:bg-rose-800/50 transition-all">
                        <span id="btn-wasm-text" class="font-bold text-rose-300 block mb-1">Advanced WASM Processing</span>
                        <span class="text-xs text-rose-200/80">Injects Exiv2 C++ WebAssembly to safely scrub and retain RAW extension.</span>
                    </button>
                    <button id="btn-modal-cancel" class="w-full text-center p-3 text-sm font-bold text-slate-400 hover:text-white">Cancel</button>
                </div>
            </div>
        </div>

        <div id="workspace-stage" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <div class="lg:col-span-5 flex flex-col gap-4">
                <div class="glass-panel p-4 flex flex-col gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div id="input-box" class="preview-box scanning"><div class="scanner-line"></div><img id="img-input" class="preview-img"></div>
                        </div>
                        <div>
                            <div class="preview-box border-emerald-700"><img id="img-output" class="preview-img hidden"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-slate-900/50 p-3 border border-slate-800"><span id="file-size" class="text-slate-300 font-mono">0 KB</span></div>
                        <div class="bg-slate-900/50 p-3 border border-slate-800 text-right"><span id="badge-engine" class="text-blue-300 font-mono">Determining...</span></div>
                    </div>
                    <button id="btn-reset-app" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-xl border border-slate-700">Abort & Load New Target</button>
                </div>
            </div>

            <div class="lg:col-span-7 flex flex-col gap-4">
                <div class="terminal" id="main-terminal">
                    <div class="terminal-header">
                        <span class="text-white font-bold text-xs uppercase tracking-widest">Forensic Audit Log</span>
                        <div id="export-options" class="hidden flex items-center gap-2">
                            <span class="text-[10px] text-slate-500 uppercase mr-1">Save As:</span>
                            <button id="btn-export-txt" class="text-[10px] bg-slate-800 text-slate-300 px-2 py-1 rounded">TXT</button>
                            <button id="btn-export-json" class="text-[10px] bg-slate-800 text-slate-300 px-2 py-1 rounded">JSON</button>
                            <button id="btn-export-csv" class="text-[10px] bg-slate-800 text-slate-300 px-2 py-1 rounded">CSV</button>
                        </div>
                    </div>
                    <div class="terminal-body" id="terminal-out"></div>
                </div>

                <div id="action-area" class="glass-panel p-4 flex justify-between gap-4">
                    <div id="action-msg-container" class="flex flex-col gap-1">
                        <span id="status-indicator" class="status-badge status-scan">Scanning</span>
                        <span id="action-msg" class="text-xs mt-1 block text-slate-400">Analyzing structure...</span>
                    </div>
                    <button id="btn-scrub" disabled class="hidden bg-blue-600 text-white font-bold px-8 rounded-xl opacity-50 cursor-not-allowed"><span id="btn-scrub-text">Remove Metadata</span></button>
                    <button id="btn-download" class="hidden bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-8 py-3 rounded-xl">Download Secure File</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { ProcessorFactory } from '../assets/js/exif_processors/Dispatcher.js?v=3.0';

        let originalFile = null;
        let scrubbedBlob = null;
        let sourceImageObj = new Image(); 
        let processorInstance = null;
        let fileExt = '';
        let outputExt = ''; 
        let isAdvancedMode = false;
        let rawExifCache = {}; 
        let currentScanId = 0;
        let activeUrls = []; 

        const STRUCTURAL_WHITELIST = ['ImageWidth', 'ImageHeight', 'ExifImageWidth', 'ExifImageHeight', 'Orientation', 'ColorSpace', 'Compression', 'XResolution', 'YResolution', 'ResolutionUnit', 'BitDepth', 'ColorType', 'Filter', 'Interlace', 'SamplesPerPixel'];

        // EVENTS
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => document.getElementById('drop-zone').addEventListener(e, preventDefaults));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        document.getElementById('drop-zone').addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        document.getElementById('file-input').addEventListener('change', e => handleFile(e.target.files[0]));
        
        document.getElementById('btn-modal-standard').addEventListener('click', () => executeCrossroads('standard'));
        document.getElementById('btn-modal-wasm').addEventListener('click', () => executeCrossroads('wasm'));
        document.getElementById('btn-modal-cancel').addEventListener('click', cancelCrossroads);
        document.getElementById('btn-reset-app').addEventListener('click', resetApp);
        document.getElementById('btn-scrub').addEventListener('click', executeImageProcessing);
        document.getElementById('btn-download').addEventListener('click', downloadImage);
        document.getElementById('btn-export-txt').addEventListener('click', () => exportReport('txt'));
        document.getElementById('btn-export-json').addEventListener('click', () => exportReport('json'));
        document.getElementById('btn-export-csv').addEventListener('click', () => exportReport('csv'));

        function logToTerminal(key, val, severity = 'low') {
            const t = document.getElementById('terminal-out');
            const l = document.createElement('div');
            l.className = 'log-line';
            l.innerHTML = severity === 'sys' ? `<span class="val-sys">${val}</span>` : `<span class="log-key">${key}</span><span class="log-val val-${severity}">${val}</span>`;
            t.appendChild(l);
            t.scrollTop = t.scrollHeight;
        }

        function handleFile(file) {
            if (!file) return;
            activeUrls.forEach(url => URL.revokeObjectURL(url));
            activeUrls = [];
            originalFile = file;
            fileExt = file.name.split('.').pop().toUpperCase();
            
            if (['CR2', 'DNG', 'NEF', 'ARW'].includes(fileExt)) {
                if (isAdvancedMode) {
                    processorInstance = ProcessorFactory.create(originalFile, fileExt, true);
                    startWorkspace(); return;
                }
                document.getElementById('raw-ext-badge').innerText = `.${fileExt}`;
                document.getElementById('crossroads-modal-wrapper').classList.add('active');
                return;
            }
            isAdvancedMode = false;
            processorInstance = ProcessorFactory.create(originalFile, fileExt, false);
            startWorkspace(); 
        }

        async function executeCrossroads(mode) {
            if (mode === 'wasm') {
                isAdvancedMode = true;
                const btn = document.getElementById('btn-wasm-text');
                btn.innerText = `Fetching WebAssembly...`;
                processorInstance = ProcessorFactory.create(originalFile, fileExt, true);
                
                try {
                    await processorInstance.initializeWasmEngine();
                    document.getElementById('crossroads-modal-wrapper').classList.remove('active');
                    document.body.classList.add('portal-transition'); 
                    document.getElementById('main-body').classList.add('forge-mode');
                    startWorkspace();
                    setTimeout(() => document.body.classList.remove('portal-transition'), 600);
                } catch(e) {
                    alert(e.message);
                    btn.innerText = `Advanced WASM Processing`;
                }
            } else {
                isAdvancedMode = false;
                processorInstance = ProcessorFactory.create(originalFile, fileExt, false);
                document.getElementById('crossroads-modal-wrapper').classList.remove('active');
                startWorkspace();
            }
        }

        function cancelCrossroads() {
            document.getElementById('crossroads-modal-wrapper').classList.remove('active');
            document.getElementById('file-input').value = '';
            originalFile = null;
        }

        function startWorkspace() {
            currentScanId++;
            let thisScanId = currentScanId;
            rawExifCache = {};
            document.getElementById('export-options').classList.add('hidden');
            document.getElementById('upload-stage').classList.add('hidden');
            document.getElementById('workspace-stage').classList.remove('hidden');
            document.getElementById('terminal-out').innerHTML = '';
            document.getElementById('input-box').classList.add('scanning');
            
            document.getElementById('badge-engine').innerText = processorInstance.engineName;
            document.getElementById('btn-scrub-text').innerText = processorInstance.buttonText;
            document.getElementById('btn-scrub').classList.add('opacity-50', 'cursor-not-allowed', 'hidden');

            logToTerminal('', '> INITIALIZING SECURE METADATA AUDIT...', 'sys');
            setTimeout(() => runHeavyProcessing(thisScanId), 50);
        }

        async function runHeavyProcessing(thisScanId) {
            try {
                let urlToLoad = await processorInstance.getPreviewUrl();
                if (urlToLoad) {
                    activeUrls.push(urlToLoad);
                    await new Promise(r => { sourceImageObj.onload = r; sourceImageObj.src = urlToLoad; });
                    document.getElementById('img-input').src = urlToLoad;
                }
            } catch(e) {}
            scanMetadata(thisScanId);
        }

        async function scanMetadata(thisScanId) {
            try {
                const exifData = await processorInstance.parse();
                if (thisScanId !== currentScanId) return; 

                if (exifData && Object.keys(exifData).length > 0) {
                    const usefulKeys = Object.keys(exifData).filter(k => !STRUCTURAL_WHITELIST.includes(k));
                    if (usefulKeys.length === 0) return handleCleanFile();
                    
                    let idx = 0;
                    function printNextLog() {
                        if (thisScanId !== currentScanId) return;
                        if (idx >= usefulKeys.length) {
                            document.getElementById('input-box').classList.remove('scanning');
                            logToTerminal('', `> SCAN COMPLETE.`, 'sys');
                            document.getElementById('btn-scrub').disabled = false;
                            document.getElementById('btn-scrub').classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
                            document.getElementById('export-options').classList.remove('hidden'); 
                            return;
                        }
                        let k = usefulKeys[idx];
                        rawExifCache[k] = exifData[k]; 
                        logToTerminal(k, exifData[k], 'low');
                        idx++;
                        setTimeout(printNextLog, 10);
                    }
                    setTimeout(printNextLog, 100);
                } else { handleCleanFile(); }
            } catch (error) { handleCleanFile(); }
        }

        function handleCleanFile() {
            document.getElementById('input-box').classList.remove('scanning');
            logToTerminal('', '> SCAN COMPLETE. NO PRIVACY DATA DETECTED.', 'sys');
            scrubbedBlob = originalFile; 
            document.getElementById('img-output').src = document.getElementById('img-input').src;
            document.getElementById('btn-download').classList.remove('hidden');
        }

        function executeImageProcessing() {
            document.getElementById('btn-scrub').disabled = true;
            document.getElementById('btn-scrub').classList.add('opacity-50', 'cursor-not-allowed');
            logToTerminal('', `> EXECUTING ${processorInstance.engineName.toUpperCase()}...`, 'sys');

            setTimeout(async () => {
                try {
                    const blob = await processorInstance.scrub(sourceImageObj);
                    outputExt = processorInstance.outputMime ? `.${processorInstance.outputMime.split('/')[1]}` : `.${fileExt.toLowerCase()}`;
                    if (outputExt === '.jpeg') outputExt = '.jpg';
                    
                    scrubbedBlob = blob;
                    document.getElementById('img-output').src = URL.createObjectURL(blob);
                    document.getElementById('img-output').classList.remove('hidden');
                    document.getElementById('btn-scrub').classList.add('hidden');
                    document.getElementById('export-options').classList.add('hidden'); 
                    document.getElementById('btn-download').classList.remove('hidden');
                    logToTerminal('VERIFICATION', 'PASSED. 0 PII THREATS DETECTED.', 'safe');
                } catch(e) {
                    logToTerminal('CRITICAL_ERROR', e.message, 'high');
                }
            }, 50);
        }

        function downloadImage() {
            if (!scrubbedBlob) return;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(scrubbedBlob);
            a.download = `${originalFile.name.split('.')[0]}_clean${outputExt}`;
            a.click();
        }

        function exportReport(format) {
            let content = ''; let mimeType = 'text/plain';
            if (format === 'txt') {
                content = `EXIF Report\n\n`;
                for (const [k, v] of Object.entries(rawExifCache)) content += `${k}: ${v}\n`;
            } else if (format === 'json') {
                content = JSON.stringify(rawExifCache, null, 2);
                mimeType = 'application/json';
            } else {
                content = "Key,Value\n";
                for (const [k, v] of Object.entries(rawExifCache)) content += `"${k}","${String(v).replace(/"/g, '""')}"\n`;
                mimeType = 'text/csv';
            }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([content], { type: mimeType }));
            a.download = `Report.${format}`;
            a.click();
        }

        function resetApp() {
            activeUrls.forEach(url => URL.revokeObjectURL(url));
            activeUrls = [];
            isAdvancedMode = false;
            document.getElementById('main-body').classList.remove('forge-mode');
            document.getElementById('workspace-stage').classList.add('hidden');
            document.getElementById('upload-stage').classList.remove('hidden');
            document.getElementById('export-options').classList.add('hidden');
            document.getElementById('file-input').value = '';
            originalFile = null; scrubbedBlob = null; processorInstance = null;
            rawExifCache = {}; currentScanId++; sourceImageObj = new Image();
            document.getElementById('terminal-out').innerHTML = '';
            document.getElementById('btn-scrub').classList.add('hidden');
            document.getElementById('btn-download').classList.add('hidden');
        }
    </script>
</body>
</html>
