<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metadata Scrubber | Cyber-Forensics</title>
    <meta name="description" content="Local-first forensic tool to annihilate hidden EXIF data and GPS coordinates.">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5449371042798610" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>

    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg-base: #050505;
            --panel-bg: rgba(10, 10, 12, 0.85);
            --border-dim: #1f2937;
            --neon-cyan: #00f3ff;
            --neon-pink: #ff007f;
            --neon-green: #00ff41;
            --neon-yellow: #fcee0a;
            --neon-red: #ff003c;
            --text-main: #e2e8f0;
        }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            background-color: var(--bg-base); 
            color: var(--text-main); 
            overflow-x: hidden; 
            transition: background-color 0.4s ease; 
            /* Cyber Grid Background */
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.04) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        .mono { font-family: 'Fira Code', monospace; }

        /* ADVANCED FORGE THEME (Netrunner Shift) */
        body.advanced-mode {
            background-image: 
                linear-gradient(rgba(255, 0, 127, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 0, 127, 0.05) 1px, transparent 1px);
        }
        .advanced-mode .cyber-panel::before { border-top-color: var(--neon-pink); border-left-color: var(--neon-pink); }
        .advanced-mode .cyber-panel::after { border-bottom-color: var(--neon-pink); border-right-color: var(--neon-pink); }
        .advanced-mode .status-scan { background: rgba(255, 0, 127, 0.1) !important; color: var(--neon-pink) !important; border-color: var(--neon-pink) !important; box-shadow: 0 0 10px rgba(255, 0, 127, 0.2); }
        .advanced-mode .scanner-line { background: var(--neon-pink) !important; box-shadow: 0 0 15px var(--neon-pink), 0 0 30px var(--neon-pink) !important; }

        /* CYBERPUNK PANELS (Sharp Edges, Tech Accents) */
        .cyber-panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-dim);
            backdrop-filter: blur(10px);
            position: relative;
            border-radius: 2px;
        }
        .cyber-panel::before, .cyber-panel::after {
            content: ''; position: absolute; width: 15px; height: 15px; border: 2px solid transparent; transition: all 0.4s;
        }
        .cyber-panel::before { top: -1px; left: -1px; border-top-color: var(--neon-cyan); border-left-color: var(--neon-cyan); }
        .cyber-panel::after { bottom: -1px; right: -1px; border-bottom-color: var(--neon-cyan); border-right-color: var(--neon-cyan); }

        /* CYBER BUTTONS */
        .cyber-btn {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
            transition: all 0.2s;
            clip-path: polygon(10px 0, 10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 100%, 0 10px);
        }
        .cyber-btn:hover:not(:disabled) {
            background: var(--neon-cyan);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.4);
        }
        .cyber-btn:disabled { border-color: #333; color: #555; cursor: not-allowed; }
        
        .cyber-btn-danger { border-color: var(--neon-pink); color: var(--neon-pink); }
        .cyber-btn-danger:hover:not(:disabled) { background: var(--neon-pink); color: #000; box-shadow: 0 0 20px rgba(255, 0, 127, 0.4); }

        .cyber-btn-success { border-color: var(--neon-green); color: var(--neon-green); }
        .cyber-btn-success:hover:not(:disabled) { background: var(--neon-green); color: #000; box-shadow: 0 0 20px rgba(57, 255, 20, 0.4); }

        /* DATA UPLINK ZONE */
        .drop-zone {
            border: 1px dashed var(--border-dim);
            background: rgba(0,0,0,0.6);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 350px; transition: all 0.3s ease; cursor: pointer; position: relative;
        }
        .drop-zone:hover, .drop-zone.dragover { border: 1px solid var(--neon-cyan); background: rgba(0, 243, 255, 0.05); box-shadow: inset 0 0 30px rgba(0, 243, 255, 0.1); }
        .advanced-mode .drop-zone:hover { border: 1px solid var(--neon-pink); background: rgba(255, 0, 127, 0.05); box-shadow: inset 0 0 30px rgba(255, 0, 127, 0.1); }
        .drop-zone input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        /* PREVIEWS */
        .preview-box { border: 1px solid var(--border-dim); background: #000; overflow: hidden; position: relative; height: 250px; display: flex; align-items: center; justify-content: center; }
        .preview-img { max-width: 100%; max-height: 100%; object-fit: contain; opacity: 0.3; transition: opacity 0.5s; filter: grayscale(50%); }
        .preview-img.scanned { opacity: 1; filter: grayscale(0%); }
        .preview-label { position: absolute; top: 0; left: 0; background: var(--neon-cyan); color: #000; padding: 2px 8px; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; z-index: 10; }
        .advanced-mode .preview-label { background: var(--neon-pink); }
        
        .filename-text { display: block; font-size: 11px; color: #94a3b8; margin-top: 8px; text-align: center; }

        .scanner-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan); animation: scan 2s linear infinite; z-index: 20; display: none; }
        .scanning .scanner-line { display: block; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* HACKER TERMINAL */
        .terminal { background: #000; border: 1px solid var(--border-dim); font-size: 12px; height: 300px; display: flex; flex-direction: column; position: relative; }
        .terminal::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; z-index: 5; pointer-events: none; }
        .terminal-header { background: #0a0a0c; border-bottom: 1px solid var(--border-dim); padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .terminal-body { padding: 16px; overflow-y: auto; flex: 1; color: var(--neon-cyan); z-index: 10; }
        
        .log-line { margin-bottom: 4px; display: flex; align-items: flex-start; gap: 10px; border-bottom: 1px dashed rgba(255,255,255,0.05); padding-bottom: 4px; }
        .log-key { color: #fff; font-weight: bold; width: 40%; flex-shrink: 0; word-break: break-all; }
        .log-val { word-break: break-all; }
        
        .val-high { color: var(--neon-red); text-shadow: 0 0 5px rgba(255,0,60,0.5); }
        .val-med { color: var(--neon-yellow); }
        .val-low { color: var(--neon-cyan); }
        .advanced-mode .val-low { color: var(--neon-pink); }
        .val-sys { color: #fff; width: 100%; }
        .val-safe { color: var(--neon-green); font-weight: bold; text-shadow: 0 0 5px rgba(0,255,65,0.5); }

        /* Badges & Map UI */
        #location-map-container { transition: max-height 0.8s ease, opacity 0.5s ease; overflow: hidden; max-height: 0; opacity: 0; border: 1px solid var(--border-dim); }
        #location-map-container.active { max-height: 250px; opacity: 1; border-color: var(--neon-red); margin-top: 1rem; box-shadow: 0 0 15px rgba(255,0,60,0.2); }
        #leaflet-map { height: 200px; width: 100%; z-index: 1; filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(120%); } /* Cyberpunk map inversion */

        .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 4px 12px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; border: 1px solid; }
        .status-warn { background: rgba(252, 238, 10, 0.1); color: var(--neon-yellow); border-color: var(--neon-yellow); }
        .status-danger { background: rgba(255, 0, 60, 0.1); color: var(--neon-red); border-color: var(--neon-red); box-shadow: 0 0 10px rgba(255,0,60,0.3); animation: pulse-danger 2s infinite; }
        @keyframes pulse-danger { 0%, 100% { box-shadow: 0 0 10px rgba(255,0,60,0.3); } 50% { box-shadow: 0 0 20px rgba(255,0,60,0.6); } }
        .status-safe { background: rgba(0, 255, 65, 0.1); color: var(--neon-green); border-color: var(--neon-green); }
        .status-scan { background: rgba(0, 243, 255, 0.1); color: var(--neon-cyan); border-color: var(--neon-cyan); }
        
        /* ARCHITECT FIX: Modal properly hidden, overrides CSS precedence */
        #crossroads-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        #crossroads-modal.active { display: flex; }
        
        #meta-count { background: #000; color: var(--neon-cyan); padding: 2px 8px; font-weight: bold; font-size: 12px; border: 1px solid var(--neon-cyan);}
        .advanced-mode #meta-count { color: var(--neon-pink); border-color: var(--neon-pink); }
    </style>
</head>
<body class="flex flex-col min-h-screen transition-colors duration-1000" id="main-body">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1400px] mx-auto w-full px-4 py-8 flex flex-col gap-6 relative">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-2">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold text-white tracking-wider uppercase" id="main-title">
                    DATA <span class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 transition-all duration-1000" id="title-accent">SPLICER</span>
                </h1>
                <p class="text-sm text-slate-400 mt-1 uppercase tracking-widest mono">Protocol: Secure Metadata Annihilation</p>
            </div>
        </div>

        <div id="upload-stage" class="cyber-panel p-2">
            <div id="drop-zone" class="drop-zone">
                <div class="mb-4" id="dz-icon-wrap">
                    <svg class="w-16 h-16 text-cyan-400 drop-shadow-[0_0_10px_rgba(0,243,255,0.8)]" id="dz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="1" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="1" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2 pointer-events-none tracking-widest uppercase">Establish Uplink</h3>
                <div class="px-8 py-2 cyber-btn pointer-events-none mt-4 text-xs">Browse Local Files</div>
                <input type="file" id="file-input" accept="image/*, .dng, .cr2, .nef, .arw, .webp, .png, .jpg, .jpeg">
            </div>
        </div>

        <div id="crossroads-modal">
            <div class="cyber-panel p-8 max-w-xl w-full border-pink-500 shadow-[0_0_50px_rgba(255,0,127,0.3)]">
                <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-3 uppercase tracking-widest">
                    <span class="w-3 h-3 bg-pink-500 rounded-full animate-pulse"></span>
                    Encrypted Payload Detected
                </h2>
                <p class="text-sm text-slate-300 mb-8 mono">
                    FORMAT: [<span id="raw-ext-badge" class="font-bold text-pink-400"></span>]. Native browser APIs cannot execute standard protocols on proprietary sensor data. Select decryption path:
                </p>
                
                <div class="space-y-4">
                    <button onclick="executeCrossroads('standard')" class="w-full text-left p-4 cyber-btn group">
                        <span class="block mb-1 text-cyan-400 group-hover:text-black">Standard Conversion</span>
                        <span class="text-xs text-slate-400 group-hover:text-black mono">Extract preview -> Export secure JPEG</span>
                    </button>
                    
                    <button onclick="executeCrossroads('forge')" class="w-full text-left p-4 cyber-btn cyber-btn-danger group">
                        <span class="block mb-1 group-hover:text-black">Advanced Binary Wipe</span>
                        <span class="text-xs text-pink-200/70 group-hover:text-black mono">Orphan IFD pointers -> Retain exact extension</span>
                    </button>

                    <button onclick="cancelCrossroads()" class="w-full text-center p-3 mt-4 text-xs text-slate-500 hover:text-white uppercase tracking-widest transition-all">Abort Sequence</button>
                </div>
            </div>
        </div>

        <div id="workspace-stage" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <div class="lg:col-span-5 flex flex-col gap-4">
                <div class="cyber-panel p-4 flex flex-col gap-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div id="input-box" class="preview-box scanning"><img id="img-input" class="preview-img" alt="Input Preview"></div>
                            <span id="label-filename-input" class="filename-text mono text-cyan-400">...</span>
                        </div>
                        <div>
                            <div class="preview-box border-green-500/30">
                                <div id="output-placeholder" class="text-xs text-slate-500 font-mono text-center flex flex-col items-center gap-2 uppercase tracking-widest">Awaiting Purge</div>
                                <img id="img-output" class="preview-img hidden" alt="Output Preview">
                            </div>
                            <span id="label-filename-output" class="filename-text mono text-green-400 opacity-0">...</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-black p-3 border border-slate-800"><span class="block text-[10px] text-slate-500 uppercase tracking-widest mb-1">Payload Size</span><span id="file-size" class="text-white font-mono">0 KB</span></div>
                        <div class="bg-black p-3 border border-slate-800 text-right"><span class="block text-[10px] text-slate-500 uppercase tracking-widest mb-1">Protocol</span><span id="badge-engine" class="text-white font-mono">...</span></div>
                    </div>
                    <button onclick="resetApp(true)" class="w-full cyber-btn py-3 text-xs">Terminate & Load New</button>
                </div>
            </div>

            <div class="lg:col-span-7 flex flex-col gap-4">
                <div class="terminal" id="main-terminal">
                    <div class="terminal-header">
                        <span class="text-white font-bold text-xs uppercase tracking-widest mono">> SYSTEM_LOG</span>
                        <span id="meta-count" class="mono">0 TAGS</span>
                    </div>
                    <div class="terminal-body mono" id="terminal-out"></div>
                </div>

                <div id="location-map-container"><div id="leaflet-map"></div></div>

                <div id="action-area" class="cyber-panel p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div id="action-msg-container" class="flex flex-col gap-1">
                        <span id="status-indicator" class="status-badge status-scan w-max mono">Scanning</span>
                        <span id="action-msg" class="text-xs mt-1 block text-slate-400 mono">Parsing binary structure...</span>
                    </div>
                    <button id="btn-scrub" onclick="executeImageProcessing()" disabled class="hidden cyber-btn py-3 px-8 text-sm"><span id="btn-scrub-text">Execute Purge</span></button>
                    <button id="btn-download" onclick="downloadImage()" class="hidden cyber-btn cyber-btn-success py-3 px-8 text-sm">Download Secure File</button>
                </div>
            </div>
        </div>
        
        <canvas id="scrub-canvas" class="hidden"></canvas>
    </main>

    <sv-footer base-path=".."></sv-footer>

    <script type="module">
        'use strict'; 
        // ARCHITECT FIX: Connect to the isolated external Processor Factory
        import { ProcessorFactory } from '../assets/js/exif_processors/Dispatcher.js';

        // 1. STATE
        let originalFile = null;
        let scrubbedBlob = null;
        let sourceImageObj = new Image(); 
        let processorInstance = null;
        let fileExt = '';
        let outputExt = ''; 
        let isAdvancedMode = false;
        let rawExifCache = {}; 
        let currentScanId = 0;
        let threatMap = null;
        let mapMarker = null;
        let activeUrls = []; 

        // 2. DOM CACHE
        const mainBody = document.getElementById('main-body');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const stageUpload = document.getElementById('upload-stage');
        const stageWorkspace = document.getElementById('workspace-stage');
        const crossroadsModal = document.getElementById('crossroads-modal');
        const inputBox = document.getElementById('input-box');
        const imgInput = document.getElementById('img-input');
        const imgOutput = document.getElementById('img-output');
        const outputPlaceholder = document.getElementById('output-placeholder');
        const labelFilenameInput = document.getElementById('label-filename-input');
        const labelFilenameOutput = document.getElementById('label-filename-output');
        const fileSizeEl = document.getElementById('file-size');
        const badgeEngine = document.getElementById('badge-engine');
        const terminalOut = document.getElementById('terminal-out');
        const metaCount = document.getElementById('meta-count');
        const statusIndicator = document.getElementById('status-indicator');
        const actionMsg = document.getElementById('action-msg');
        const threatMapContainer = document.getElementById('location-map-container');
        const btnScrub = document.getElementById('btn-scrub');
        const btnScrubText = document.getElementById('btn-scrub-text');
        const btnDownload = document.getElementById('btn-download');
        const titleAccent = document.getElementById('title-accent');
        const dzIconWrap = document.getElementById('dz-icon-wrap');
        const dzIcon = document.getElementById('dz-icon');

        // PREVENTS STRUCTURAL TAGS FROM TRIGGERING FALSE ALARMS
        const STRUCTURAL_WHITELIST = ['ImageWidth', 'ImageHeight', 'ExifImageWidth', 'ExifImageHeight', 'Orientation', 'ColorSpace'];

        // 3. LISTENERS
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, preventDefaults));
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        ['dragenter', 'dragover'].forEach(e => dropZone.classList.add('dragover'));
        ['dragleave', 'drop'].forEach(e => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
        window.addEventListener("beforeunload", () => { activeUrls.forEach(url => URL.revokeObjectURL(url)); localStorage.clear(); });

        // 4. LOGIC
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024, i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + ['Bytes', 'KB', 'MB'][i];
        }

        function isPrivacyThreat(key, val) {
            if (STRUCTURAL_WHITELIST.includes(key)) return false; 
            if (typeof val === 'object' && val !== null && !(val instanceof Date)) return false; 
            return true;
        }

        function getSeverity(key) {
            const k = key.toLowerCase();
            if (['latitude', 'longitude', 'gps', 'serial'].some(h => k.includes(h))) return 'high';
            return 'low';
        }

        function logToTerminal(key, val, severity = 'low') {
            const line = document.createElement('div');
            line.className = 'log-line';
            const safeVal = (typeof val === 'string') ? val.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : val;
            if (severity === 'sys') line.innerHTML = `<span class="val-sys">${safeVal}</span>`;
            else line.innerHTML = `<span class="log-key">${key}</span><span class="log-val val-${severity}">${safeVal}</span>`;
            terminalOut.appendChild(line);
            terminalOut.scrollTop = terminalOut.scrollHeight;
        }

        function handleFile(file) {
            if (!file) return;
            activeUrls.forEach(url => URL.revokeObjectURL(url));
            activeUrls = [];
            sourceImageObj = new Image(); 

            originalFile = file;
            fileExt = file.name.split('.').pop().toUpperCase();
            labelFilenameInput.innerText = file.name;
            
            processorInstance = ProcessorFactory.create(originalFile, fileExt);

            // Keeps workflow uninterrupted if already in Advanced Mode
            if (['CR2', 'DNG', 'NEF', 'ARW'].includes(fileExt) && !isAdvancedMode) {
                document.getElementById('raw-ext-badge').innerText = `.${fileExt}`;
                crossroadsModal.classList.add('active'); // CSS display fix
                return;
            }
            startWorkspace(); 
        }

        function executeCrossroads(mode) {
            if (mode === 'forge') {
                isAdvancedMode = true;
                mainBody.classList.add('advanced-mode');
                titleAccent.className = "text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 transition-all duration-1000";
                titleAccent.innerText = "Forge";
                dzIconWrap.className = "mb-4";
                dzIcon.className = "w-16 h-16 text-pink-500 drop-shadow-[0_0_10px_rgba(255,0,127,0.8)]";
                
                crossroadsModal.classList.remove('active');
                startWorkspace();
            } else {
                isAdvancedMode = false;
                // Force Canvas Processor for standard fallback via Factory dynamic import mapping
                import('../assets/js/exif_processors/CanvasProcessor.js').then(module => {
                     processorInstance = new module.CanvasProcessor(originalFile, fileExt, 'image/jpeg');
                     crossroadsModal.classList.remove('active');
                     startWorkspace();
                });
            }
        }

        function cancelCrossroads() {
            crossroadsModal.classList.remove('active');
            fileInput.value = '';
        }

        function startWorkspace() {
            currentScanId++;
            let thisScanId = currentScanId;

            rawExifCache = {};
            threatMapContainer.classList.remove('active'); 
            
            fileSizeEl.innerText = formatBytes(originalFile.size);
            stageUpload.classList.add('hidden');
            stageWorkspace.classList.remove('hidden');
            
            terminalOut.innerHTML = '';
            inputBox.classList.add('scanning');
            imgInput.classList.remove('scanned');
            
            btnScrub.disabled = true;
            btnScrub.classList.add('opacity-50', 'cursor-not-allowed', 'hidden');
            btnDownload.classList.add('hidden');

            badgeEngine.innerText = processorInstance.engineName || 'Binary Splicer';
            
            if(isAdvancedMode) {
                badgeEngine.className = 'text-pink-400 font-mono';
                btnScrub.className = "hidden w-full md:w-auto cyber-btn cyber-btn-danger py-3 px-8 text-sm opacity-50 cursor-not-allowed";
            } else {
                badgeEngine.className = 'text-cyan-400 font-mono';
                btnScrub.className = "hidden w-full md:w-auto cyber-btn py-3 px-8 text-sm opacity-50 cursor-not-allowed";
            }
            btnScrubText.innerText = processorInstance.buttonText || 'Execute Protocol';

            logToTerminal('', '> INITIALIZING SECURE METADATA AUDIT...', 'sys');

            requestAnimationFrame(() => setTimeout(() => runHeavyProcessing(thisScanId), 50));
        }

        async function runHeavyProcessing(thisScanId) {
            try {
                let urlToLoad = await processorInstance.getPreviewUrl();
                if (urlToLoad) {
                    if(urlToLoad.startsWith('blob:')) activeUrls.push(urlToLoad);
                    await new Promise((resolve, reject) => {
                        sourceImageObj.onload = () => resolve();
                        sourceImageObj.onerror = () => reject();
                        sourceImageObj.src = urlToLoad;
                    });
                    imgInput.src = urlToLoad;
                }
            } catch(e) { 
                logToTerminal('WARNING', 'Visual preview extraction failed. Matrix processing continues.', 'med');
            }
            scanMetadata(thisScanId);
        }

        async function scanMetadata(thisScanId) {
            try {
                const exifData = await processorInstance.parse();
                if (thisScanId !== currentScanId) return; 

                if (exifData && Object.keys(exifData).length > 0) {
                    const usefulKeys = Object.keys(exifData).filter(key => isPrivacyThreat(key, exifData[key]));
                    if (usefulKeys.length === 0) return handleCleanFile();
                    
                    metaCount.innerText = `${usefulKeys.length} TAGS`;
                    
                    let idx = 0;
                    function printNextLog() {
                        if (thisScanId !== currentScanId) return;
                        if (idx >= usefulKeys.length) {
                            inputBox.classList.remove('scanning');
                            imgInput.classList.add('scanned');
                            logToTerminal('', `> SCAN COMPLETE. [${usefulKeys.length}] THREATS FOUND.`, 'sys');

                            if (exifData.latitude && exifData.longitude) {
                                triggerMap(exifData.latitude, exifData.longitude);
                                statusIndicator.className = "status-badge status-danger mono";
                                statusIndicator.innerHTML = `CRITICAL THREAT`;
                                actionMsg.innerHTML = `<span class="text-rose-400 font-bold">Location Exposed:</span> Immediate purge required.`;
                            } else {
                                statusIndicator.className = "status-badge status-warn mono";
                                statusIndicator.innerHTML = `METADATA DETECTED`;
                                actionMsg.innerHTML = `<span class="text-amber-400 font-bold">Action Required:</span> Hidden trackers found.`;
                            }

                            btnScrub.disabled = false;
                            btnScrub.classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
                            return;
                        }

                        let key = usefulKeys[idx];
                        let val = exifData[key];
                        rawExifCache[key] = val; 
                        logToTerminal(key, val, getSeverity(key));
                        idx++;
                        setTimeout(printNextLog, isAdvancedMode ? 5 : 15);
                    }
                    setTimeout(printNextLog, 100);
                } else {
                    handleCleanFile();
                }
            } catch (error) {
                handleCleanFile();
            }
        }

        function triggerMap(lat, lng) {
            threatMapContainer.classList.add('active'); 
            const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            if (!threatMap) {
                threatMap = L.map('leaflet-map').setView([lat, lng], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(threatMap); // Cyberpunk Dark Map
                mapMarker = L.marker([lat, lng], {icon: redIcon}).addTo(threatMap);
            } else {
                threatMap.setView([lat, lng], 14);
                mapMarker.setLatLng([lat, lng]);
            }
            setTimeout(() => { threatMap.invalidateSize(); }, 300);
        }

        function handleCleanFile() {
            setTimeout(() => {
                inputBox.classList.remove('scanning');
                imgInput.classList.add('scanned');
                metaCount.innerText = `0 TAGS`;
                logToTerminal('', '> SCAN COMPLETE. 0 PRIVACY THREATS DETECTED.', 'sys');
                
                statusIndicator.className = "status-badge status-safe mono";
                statusIndicator.innerHTML = `SECURE`;
                actionMsg.innerHTML = `<span class="text-emerald-400 font-bold">Verified:</span> Matrix is natively safe. Force Purge available.`;

                scrubbedBlob = originalFile; 
                outputExt = `.${fileExt.toLowerCase()}`;
                imgOutput.src = imgInput.src;
                outputPlaceholder.classList.add('hidden');
                imgOutput.classList.remove('hidden');
                labelFilenameOutput.innerText = originalFile.name;
                labelFilenameOutput.classList.remove('opacity-0');
                
                btnScrubText.innerText = "Force Purge";
                btnScrub.disabled = false;
                btnScrub.classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
                btnDownload.classList.remove('hidden');
            }, 1000);
        }

        function executeImageProcessing() {
            btnScrub.disabled = true;
            btnScrub.classList.add('opacity-50', 'cursor-not-allowed');
            logToTerminal('', `> EXECUTING ${processorInstance.engineName.toUpperCase()}...`, 'sys');

            setTimeout(async () => {
                try {
                    if(processorInstance.setCache) processorInstance.setCache(rawExifCache);
                    
                    // Critical Fix: Pass sourceImageObj down to the Canvas processor
                    const blob = await processorInstance.scrub(sourceImageObj);
                    
                    outputExt = processorInstance.outputMime ? `.${processorInstance.outputMime.split('/')[1]}` : `.${fileExt.toLowerCase()}`;
                    if (outputExt === '.jpeg') outputExt = '.jpg';
                    
                    verifyAndFinalize(blob);
                } catch(e) {
                    logToTerminal('CRITICAL_ERROR', 'Protocol execution failed.', 'high');
                    btnScrubText.innerText = "Failed";
                }
            }, 50);
        }

        async function verifyAndFinalize(blob) {
            logToTerminal('', '> RUNNING POST-PURGE VERIFICATION PROTOCOL...', 'sys');
            try {
                const fileBuffer = await blob.arrayBuffer();
                const checkData = await window.exifr.parse(fileBuffer, {tiff: true, ifd0: true, exif: true, gps: true});
                if (checkData) {
                    const surviving = Object.keys(checkData).filter(k => isPrivacyThreat(k, checkData[k]));
                    if (surviving.length > 0) {
                        logToTerminal('VERIFICATION_FAILED', `${surviving.length} threats survived. Matrix compromised.`, 'high');
                        btnScrubText.innerText = "Verification Failed";
                        return;
                    }
                }
            } catch(e) {}

            logToTerminal('VERIFICATION', 'PASSED. 0 PII THREATS DETECTED.', 'safe');
            scrubbedBlob = blob;
            threatMapContainer.classList.remove('active'); 
            
            statusIndicator.className = "status-badge status-safe mono";
            statusIndicator.innerHTML = `NEUTRALIZED`;
            actionMsg.innerHTML = `<span class="text-emerald-400 font-bold">Success:</span> Metadata totally annihilated.`;
            
            fileSizeEl.innerText = formatBytes(blob.size);
            const outputUrl = URL.createObjectURL(blob);
            activeUrls.push(outputUrl);
            
            if(processorInstance.outputMime) imgOutput.src = outputUrl;
            else imgOutput.src = imgInput.src;
            
            outputPlaceholder.classList.add('hidden');
            imgOutput.classList.remove('hidden');
            btnScrub.classList.add('hidden');
            btnDownload.classList.remove('hidden');

            const nameBase = originalFile.name.substring(0, originalFile.name.lastIndexOf('.'));
            labelFilenameOutput.innerText = `${nameBase}_clean${outputExt}`;
            labelFilenameOutput.classList.remove('opacity-0');
        }

        function downloadImage() {
            if (!scrubbedBlob) return;
            const nameBase = originalFile.name.substring(0, originalFile.name.lastIndexOf('.'));
            const url = URL.createObjectURL(scrubbedBlob);
            activeUrls.push(url);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${nameBase}_clean${outputExt}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Pass false to clear mode, true to keep mode for batching
        function resetApp(retainMode = false) {
            activeUrls.forEach(url => URL.revokeObjectURL(url));
            activeUrls = [];
            
            if (threatMap) { threatMap.remove(); threatMap = null; }
            threatMapContainer.classList.remove('active');
            stageWorkspace.classList.add('hidden');
            stageUpload.classList.remove('hidden');

            if (!retainMode) {
                isAdvancedMode = false;
                mainBody.classList.remove('advanced-mode');
                titleAccent.className = "text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 transition-all duration-1000";
                titleAccent.innerText = "SPLICER";
                dzIconWrap.className = "mb-4";
                dzIcon.className = "w-16 h-16 text-cyan-400 drop-shadow-[0_0_10px_rgba(0,243,255,0.8)]";
            }
            
            fileInput.value = ''; originalFile = null; scrubbedBlob = null;
            sourceImageObj = new Image(); rawExifCache = {}; currentScanId++; 
            terminalOut.innerHTML = '';
            
            imgInput.src = ''; imgOutput.src = '';
            inputBox.classList.add('scanning'); imgInput.classList.remove('scanned');
            outputPlaceholder.classList.remove('hidden'); imgOutput.classList.add('hidden');
            labelFilenameInput.innerText = '...'; labelFilenameOutput.classList.add('opacity-0');

            btnScrub.disabled = true;
            btnScrub.classList.add('opacity-50', 'cursor-not-allowed', 'hidden');
            btnDownload.classList.add('hidden');
        }

        window.handleFile = handleFile;
        window.executeCrossroads = executeCrossroads;
        window.cancelCrossroads = cancelCrossroads;
        window.executeImageProcessing = executeImageProcessing;
        window.downloadImage = downloadImage;
        window.resetApp = resetApp;
    </script>
</body>
</html>
