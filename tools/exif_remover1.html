<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>EXIF Remover & Image Metadata Scrubber | SilenVault</title>
    <meta name="description" content="Free, local-first forensic tool to permanently remove hidden EXIF data, GPS coordinates, and XMP trackers from images. Lossless support for JPEG, PNG, WebP, and RAW (CR2, DNG) formats.">
    <meta name="keywords" content="exif remover, metadata scrubber, remove gps from photo, clear cr2 metadata, raw image metadata cleaner, local exif tool, privacy image editor">
    <meta name="author" content="SilenVault">
    <link rel="canonical" href="https://silenvault.com/tools/exif_remover.html">
    
    <meta property="og:title" content="EXIF Remover & Metadata Scrubber | SilenVault">
    <meta property="og:description" content="Securely purge hidden tracking data from your images completely offline. Enterprise-grade RAW sensor support via WebAssembly.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://silenvault.com/tools/exif_remover.html">
    <meta property="og:site_name" content="SilenVault">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5449371042798610" crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="../assets/js/layout.js" defer></script>
    
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/utif@3.1.0/UTIF.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* BRIGHTER, MORE READABLE BASE THEME */
        :root {
            --bg-color: #0f172a; 
            --panel-bg: rgba(30, 41, 59, 0.85); 
            --border-color: #334155;
            --accent-glow: rgba(59, 130, 246, 0.25);
            --primary-text: #f8fafc;
            --secondary-text: #cbd5e1;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); overflow-x: hidden; transition: background-color 0.8s ease; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(16px); border: 1px solid var(--border-color); transition: all 0.5s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .mono { font-family: 'Fira Code', monospace; }

        /* BRIGHTER FORGE THEME (Deep Crimson) */
        body.forge-mode {
            --bg-color: #22050f; 
            --panel-bg: rgba(60, 10, 24, 0.85);
            --border-color: #9f1239; 
            --accent-glow: rgba(244, 63, 94, 0.25);
            background-image: linear-gradient(rgba(244, 63, 94, 0.07) 1px, transparent 1px), linear-gradient(90deg, rgba(244, 63, 94, 0.07) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .forge-mode .status-scan { background: rgba(244, 63, 94, 0.15) !important; color: #fda4af !important; border-color: rgba(244, 63, 94, 0.5) !important; }
        .forge-mode .scanner-line { background: #f43f5e !important; box-shadow: 0 0 15px #f43f5e, 0 0 30px #f43f5e !important; }

        /* BLUR EFFECT FOR MAIN CONTENT WHEN MODAL IS OPEN */
        #main-content-wrapper { transition: filter 0.5s ease, transform 0.5s ease; }
        body.modal-active #main-content-wrapper { filter: blur(8px) brightness(0.7); transform: scale(0.99); }

        /* DROP ZONE */
        .drop-zone { border: 2px dashed var(--border-color); border-radius: 1rem; background: rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 350px; transition: all 0.4s ease; cursor: pointer; position: relative; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #60a5fa; background: var(--accent-glow); }
        .forge-mode .drop-zone:hover { border-color: #fb7185; }
        .drop-zone input[type="file"] { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }

        /* PREVIEWS */
        .preview-box { border: 2px solid var(--border-color); border-radius: 8px; background: rgba(0,0,0,0.4); overflow: hidden; position: relative; height: 250px; display: flex; align-items: center; justify-content: center; }
        .preview-img { max-width: 100%; max-height: 100%; object-fit: contain; opacity: 0.7; transition: opacity 0.5s ease; }
        .preview-img.scanned { opacity: 1; }
        .preview-label { position: absolute; top: 8px; left: 8px; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #f8fafc; z-index: 10; }
        .filename-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; display: block; font-size: 12px; color: var(--secondary-text); margin-top: 8px; text-align: center; font-weight: 500;}

        .scanner-line { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: #60a5fa; box-shadow: 0 0 15px #60a5fa; animation: scan 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; z-index: 20; display: none; }
        .scanning .scanner-line { display: block; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* BUTTERY TERMINAL LOGS */
        .terminal { background: rgba(2, 6, 23, 0.9); border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Fira Code', monospace; font-size: 13px; height: 300px; display: flex; flex-direction: column; transition: all 0.5s ease; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); }
        .terminal-header { background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border-color); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .terminal-body { padding: 16px; overflow-y: auto; flex: 1; color: #e2e8f0; scroll-behavior: smooth; }
        .terminal-body::-webkit-scrollbar { width: 6px; }
        .terminal-body::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        
        /* Smooth typing entry animation */
        .log-line { margin-bottom: 6px; display: flex; align-items: flex-start; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; opacity: 0; transform: translateX(-10px); animation: butteryFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes butteryFadeIn { to { opacity: 1; transform: translateX(0); } }
        
        .log-key { color: #f8fafc; font-weight: bold; width: 40%; flex-shrink: 0; word-break: break-all; }
        .log-val { word-break: break-all; }
        .val-high { color: #fda4af; font-weight: bold; text-shadow: 0 0 10px rgba(244,63,94,0.4); }
        .val-med { color: #fde047; }
        .val-low { color: #cbd5e1; }
        .val-sys { color: #93c5fd; width: 100%; font-weight: bold;}
        .forge-mode .val-sys { color: #fca5a5; }
        .val-safe { color: #86efac; font-weight: bold; text-shadow: 0 0 10px rgba(16,185,129,0.3);}

        /* MAP FIX: Sleek Cryptographic Slate Filter */
        #location-map-container { transition: max-height 0.8s ease, opacity 0.5s ease; overflow: hidden; max-height: 0; opacity: 0; border-radius: 8px; }
        #location-map-container.active { max-height: 250px; opacity: 1; border: 1px solid rgba(244,63,94,0.4); margin-top: 1rem; }
        #leaflet-map { 
            height: 200px; width: 100%; z-index: 1; 
            filter: grayscale(30%) invert(90%) hue-rotate(200deg) brightness(95%) contrast(110%);
        }

        .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 999px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .status-warn { background: rgba(251, 191, 36, 0.15); color: #fde047; border: 1px solid rgba(251, 191, 36, 0.4); }
        .status-danger { background: rgba(244, 63, 94, 0.15); color: #fda4af; border: 1px solid rgba(244, 63, 94, 0.5); box-shadow: 0 0 15px rgba(244, 63, 94, 0.3); animation: pulse-danger 2s infinite; }
        @keyframes pulse-danger { 0%, 100% { box-shadow: 0 0 15px rgba(244, 63, 94, 0.3); } 50% { box-shadow: 0 0 25px rgba(244, 63, 94, 0.7); } }
        .status-safe { background: rgba(16, 185, 129, 0.15); color: #86efac; border: 1px solid rgba(16, 185, 129, 0.4); }
        .status-scan { background: rgba(59, 130, 246, 0.15); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.4); }
        
        /* MODALS */
        #crossroads-modal-wrapper, #comparison-modal-wrapper { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background: rgba(2, 6, 23, 0.4); opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
        #crossroads-modal-wrapper.active, #comparison-modal-wrapper.active { opacity: 1; pointer-events: auto; }
        .modal-inner { transform: translateY(20px) scale(0.95); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .active .modal-inner { transform: translateY(0) scale(1); }

        /* TOASTER */
        #toaster-notification { position: fixed; bottom: 2rem; right: 2rem; z-index: 9000; transform: translateY(150%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        #toaster-notification.show { transform: translateY(0); }
        
        .data-list { max-height: 400px; overflow-y: auto; font-family: 'Fira Code', monospace; font-size: 11px; }
        .data-list::-webkit-scrollbar { width: 4px; }
        .data-list::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col min-h-screen transition-colors duration-1000" id="main-body">

    <sv-header base-path=".."></sv-header>

    <div id="main-content-wrapper" class="flex-1 w-full">
        <main class="max-w-[1400px] mx-auto w-full px-4 py-8 flex flex-col gap-8 relative">
            
            <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                <div>
                    <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-tight transition-all duration-1000" id="main-title">
                        Metadata <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 transition-all duration-1000" id="title-accent">Scrubber</span>
                    </h1>
                    <p class="text-base text-slate-300 mt-2 font-medium">Scan, verify, and securely purge tracking data from your images locally.</p>
                </div>
            </div>

            <div id="file-error-alert" class="hidden glass-panel border-rose-500/50 bg-rose-950/20 p-4 rounded-xl flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    <span class="text-rose-200 font-medium text-sm">Invalid file type detected. Please upload an image or RAW file format.</span>
                </div>
                <button onclick="document.getElementById('file-error-alert').classList.add('hidden')" class="text-rose-400 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>

            <div id="upload-stage" class="glass-panel p-3 rounded-2xl transition-all duration-500 shadow-xl">
                <div id="drop-zone" class="drop-zone">
                    <div class="bg-blue-500/10 p-6 rounded-full mb-6 border border-blue-500/20 transition-all duration-500 shadow-[0_0_20px_rgba(59,130,246,0.15)]" id="dz-icon-wrap">
                        <svg class="w-14 h-14 text-blue-400 transition-colors duration-500" id="dz-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2 pointer-events-none tracking-tight">Select Image to Audit</h3>
                    <div class="flex flex-wrap gap-2 justify-center pointer-events-none mb-8 mt-2">
                        <span class="px-3 py-1 rounded bg-slate-800 text-[11px] text-white font-bold border border-slate-600 shadow-sm">JPEG / PNG / WEBP</span>
                        <span class="px-3 py-1 rounded bg-slate-800 text-[11px] text-blue-300 font-bold border border-blue-600 shadow-sm">HEIC / HEIF</span>
                        <span class="px-3 py-1 rounded bg-slate-800 text-[11px] text-rose-300 font-bold border border-rose-600 shadow-sm">CR2 / DNG / NEF</span>
                    </div>
                    <div class="px-8 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold pointer-events-none border border-blue-500 shadow-lg transition-colors">Browse Local Files</div>
                    <input type="file" id="file-input" accept="image/jpeg, image/png, image/webp, image/heic, image/heif, image/x-adobe-dng, image/x-canon-cr2, image/x-nikon-nef, image/x-sony-arw, .dng, .cr2, .nef, .arw, .webp, .png, .jpg, .jpeg">
                </div>
            </div>

            <div id="workspace-stage" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 items-start transition-all duration-500">
                <div class="lg:col-span-5 flex flex-col gap-4">
                    <div class="glass-panel p-5 rounded-2xl flex flex-col gap-5 shadow-xl">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div id="input-box" class="preview-box scanning"><div class="scanner-line"></div><span class="preview-label">Original Input</span><img id="img-input" class="preview-img" alt="Input Preview"></div>
                                <span id="label-filename-input" class="filename-text text-slate-300">...</span>
                            </div>
                            <div>
                                <div class="preview-box border-emerald-600/50">
                                    <span class="preview-label text-emerald-300 border-emerald-700 bg-emerald-900/80">Scrubbed Output</span>
                                    <div id="output-placeholder" class="text-xs text-slate-500 font-mono text-center flex flex-col items-center gap-2">
                                        <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                        Awaiting Processing
                                    </div>
                                    <img id="img-output" class="preview-img hidden" alt="Output Preview">
                                </div>
                                <span id="label-filename-output" class="filename-text text-emerald-400 opacity-0 transition-opacity duration-500 font-bold">...</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 shadow-inner"><span class="block text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-bold">Input Size</span><span id="file-size" class="text-white font-mono text-sm">0 KB</span></div>
                            <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 shadow-inner text-right"><span class="block text-[10px] text-slate-400 uppercase tracking-widest mb-1 font-bold">Engine</span><span id="badge-engine" class="text-white font-mono text-sm">Determining...</span></div>
                        </div>
                        <button id="btn-reset-app" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-200 text-sm font-bold px-4 py-4 rounded-xl transition-all duration-300 border border-slate-700 shadow-lg">Abort & Load New Target</button>
                    </div>
                </div>

                <div class="lg:col-span-7 flex flex-col gap-4">
                    <div class="terminal shadow-2xl" id="main-terminal">
                        <div class="terminal-header">
                            <span class="text-white font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                                <svg class="w-4 h-4 text-current" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg> Forensic Audit Log
                            </span>
                            
                            <div id="export-options" class="hidden flex items-center gap-2">
                                <span class="text-[10px] text-slate-400 uppercase tracking-widest mr-1 font-bold">Save As:</span>
                                <button id="btn-export-txt" class="text-[10px] font-bold bg-slate-800 hover:bg-slate-700 text-white px-3 py-1 rounded border border-slate-600 transition-colors">TXT</button>
                                <button id="btn-export-json" class="text-[10px] font-bold bg-slate-800 hover:bg-slate-700 text-white px-3 py-1 rounded border border-slate-600 transition-colors">JSON</button>
                                <button id="btn-export-csv" class="text-[10px] font-bold bg-slate-800 hover:bg-slate-700 text-white px-3 py-1 rounded border border-slate-600 transition-colors">CSV</button>
                            </div>
                            
                            <span id="meta-count" class="bg-blue-900/30 text-blue-300 px-3 py-1 rounded-md text-[11px] font-mono font-bold border border-blue-800/50">0 Tags</span>
                        </div>
                        <div class="terminal-body" id="terminal-out"></div>
                    </div>

                    <div id="location-map-container">
                        <div class="relative w-full h-full rounded-xl overflow-hidden shadow-xl border border-rose-500/30">
                            <div class="absolute top-3 left-3 z-[400] bg-rose-950/90 text-rose-300 text-[10px] font-bold uppercase tracking-widest px-3 py-1.5 rounded border border-rose-500/50 shadow-lg backdrop-blur flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span> Location Data Found
                            </div>
                            <div id="leaflet-map" class="rounded-xl"></div>
                        </div>
                    </div>

                    <div id="action-area" class="glass-panel p-5 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-4 shadow-xl relative overflow-hidden">
                        
                        <div id="action-msg-container" class="flex flex-col gap-1 relative z-10">
                            <span id="status-indicator" class="status-badge status-scan w-max transition-colors duration-500">
                                <svg class="w-3 h-3 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Scanning
                            </span>
                            <span id="action-msg" class="text-sm mt-1 block text-slate-300 font-medium">Analyzing binary structure...</span>
                        </div>
                        
                        <button id="btn-scrub" disabled class="hidden w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold px-8 py-4 rounded-xl transition-all duration-300 opacity-50 cursor-not-allowed shadow-lg relative z-10">
                            <span id="btn-scrub-text">Remove Metadata</span>
                        </button>
                        <button id="btn-download" class="hidden w-full md:w-auto bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold px-8 py-4 rounded-xl transition-all duration-300 shadow-[0_0_20px_rgba(16,185,129,0.3)] relative z-10">Download Secure File</button>
                    </div>
                </div>
            </div>

            <article class="mt-20 flex flex-col gap-16 border-t border-slate-800 pt-16">
                
                <section class="prose prose-invert prose-slate max-w-none glass-panel p-8 md:p-12 rounded-2xl shadow-xl">
                    <h2 class="text-white text-3xl font-extrabold mb-6">Understanding EXIF and Image Metadata</h2>
                    <p class="text-lg text-slate-300 leading-relaxed mb-6">Every time you take a picture with a smartphone or digital camera, the device invisibly attaches a massive payload of text-based information directly into the image file. This umbrella of information is known as <strong>Metadata</strong> (data about data). While some metadata is structurally required to render the image on a screen, much of it poses a severe privacy risk.</p>
                    
                    <h3 class="text-slate-200 text-xl font-bold mt-8 mb-4">The Three Layers of Hidden Data</h3>
                    <ul class="space-y-4 list-none pl-0">
                        <li class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <strong class="text-blue-400 font-bold block mb-1 text-lg">EXIF (Exchangeable Image File Format):</strong> 
                            <span class="text-slate-300 text-sm">The most common tracking payload. Created by camera manufacturers, EXIF data records the exact make and model of your device, the camera's unique hardware serial number, the date and time the photo was taken, and crucially, the precise GPS latitude and longitude coordinates.</span>
                        </li>
                        <li class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <strong class="text-rose-400 font-bold block mb-1 text-lg">XMP (Extensible Metadata Platform):</strong> 
                            <span class="text-slate-300 text-sm">An XML-based standard created by Adobe. If you edit a photo in Lightroom or Photoshop, an XMP packet is injected into the file detailing your edit history, software versions, and custom creator tags.</span>
                        </li>
                        <li class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <strong class="text-emerald-400 font-bold block mb-1 text-lg">Structural Data:</strong> 
                            <span class="text-slate-300 text-sm">Non-identifying machine data such as Image Width, Height, Bit Depth, and Color Space. SilenVault automatically whitelists structural data to ensure your files remain visually flawless after purging.</span>
                        </li>
                    </ul>

                    <h3 class="text-slate-200 text-2xl font-bold mt-10 mb-4">Why You Must Scrub Your Images</h3>
                    <p class="text-slate-300 leading-relaxed text-base">When you share an un-scrubbed image on forums, personal blogs, or via direct messaging apps, anyone can download that image and extract its EXIF payload in seconds. If the photo was taken at your home, the embedded GPS coordinates reveal your exact physical address to strangers. SilenVault acts as a cryptographic firewall, allowing you to audit the contents of your files, export the reports for your own records, and permanently obliterate the tracking data before you publish.</p>
                </section>

                <section>
                    <div class="mb-10 text-center max-w-2xl mx-auto">
                        <h2 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight">Standard Operating Procedure</h2>
                        <p class="text-slate-400 mt-4 text-lg">How to securely audit and annihilate image metadata using SilenVault.</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="glass-panel p-8 rounded-2xl relative overflow-hidden group shadow-lg">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="text-7xl font-black font-mono text-blue-500">01</span></div>
                            <h3 class="text-xl font-bold text-white mb-3 relative z-10">Establish Target</h3>
                            <p class="text-sm text-slate-300 leading-relaxed relative z-10">Upload any standard web image or heavy DSLR RAW file. Processing occurs 100% within your browser's local RAM. No uploads.</p>
                        </div>
                        <div class="glass-panel p-8 rounded-2xl relative overflow-hidden group shadow-lg">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="text-7xl font-black font-mono text-amber-500">02</span></div>
                            <h3 class="text-xl font-bold text-white mb-3 relative z-10">Diagnostic Audit</h3>
                            <p class="text-sm text-slate-300 leading-relaxed relative z-10">Our engine parses the binary file, mapping hidden structural headers, EXIF data, XMP XML packets, and embedded GPS coordinates.</p>
                        </div>
                        <div class="glass-panel p-8 rounded-2xl relative overflow-hidden group shadow-lg">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="text-7xl font-black font-mono text-rose-500">03</span></div>
                            <h3 class="text-xl font-bold text-white mb-3 relative z-10">Execute Purge</h3>
                            <p class="text-sm text-slate-300 leading-relaxed relative z-10">Depending on the format, the system deploys HTML5 Canvas re-encoding or a Native Deep TIFF Wiper to annihilate privacy risks.</p>
                        </div>
                        <div class="glass-panel p-8 rounded-2xl relative overflow-hidden group shadow-lg">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><span class="text-7xl font-black font-mono text-emerald-500">04</span></div>
                            <h3 class="text-xl font-bold text-white mb-3 relative z-10">Verification Gate</h3>
                            <p class="text-sm text-slate-300 leading-relaxed relative z-10">The newly generated file is intercepted and re-scanned. If even a single tracking tag survives, the download is blocked to guarantee safety.</p>
                        </div>
                    </div>
                </section>

                <section class="grid lg:grid-cols-12 gap-12 items-start bg-slate-900/50 p-8 md:p-12 rounded-3xl border border-slate-800">
                    <div class="lg:col-span-5 sticky top-8">
                        <h2 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight mb-4">The Architecture</h2>
                        <p class="text-slate-300 mb-8 text-lg leading-relaxed">Unlike standard online converters that upload your personal files to a remote server, SilenVault utilizes a <strong>Tree-Branching Architecture</strong> to process files locally.</p>
                        <div class="p-6 bg-blue-900/20 border border-blue-500/30 rounded-2xl shadow-inner">
                            <h4 class="text-blue-400 font-bold mb-3 flex items-center gap-2 text-lg">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg> Zero-Trust Promise
                            </h4>
                            <p class="text-sm text-blue-200/80 leading-relaxed">Your files are processed strictly in your device's memory. We have no servers, no databases, and absolutely no access to your images or their contents.</p>
                        </div>
                    </div>
                    <div class="lg:col-span-7 space-y-6">
                        <div class="glass-panel p-8 rounded-2xl shadow-md border-slate-700 hover:border-blue-500/50 transition-colors">
                            <div class="flex items-center gap-4 mb-4"><span class="p-2 bg-slate-800 rounded text-white font-mono text-xs font-bold border border-slate-600 shadow-inner">CANVAS API</span><h3 class="text-xl font-bold text-white">Pixel-Matrix Re-encoding</h3></div>
                            <p class="text-slate-400 leading-relaxed text-sm">Used for standard web formats. The browser unpacks the image into a raw matrix of RGB pixels, paints it onto an invisible HTML5 canvas, and exports a brand new file. Painting only the pixels guarantees that 100% of the tracking data is left behind.</p>
                        </div>
                        
                        <div class="glass-panel p-8 rounded-2xl shadow-md border-rose-900/30 hover:border-rose-500/50 transition-colors bg-rose-950/10">
                            <div class="flex flex-col gap-2 mb-4">
                                <div class="flex gap-2">
                                    <span class="p-2 bg-indigo-900/40 rounded text-indigo-300 font-mono text-xs font-bold border border-indigo-500/50 shadow-inner">WASM EXIV2</span>
                                    <span class="p-2 bg-rose-900/40 rounded text-rose-300 font-mono text-xs font-bold border border-rose-500/50 shadow-inner">NATIVE TIFF WIPER</span>
                                </div>
                                <h3 class="text-xl font-bold text-white mt-2">The Double-Pass Wiper</h3>
                            </div>
                            <p class="text-slate-400 leading-relaxed text-sm">Deployed for advanced proprietary formats (CR2, DNG). SilenVault dynamically injects a WebAssembly C++ engine to perform a structural sweep. Immediately after, a custom Native Javascript Algorithm mathematically walks the binary tree, validates structural tags necessary for the image to exist, and physically orchestrates a hex-level overwrite on any surviving privacy pointers.</p>
                        </div>
                    </div>
                </section>
                
                <div class="text-center pb-8 mt-8">
                    <p class="text-xs text-slate-500 border-t border-slate-800 pt-8 max-w-3xl mx-auto leading-relaxed">
                        <strong>LEGAL DISCLAIMER:</strong> SilenVault provides this tool for personal privacy protection and forensic auditing. The removal of EXIF metadata and XMP packets is an irreversible cryptographic process. Always maintain backups of your original RAW files before initiating a Deep Forge wipe.
                    </p>
                </div>
            </article>
        </main>
    </div>

    <div id="crossroads-modal-wrapper">
        <div class="glass-panel p-8 rounded-2xl max-w-xl w-full border-rose-500/60 relative overflow-hidden shadow-[0_0_50px_rgba(225,29,72,0.15)] mx-4 modal-inner">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-rose-500 to-amber-500"></div>
            <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-3">
                <svg class="w-7 h-7 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                Heavy RAW Format Detected
            </h2>
            <p class="text-sm text-slate-300 mb-6 font-medium">You uploaded a DSLR format (<span id="raw-ext-badge" class="font-bold text-rose-300"></span>). Choose your processing path:</p>
            <div class="space-y-4">
                <button id="btn-modal-standard" class="w-full text-left p-5 rounded-xl border border-slate-600 bg-slate-800/80 hover:bg-slate-700 transition-all group shadow-md">
                    <span class="font-bold text-blue-400 block mb-1 text-lg">Standard Conversion (Fast)</span>
                    <span class="text-sm text-slate-400">Extracts the secret preview and safely exports a clean, highly-compatible JPEG.</span>
                </button>
                
                <button id="btn-modal-forge" class="w-full text-left p-5 rounded-xl border border-rose-600 bg-rose-900/40 hover:bg-rose-800/60 transition-all group shadow-[0_0_15px_rgba(225,29,72,0.2)] relative overflow-hidden">
                    <span id="btn-wasm-text" class="font-bold text-rose-300 flex items-center gap-2 mb-1 text-lg">Execute Double-Pass Wiper</span>
                    <span class="text-sm text-rose-200/80">Uses diagnostic intelligence to target metadata natively, retaining exact file extension.</span>
                    
                    <div id="forge-progress-wrap" class="hidden w-full h-1.5 bg-rose-950 rounded-full mt-4 overflow-hidden relative">
                        <div id="forge-progress-bar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-rose-500 to-amber-500 w-0 transition-all duration-[2500ms] ease-out"></div>
                    </div>
                </button>
                
                <button id="btn-modal-cancel" class="w-full text-center p-3 rounded-xl border border-slate-700 bg-slate-800/50 hover:bg-slate-800 text-sm font-bold text-slate-300 transition-all">Cancel</button>
            </div>
        </div>
    </div>

    <div id="comparison-modal-wrapper">
        <div class="glass-panel p-6 rounded-2xl max-w-4xl w-full border-blue-500/40 shadow-2xl mx-4 modal-inner flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-700">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
                    Forensic Data Comparison
                </h2>
                <button id="btn-close-comparison" class="text-slate-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 overflow-hidden">
                <div class="flex flex-col bg-slate-900/50 rounded-xl border border-slate-700">
                    <div class="p-3 border-b border-slate-700 bg-slate-800/50 rounded-t-xl flex justify-between items-center">
                        <span class="font-bold text-rose-400 text-sm">Original Payload</span>
                        <span id="count-original" class="bg-rose-900/50 text-rose-300 px-2 py-0.5 rounded text-xs font-mono">0 Tags</span>
                    </div>
                    <div id="list-original" class="p-4 data-list space-y-2 text-slate-300"></div>
                </div>
                
                <div class="flex flex-col bg-slate-900/50 rounded-xl border border-slate-700">
                    <div class="p-3 border-b border-slate-700 bg-slate-800/50 rounded-t-xl flex justify-between items-center">
                        <span class="font-bold text-emerald-400 text-sm">Retained Structural Data</span>
                        <span id="count-scrubbed" class="bg-emerald-900/50 text-emerald-300 px-2 py-0.5 rounded text-xs font-mono">0 Tags</span>
                    </div>
                    <div id="list-scrubbed" class="p-4 data-list space-y-2 text-slate-300"></div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-700 text-xs text-slate-400 text-center">
                Notice: Retained data consists entirely of non-identifying machine structure (Width, Height, Color Space) required to display the image.
            </div>
        </div>
    </div>

    <div id="toaster-notification" class="glass-panel p-4 rounded-xl border-emerald-500/50 shadow-[0_10px_40px_rgba(0,0,0,0.5)] flex items-center gap-4 bg-slate-900">
        <div class="bg-emerald-500/20 p-2 rounded-full">
            <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <div>
            <h4 class="text-white font-bold text-sm">Verification Passed</h4>
            <p class="text-xs text-slate-400">Tracking metadata successfully annihilated.</p>
        </div>
        <button id="btn-view-comparison" class="ml-4 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-blue-400 text-xs font-bold rounded-lg border border-slate-600 transition-colors">Compare Data</button>
        <button id="btn-close-toaster" class="ml-2 text-slate-500 hover:text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
    </div>

    <sv-footer base-path=".."></sv-footer>

    <script type="module">
        import { ProcessorFactory } from '../assets/js/exif_processors/Dispatcher.js?v=11.0';

        // STATE
        let originalFile = null;
        let scrubbedBlob = null;
        let sourceImageObj = new Image(); 
        let processorInstance = null;
        let fileExt = '';
        let outputExt = ''; 
        let isAdvancedMode = false;
        
        let originalMetadataCache = {}; 
        let scrubbedMetadataCache = {};
        let rawExifCache = {}; 

        let currentScanId = 0;
        let threatMap = null;
        let mapMarker = null;
        let activeUrls = []; 

        // TERMINAL QUEUE FOR BUTTERY SMOOTH TYPING
        let terminalQueue = [];
        let isPrinting = false;

        const STRUCTURAL_WHITELIST = ['ImageWidth', 'ImageHeight', 'ExifImageWidth', 'ExifImageHeight', 'Orientation', 'ColorSpace', 'Compression', 'XResolution', 'YResolution', 'ResolutionUnit', 'BitDepth', 'ColorType', 'Filter', 'Interlace', 'SamplesPerPixel', 'RowsPerStrip', 'StripByteCounts', 'StripOffsets', 'PlanarConfiguration', 'PhotometricInterpretation', 'SubfileType'];

        // DOM BINDS
        const dz = document.getElementById('drop-zone');
        dz.addEventListener('dragenter', e => { e.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
        dz.addEventListener('dragleave', e => { e.preventDefault(); dz.classList.remove('dragover'); });
        dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
        document.getElementById('file-input').addEventListener('change', e => handleFile(e.target.files[0]));

        document.getElementById('btn-modal-standard').addEventListener('click', () => executeCrossroads('standard'));
        document.getElementById('btn-modal-forge').addEventListener('click', () => executeCrossroads('forge'));
        document.getElementById('btn-modal-cancel').addEventListener('click', cancelCrossroads);

        document.getElementById('btn-reset-app').addEventListener('click', () => resetApp(false));
        document.getElementById('btn-scrub').addEventListener('click', executeImageProcessing);
        document.getElementById('btn-download').addEventListener('click', downloadImage);

        document.getElementById('btn-export-txt').addEventListener('click', () => exportReport('txt'));
        document.getElementById('btn-export-json').addEventListener('click', () => exportReport('json'));
        document.getElementById('btn-export-csv').addEventListener('click', () => exportReport('csv'));

        document.getElementById('btn-close-toaster').addEventListener('click', () => { document.getElementById('toaster-notification').classList.remove('show'); });
        document.getElementById('btn-view-comparison').addEventListener('click', () => { 
            populateComparison(); 
            document.getElementById('comparison-modal-wrapper').classList.add('active'); 
        });
        document.getElementById('btn-close-comparison').addEventListener('click', () => { document.getElementById('comparison-modal-wrapper').classList.remove('active'); });

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024, i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + ['Bytes', 'KB', 'MB'][i];
        }

        function isPrivacyThreat(key, val) {
            if (STRUCTURAL_WHITELIST.includes(key)) return false; 
            if (typeof val === 'object' && val !== null && !(val instanceof Date)) return false; 
            return true;
        }

        function getSeverity(key) {
            if (['latitude', 'longitude', 'gps', 'serial'].some(h => key.toLowerCase().includes(h))) return 'high';
            return 'low';
        }

        // SMOOTH TERMINAL QUEUE PROCESSOR
        function logToTerminal(key, val, severity = 'low') {
            terminalQueue.push({ key, val, severity });
            if (!isPrinting) processTerminalQueue();
        }

        async function processTerminalQueue() {
            if (terminalQueue.length === 0) {
                isPrinting = false;
                return;
            }
            isPrinting = true;
            
            const { key, val, severity } = terminalQueue.shift();
            const terminalOut = document.getElementById('terminal-out');
            const line = document.createElement('div');
            line.className = 'log-line';
            
            const safeVal = (typeof val === 'string') ? val.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : val;
            
            if (severity === 'sys') line.innerHTML = `<span class="val-sys">${safeVal}</span>`;
            else if (severity === 'safe') line.innerHTML = `<span class="log-key">${key}</span><span class="val-safe">${safeVal}</span>`;
            else line.innerHTML = `<span class="log-key">${key}</span><span class="log-val val-${severity}">${safeVal}</span>`;
            
            terminalOut.appendChild(line);
            terminalOut.scrollTop = terminalOut.scrollHeight;
            
            // Dynamic delay: System messages pause slightly longer for readability
            const delay = severity === 'sys' ? 300 : 80;
            await new Promise(r => setTimeout(r, delay));
            
            processTerminalQueue();
        }

        function handleFile(file) {
            if (!file) return;
            
            // Image/RAW validation
            const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/heic', 'image/heif', 'image/x-adobe-dng', 'image/x-canon-cr2', 'image/x-nikon-nef', 'image/x-sony-arw'];
            const validExtensions = ['JPG', 'JPEG', 'PNG', 'WEBP', 'HEIC', 'HEIF', 'DNG', 'CR2', 'NEF', 'ARW'];
            const ext = file.name.split('.').pop().toUpperCase();
            
            if (!validTypes.includes(file.type) && !validExtensions.includes(ext)) {
                document.getElementById('file-error-alert').classList.remove('hidden');
                return;
            }
            document.getElementById('file-error-alert').classList.add('hidden');

            activeUrls.forEach(url => URL.revokeObjectURL(url));
            activeUrls = [];

            originalFile = file;
            fileExt = ext;
            document.getElementById('label-filename-input').innerText = file.name;
            
            if (['CR2', 'DNG', 'NEF', 'ARW'].includes(fileExt)) {
                if (isAdvancedMode) {
                    processorInstance = ProcessorFactory.create(originalFile, fileExt, true);
                    startWorkspace(); return;
                }
                document.getElementById('raw-ext-badge').innerText = `.${fileExt}`;
                document.getElementById('crossroads-modal-wrapper').classList.add('active');
                document.body.classList.add('modal-active'); // Triggers Background Blur
                return;
            }
            
            isAdvancedMode = false;
            processorInstance = ProcessorFactory.create(originalFile, fileExt, false);
            startWorkspace(); 
        }

        async function executeCrossroads(mode) {
            if (mode === 'forge') {
                isAdvancedMode = true;
                const btnText = document.getElementById('btn-wasm-text');
                const originalText = btnText.innerHTML;
                const wrap = document.getElementById('forge-progress-wrap');
                const bar = document.getElementById('forge-progress-bar');
                
                // UX: Fake Loading Bar & Text
                btnText.innerHTML = `<svg class="w-5 h-5 animate-spin inline mr-2 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Injecting Memory Modules...`;
                wrap.classList.remove('hidden');
                setTimeout(() => { bar.style.width = '100%'; }, 50); // Triggers CSS transition
                
                processorInstance = ProcessorFactory.create(originalFile, fileExt, true);
                
                try {
                    // Wait for both the WASM load and the fake progress bar to finish simultaneously
                    await Promise.all([
                        (processorInstance.loadWasm ? processorInstance.loadWasm() : Promise.resolve()),
                        new Promise(r => setTimeout(r, 2500))
                    ]);
                    
                    document.getElementById('crossroads-modal-wrapper').classList.remove('active');
                    document.body.classList.remove('modal-active');
                    
                    document.body.classList.add('portal-transition'); 
                    document.getElementById('main-body').classList.add('forge-mode');
                    document.getElementById('title-accent').className = "text-transparent bg-clip-text bg-gradient-to-r from-rose-500 to-amber-500 transition-all duration-1000";
                    document.getElementById('dz-icon-wrap').className = "bg-rose-500/10 p-6 rounded-full mb-6 border border-rose-500/20";
                    document.getElementById('dz-icon').setAttribute('class', "w-14 h-14 text-rose-500 transition-colors duration-500");
                    
                    startWorkspace();
                    setTimeout(() => document.body.classList.remove('portal-transition'), 600);
                } catch(e) {
                    document.getElementById('crossroads-modal-wrapper').classList.remove('active');
                    document.body.classList.remove('modal-active');
                    document.body.classList.add('portal-transition'); 
                    document.getElementById('main-body').classList.add('forge-mode');
                    document.getElementById('title-accent').className = "text-transparent bg-clip-text bg-gradient-to-r from-rose-500 to-amber-500 transition-all duration-1000";
                    startWorkspace();
                    setTimeout(() => document.body.classList.remove('portal-transition'), 600);
                } finally {
                    btnText.innerHTML = originalText;
                    wrap.classList.add('hidden');
                    bar.style.width = '0';
                }
            } else {
                isAdvancedMode = false;
                processorInstance = ProcessorFactory.create(originalFile, fileExt, false);
                document.getElementById('crossroads-modal-wrapper').classList.remove('active');
                document.body.classList.remove('modal-active');
                startWorkspace();
            }
        }

        function cancelCrossroads() {
            document.getElementById('crossroads-modal-wrapper').classList.remove('active');
            document.body.classList.remove('modal-active');
            document.getElementById('file-input').value = '';
            originalFile = null;
        }

        function startWorkspace() {
            currentScanId++;
            let thisScanId = currentScanId;

            originalMetadataCache = {};
            scrubbedMetadataCache = {};
            rawExifCache = {};
            terminalQueue = []; 
            isPrinting = false;
            
            if (threatMap) document.getElementById('location-map-container').classList.remove('active');
            document.getElementById('export-options').classList.add('hidden');
            document.getElementById('toaster-notification').classList.remove('show');
            
            document.getElementById('file-size').innerText = formatBytes(originalFile.size);
            document.getElementById('upload-stage').classList.add('hidden');
            document.getElementById('workspace-stage').classList.remove('hidden');
            
            document.getElementById('terminal-out').innerHTML = '';
            document.getElementById('input-box').classList.add('scanning');
            document.getElementById('img-input').classList.remove('scanned');
            
            document.getElementById('btn-scrub').disabled = true;
            document.getElementById('btn-scrub').classList.add('opacity-50', 'cursor-not-allowed', 'hidden');
            document.getElementById('btn-download').classList.add('hidden');

            document.getElementById('badge-engine').innerText = processorInstance.engineName;
            
            if(isAdvancedMode) {
                document.getElementById('badge-engine').className = processorInstance.engineClass || 'text-rose-400 font-mono text-sm';
                document.getElementById('btn-scrub').className = "hidden w-full md:w-auto bg-rose-700 hover:bg-rose-600 text-white text-sm font-bold px-8 py-4 rounded-xl transition-all duration-300 shadow-[0_0_20px_rgba(225,29,72,0.4)] flex items-center justify-center opacity-50 cursor-not-allowed";
            } else {
                document.getElementById('badge-engine').className = processorInstance.engineClass || 'text-blue-300 font-mono text-sm';
                document.getElementById('btn-scrub').className = "hidden w-full md:w-auto bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold px-8 py-4 rounded-xl transition-all duration-300 shadow-[0_0_20px_rgba(59,130,246,0.3)] flex items-center justify-center opacity-50 cursor-not-allowed";
            }
            document.getElementById('btn-scrub-text').innerText = processorInstance.buttonText;

            logToTerminal('', '> INITIALIZING SECURE METADATA AUDIT...', 'sys');

            requestAnimationFrame(() => setTimeout(() => runHeavyProcessing(thisScanId), 50));
        }

        async function runHeavyProcessing(thisScanId) {
            try {
                let urlToLoad = await processorInstance.getPreviewUrl();
                if (urlToLoad) {
                    activeUrls.push(urlToLoad);
                    await new Promise((resolve, reject) => {
                        sourceImageObj.onload = () => resolve();
                        sourceImageObj.onerror = () => reject();
                        sourceImageObj.src = urlToLoad;
                    });
                    document.getElementById('img-input').src = urlToLoad;
                }
            } catch(e) {}
            scanMetadata(thisScanId);
        }

        async function scanMetadata(thisScanId) {
            try {
                const buffer = await originalFile.arrayBuffer();
                const exifData = await window.exifr.parse(buffer, {tiff: true, ifd0: true, exif: true, gps: true, xmp: true, iptc: true});
                if (thisScanId !== currentScanId) return; 

                if (exifData && Object.keys(exifData).length > 0) {
                    
                    for(let key in exifData) {
                        let val = exifData[key];
                        if (val instanceof Date) val = val.toISOString();
                        if (typeof val !== 'object' || val === null) {
                            originalMetadataCache[key] = val;
                        }
                    }

                    const usefulKeys = Object.keys(exifData).filter(key => isPrivacyThreat(key, exifData[key]));
                    if (usefulKeys.length === 0) return handleCleanFile();
                    
                    document.getElementById('meta-count').innerText = `${usefulKeys.length} Tags`;
                    
                    usefulKeys.forEach(key => {
                        let val = exifData[key];
                        if (val instanceof Date) val = val.toISOString();
                        rawExifCache[key] = val; 
                        logToTerminal(key, val, getSeverity(key));
                    });

                    logToTerminal('', `> SCAN COMPLETE. [${usefulKeys.length}] PRIVACY RISKS FOUND.`, 'sys');
                    
                    // Hook into terminal queue to ensure UI updates only after all lines print
                    const checkPrintQueue = setInterval(() => {
                        if (!isPrinting) {
                            clearInterval(checkPrintQueue);
                            document.getElementById('input-box').classList.remove('scanning');
                            document.getElementById('img-input').classList.add('scanned');

                            if (exifData.latitude && exifData.longitude) {
                                triggerMap(exifData.latitude, exifData.longitude);
                                document.getElementById('status-indicator').className = "status-badge status-danger";
                                document.getElementById('status-indicator').innerHTML = `<span class="w-2 h-2 rounded-full bg-rose-500"></span> LOCATION EXPOSED`;
                                document.getElementById('action-msg').innerHTML = `<span class="text-rose-400 font-bold">Action Required:</span> Immediate purge required.`;
                            } else {
                                document.getElementById('status-indicator').className = "status-badge status-warn";
                                document.getElementById('status-indicator').innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-500"></span> Metadata Present`;
                                document.getElementById('action-msg').innerHTML = `<span class="text-amber-400 font-bold">Action Required:</span> Hidden trackers found.`;
                            }

                            document.getElementById('btn-scrub').disabled = false;
                            document.getElementById('btn-scrub').classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
                            document.getElementById('export-options').classList.remove('hidden'); 
                            
                            if (processorInstance.setCache) processorInstance.setCache(originalMetadataCache);
                        }
                    }, 200);

                } else {
                    handleCleanFile();
                }
            } catch (error) {
                handleCleanFile();
            }
        }

        function triggerMap(lat, lng) {
            document.getElementById('location-map-container').classList.add('active'); 
            const redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            if (!threatMap) {
                threatMap = L.map('leaflet-map').setView([lat, lng], 14);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(threatMap);
                mapMarker = L.marker([lat, lng], {icon: redIcon}).addTo(threatMap);
            } else {
                threatMap.setView([lat, lng], 14);
                mapMarker.setLatLng([lat, lng]);
            }
            setTimeout(() => { threatMap.invalidateSize(); }, 300);
        }

        function handleCleanFile() {
            setTimeout(() => {
                document.getElementById('input-box').classList.remove('scanning');
                document.getElementById('img-input').classList.add('scanned');
                document.getElementById('meta-count').innerText = `0 Tags`;
                logToTerminal('', '> SCAN COMPLETE. NO PRIVACY DATA DETECTED.', 'sys');
                logToTerminal('STATUS', 'CLEAN', 'safe');
                
                document.getElementById('status-indicator').className = "status-badge status-safe";
                document.getElementById('status-indicator').innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Safe File`;
                document.getElementById('action-msg').innerHTML = `<span class="text-emerald-400 font-bold">Verified:</span> Image is natively safe. You may still Force Purge.`;

                scrubbedBlob = originalFile; 
                outputExt = `.${fileExt.toLowerCase()}`;
                document.getElementById('img-output').src = document.getElementById('img-input').src;
                document.getElementById('output-placeholder').classList.add('hidden');
                document.getElementById('img-output').classList.remove('hidden');
                
                document.getElementById('label-filename-output').innerText = originalFile.name;
                document.getElementById('label-filename-output').classList.remove('opacity-0');
                
                document.getElementById('btn-scrub-text').innerText = "Force Purge";
                document.getElementById('btn-scrub').disabled = false;
                document.getElementById('btn-scrub').classList.remove('opacity-50', 'cursor-not-allowed', 'hidden');
                document.getElementById('btn-download').classList.remove('hidden');
            }, 1000);
        }

        function executeImageProcessing() {
            document.getElementById('btn-scrub').disabled = true;
            document.getElementById('btn-scrub').classList.add('opacity-50', 'cursor-not-allowed');

            // Add scanning overlay back to preview
            document.getElementById('input-box').classList.add('scanning');

            setTimeout(async () => {
                try {
                    const blob = await processorInstance.scrub(sourceImageObj);
                    outputExt = processorInstance.outputMime ? `.${processorInstance.outputMime.split('/')[1]}` : `.${fileExt.toLowerCase()}`;
                    if (outputExt === '.jpeg') outputExt = '.jpg';
                    verifyAndFinalize(blob);
                } catch(e) {
                    logToTerminal('CRITICAL_ERROR', e.message || 'Processing engine failed.', 'high');
                    document.getElementById('btn-scrub-text').innerText = "Failed";
                    document.getElementById('input-box').classList.remove('scanning');
                }
            }, 50);
        }

        async function verifyAndFinalize(blob) {
            logToTerminal('', '> RUNNING POST-SCRUB VERIFICATION AUDIT...', 'sys');
            try {
                const fileBuffer = await blob.arrayBuffer();
                const checkData = await window.exifr.parse(fileBuffer, {tiff: true, ifd0: true, exif: true, gps: true, xmp: true});
                
                if (checkData) {
                    for(let key in checkData) {
                        let val = checkData[key];
                        if (val instanceof Date) val = val.toISOString();
                        if (typeof val !== 'object' || val === null) {
                            scrubbedMetadataCache[key] = val;
                        }
                    }

                    const surviving = Object.keys(checkData).filter(k => isPrivacyThreat(k, checkData[k]));
                    if (surviving.length > 0) {
                        logToTerminal('VERIFICATION_FAILED', `${surviving.length} privacy tags survived.`, 'high');
                        document.getElementById('btn-scrub-text').innerText = "Verification Failed";
                        document.getElementById('action-msg').innerHTML = `<span class="text-rose-400 font-bold">Error:</span> Output failed safety verification.`;
                        document.getElementById('input-box').classList.remove('scanning');
                        return;
                    }
                }
            } catch(e) {}

            logToTerminal('VERIFICATION', 'PASSED. 0 PRIVACY RISKS DETECTED.', 'safe');
            logToTerminal('FORMAT', `${outputExt.toUpperCase()} EXACT RETENTION`, 'safe');
            
            // Wait for queue to finish before showing UI updates
            const checkVerificationPrint = setInterval(() => {
                if (!isPrinting) {
                    clearInterval(checkVerificationPrint);
                    
                    document.getElementById('input-box').classList.remove('scanning');
                    scrubbedBlob = blob;
                    document.getElementById('location-map-container').classList.remove('active'); 
                    
                    document.getElementById('status-indicator').className = "status-badge status-safe";
                    document.getElementById('status-indicator').innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Threat Neutralized`;
                    document.getElementById('action-msg').innerHTML = `<span class="text-emerald-400 font-bold">Success:</span> Metadata completely stripped.`;
                    
                    document.getElementById('file-size').innerText = formatBytes(blob.size);

                    const outputUrl = URL.createObjectURL(blob);
                    activeUrls.push(outputUrl);
                    
                    if (processorInstance.outputMime) document.getElementById('img-output').src = outputUrl;
                    else document.getElementById('img-output').src = document.getElementById('img-input').src; 
                    
                    document.getElementById('output-placeholder').classList.add('hidden');
                    document.getElementById('img-output').classList.remove('hidden');
                    
                    const nameBase = originalFile.name.substring(0, originalFile.name.lastIndexOf('.'));
                    document.getElementById('label-filename-output').innerText = `${nameBase}_clean${outputExt}`;
                    document.getElementById('label-filename-output').classList.remove('opacity-0');
                    
                    document.getElementById('btn-scrub').classList.add('hidden');
                    document.getElementById('export-options').classList.add('hidden'); 
                    document.getElementById('btn-download').classList.remove('hidden');

                    document.getElementById('toaster-notification').classList.add('show');
                }
            }, 200);
        }

        function populateComparison() {
            const listOrig = document.getElementById('list-original');
            const listScrub = document.getElementById('list-scrubbed');
            
            listOrig.innerHTML = ''; listScrub.innerHTML = '';
            let origCount = 0; let scrubCount = 0;

            for (const [key, val] of Object.entries(originalMetadataCache)) {
                let div = document.createElement('div');
                if (isPrivacyThreat(key, val) && !scrubbedMetadataCache[key]) {
                    div.innerHTML = `<span class="text-rose-400 font-bold">${key}:</span> <span class="text-rose-200/70 truncate block">${val}</span>`;
                } else {
                    div.innerHTML = `<span class="text-slate-400 font-bold">${key}:</span> <span class="text-slate-500 truncate block">${val}</span>`;
                }
                listOrig.appendChild(div);
                origCount++;
            }

            for (const [key, val] of Object.entries(scrubbedMetadataCache)) {
                let div = document.createElement('div');
                div.innerHTML = `<span class="text-emerald-400 font-bold">${key}:</span> <span class="text-emerald-200/70 truncate block">${val}</span>`;
                listScrub.appendChild(div);
                scrubCount++;
            }

            if (scrubCount === 0) listScrub.innerHTML = `<div class="text-slate-500 italic mt-4 text-center">100% Data Annihilated</div>`;

            document.getElementById('count-original').innerText = `${origCount} Tags`;
            document.getElementById('count-scrubbed').innerText = `${scrubCount} Tags`;
        }

        function downloadImage() {
            if (!scrubbedBlob) return;
            const nameBase = originalFile.name.substring(0, originalFile.name.lastIndexOf('.'));
            const url = URL.createObjectURL(scrubbedBlob);
            activeUrls.push(url);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${nameBase}_clean${outputExt}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function exportReport(format = 'txt') {
            let content = '';
            let mimeType = 'text/plain';
            let fileExt = 'txt';

            if (format === 'txt') {
                content = `SilenVault EXIF Audit Report\nFilename: ${originalFile.name}\nScanned: ${new Date().toLocaleString()}\n----------------------------------------\n\n`;
                for (const [key, value] of Object.entries(originalMetadataCache)) content += `${key}: ${value}\n`;
            } else if (format === 'json') {
                content = JSON.stringify(originalMetadataCache, null, 2);
                mimeType = 'application/json';
                fileExt = 'json';
            } else if (format === 'csv') {
                content = "Key,Value\n";
                for (const [key, value] of Object.entries(originalMetadataCache)) {
                    let safeVal = String(value).replace(/"/g, '""'); 
                    content += `"${key}","${safeVal}"\n`;
                }
                mimeType = 'text/csv';
                fileExt = 'csv';
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            activeUrls.push(url);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${originalFile.name}_EXIF_Report.${fileExt}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function resetApp(retainMode = false) {
            activeUrls.forEach(url => URL.revokeObjectURL(url));
            activeUrls = [];
            
            if (threatMap) { threatMap.remove(); threatMap = null; }
            document.getElementById('location-map-container').classList.remove('active');
            
            if (!retainMode) {
                isAdvancedMode = false;
                document.getElementById('main-body').classList.remove('forge-mode');
                document.body.classList.remove('portal-transition', 'modal-active');
                document.getElementById('title-accent').className = "text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 transition-all duration-1000";
                document.getElementById('title-accent').innerText = "Scrubber";
                document.getElementById('dz-icon-wrap').className = "bg-blue-500/10 p-6 rounded-full mb-6 border border-blue-500/20 shadow-[0_0_20px_rgba(59,130,246,0.15)]";
                document.getElementById('dz-icon').setAttribute('class', "w-14 h-14 text-blue-400");
            }
            
            document.getElementById('workspace-stage').classList.add('hidden');
            document.getElementById('upload-stage').classList.remove('hidden');
            document.getElementById('export-options').classList.add('hidden');
            document.getElementById('toaster-notification').classList.remove('show');
            document.getElementById('comparison-modal-wrapper').classList.remove('active');
            
            document.getElementById('file-input').value = '';
            originalFile = null; scrubbedBlob = null; processorInstance = null;
            rawExifCache = {}; originalMetadataCache = {}; scrubbedMetadataCache = {}; 
            currentScanId++; sourceImageObj = new Image();
            terminalQueue = []; isPrinting = false;
            
            document.getElementById('terminal-out').innerHTML = '';
            document.getElementById('img-input').src = ''; document.getElementById('img-output').src = '';
            document.getElementById('input-box').classList.add('scanning'); 
            document.getElementById('img-input').classList.remove('scanned');
            document.getElementById('output-placeholder').classList.remove('hidden'); 
            document.getElementById('img-output').classList.add('hidden');
            document.getElementById('label-filename-input').innerText = '...'; 
            document.getElementById('label-filename-output').classList.add('opacity-0');

            document.getElementById('btn-scrub').disabled = true;
            document.getElementById('btn-scrub').classList.add('opacity-50', 'cursor-not-allowed', 'hidden');
            document.getElementById('btn-download').classList.add('hidden');
        }
    </script>
</body>
</html>
