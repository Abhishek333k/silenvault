<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Acoustic Data Link | Air-Gap Transceiver | SilenVault</title>
    <meta name="description" content="A full-duplex, ultrasonic acoustic modem with Auto-ACK loop for air-gapped device communication.">
    <meta name="keywords" content="acoustic modem, ultrasonic communication, air gap bridge, ggwave, quiet.js, dsp engine, sound walkie talkie">
    <meta name="author" content="SilenVault">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="../assets/js/layout.js" defer></script>
    <link rel="stylesheet" href="../assets/css/components.css">

    <script type="text/javascript" src="../assets/wasm/quiet/quiet.js"></script>
    
    <script type="text/javascript">
        Quiet.init({
            profilesPrefix: "../assets/wasm/quiet/",
            memoryInitializerPrefix: "../assets/wasm/quiet/",
            libfecPrefix: "../assets/wasm/quiet/"
        });
    </script>
    
    <script async type="text/javascript" src="../assets/wasm/quiet/quiet-emscripten.js"></script>

    <style>
        :root {
            --bg-color: #0f172a; 
            --panel-bg: rgba(30, 41, 59, 0.85); 
            --border-color: #334155;
            --primary-text: #f8fafc;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary-text); overflow-x: hidden; }
        .glass-panel { background: var(--panel-bg); backdrop-filter: blur(16px); border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .mono { font-family: 'Fira Code', monospace; }

        .terminal-scroll { overflow-y: auto; scroll-behavior: smooth; }
        .terminal-scroll::-webkit-scrollbar { width: 6px; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        canvas { image-rendering: pixelated; }

        /* Chat UI Styles */
        .chat-bubble { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.75rem; word-wrap: break-word; font-size: 0.875rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .chat-sent { align-self: flex-end; background: #1e3a8a; border-bottom-right-radius: 0.25rem; border: 1px solid #2563eb; }
        .chat-recv { align-self: flex-start; background: #064e3b; border-bottom-left-radius: 0.25rem; border: 1px solid #10b981; }
        
        .pulse-tx { animation: pulse-tx-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-tx-ring { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }

        .pulse-rx { animation: pulse-rx-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-rx-ring { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <sv-header base-path=".."></sv-header>

    <main class="flex-1 max-w-[1000px] mx-auto w-full px-4 py-8 flex flex-col gap-6">
        
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-white tracking-tight">
                    Acoustic <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-500">Transceiver</span>
                </h1>
                <p class="text-sm text-slate-400 mt-1">Full-Duplex Encrypted Chat via Air-Gapped Audio.</p>
            </div>
            <span class="bg-emerald-900/30 border border-emerald-500/30 text-emerald-300 px-3 py-1 rounded text-xs font-bold uppercase tracking-widest" id="engine-status">DSP: BOOTING...</span>
        </div>

        <div id="mic-alert" class="hidden glass-panel border-rose-500/50 bg-rose-950/20 p-4 rounded-xl flex items-center gap-3">
            <svg class="w-6 h-6 text-rose-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            <span class="text-rose-200 font-medium text-sm">Microphone Access Denied! Ensure you are running this on a secure server (localhost or HTTPS), and your browser permissions allow microphone access.</span>
        </div>

        <div class="glass-panel rounded-2xl border border-slate-700 shadow-2xl flex flex-col h-[65vh] min-h-[500px] overflow-hidden relative bg-slate-900/80">
            
            <div class="bg-[#020617] border-b border-slate-700 p-4 flex flex-col sm:flex-row justify-between items-center gap-4 z-10 relative shadow-md">
                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <button id="btn-engage" onclick="toggleTransceiver()" disabled class="bg-slate-800 text-slate-500 font-bold px-6 py-2 rounded-lg border border-slate-600 uppercase tracking-widest text-xs transition-all w-full sm:w-auto flex items-center justify-center gap-2 shadow-inner">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                        <span id="btn-engage-text">Loading DSP...</span>
                    </button>
                    <div id="status-dot" class="w-3 h-3 rounded-full bg-slate-600 shadow-inner shrink-0"></div>
                </div>

                <div class="flex items-center gap-3 w-full sm:w-auto">
                    <select id="config-band" class="bg-slate-800 border border-slate-600 text-slate-300 text-xs font-bold rounded-lg px-3 py-2 outline-none shadow-inner focus:border-emerald-500 transition-colors cursor-pointer w-full sm:w-56">
                        <option value="ultrasonic-experimental">Covert (Ultrasonic ~19kHz)</option>
                        <option value="audible" selected>Audible (VHF Modem ~3kHz)</option>
                    </select>
                </div>
            </div>

            <div id="chat-window" class="flex-1 terminal-scroll p-6 flex flex-col relative bg-gradient-to-b from-[#0f172a] to-[#020617]">
                
                <div class="absolute inset-0 z-0 opacity-20 pointer-events-none overflow-hidden">
                    <canvas id="spectrogram" class="w-full h-full"></canvas>
                </div>

                <div class="text-center mb-6 relative z-10">
                    <span class="bg-slate-800 text-slate-400 px-3 py-1 rounded-full text-[10px] font-mono border border-slate-700 shadow-inner">Acoustic Encryption Established</span>
                </div>

                </div>

            <div class="bg-[#020617] border-t border-slate-700 p-4 z-10">
                <div class="flex items-end gap-3 relative">
                    <textarea id="chat-input" disabled rows="2" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white focus:outline-none focus:border-blue-500 resize-none shadow-inner placeholder-slate-600" placeholder="Type a covert message (Max 40 chars)..."></textarea>
                    
                    <button id="btn-send" onclick="sendChatMessage()" disabled class="bg-blue-600 hover:bg-blue-500 disabled:bg-slate-800 disabled:text-slate-600 disabled:border-slate-700 text-white p-3 rounded-xl shadow-lg transition-all border border-blue-500 shrink-0 h-[46px] w-[46px] flex items-center justify-center cursor-not-allowed">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                    </button>
                </div>
            </div>

        </div>

        <article class="mt-8 flex flex-col gap-6 border-t border-slate-800 pt-10">
            <section class="glass-panel p-8 rounded-2xl shadow-xl prose prose-invert max-w-none border-l-4 border-l-blue-500">
                <h2 class="text-white text-2xl font-extrabold mb-2">The "Lovers Protocol" (Auto-ACK)</h2>
                <p class="text-slate-300 text-sm leading-relaxed">This terminal operates as a <strong>Full-Duplex Acoustic Transceiver</strong>. Because sound travels poorly through the air and can bounce off walls, sending a message once isn't reliable. SilenVault fixes this using a TCP-style Handshake loop.</p>
                <ol class="text-slate-300 text-sm pl-4 mt-4 space-y-2">
                    <li>When you send a message, it is wrapped in JSON with a cryptographic ID.</li>
                    <li>Your device relentlessly transmits this audio packet every 4 seconds.</li>
                    <li>When the receiving device hears it, it catches the text and instantly emits an <strong>ACK (Acknowledgment)</strong> receipt over its speakers.</li>
                    <li>Your device's microphone hears the receipt, updates the chat bubble to <span class="text-emerald-400 font-bold">✓ Delivered</span>, and stops the loop.</li>
                </ol>
            </section>
        </article>

    </main>

    <sv-footer base-path=".."></sv-footer>

    <script>
        // ==========================================
        // WASM DSP ENGINE CONTROL (libquiet)
        // ==========================================
        let isEngineReady = false;
        let isTransceiverActive = false;
        
        let activeReceiver = null;
        let activeTransmitter = null;

        // Visualizer Auth
        let visualizerAudioCtx = null;
        let visualizerStream = null;
        let visualizerAnalyser = null;
        let drawRaf = null;
        let lastDrawTime = 0; 
        let sliceX = 0;

        // Auto-ACK Loop State
        const pendingAcks = {}; // Stores intervals { "id": intervalID }
        const receivedIds = new Set(); // Stores IDs we heard from OTHERS
        const mySentIds = new Set(); // FIXED: Memory of our own sent packets to prevent ECHO self-stabbing!
        
        const txQueue = []; 
        let isCurrentlyTransmitting = false;

        // DOM Binds
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const btnEngage = document.getElementById('btn-engage');
        const btnSend = document.getElementById('btn-send');
        const statusDot = document.getElementById('status-dot');
        const micAlert = document.getElementById('mic-alert');
        const specCanvas = document.getElementById('spectrogram');
        const specCtx = specCanvas.getContext('2d');

        // ==========================================
        // UI HELPERS
        // ==========================================
        function appendChatBubble(type, id, text) {
            const wrapper = document.createElement('div');
            wrapper.className = `chat-bubble flex flex-col relative z-10 ${type === 'sent' ? 'chat-sent' : 'chat-recv'}`;
            wrapper.id = `msg-${id}`;
            
            let statusHtml = '';
            if (type === 'sent') {
                statusHtml = `<span class="text-[9px] text-blue-300/70 font-mono text-right mt-1" id="status-${id}">Broadcasting...</span>`;
            } else {
                statusHtml = `<span class="text-[9px] text-emerald-300/70 font-mono text-left mt-1">Via Acoustic Modem</span>`;
            }

            wrapper.innerHTML = `<span class="text-white">${text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>${statusHtml}`;
            chatWindow.appendChild(wrapper);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function markDelivered(id) {
            const statusEl = document.getElementById(`status-${id}`);
            if (statusEl) {
                statusEl.innerHTML = `<span class="text-emerald-400 font-bold">✓ Delivered</span>`;
                statusEl.classList.remove('text-blue-300/70');
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        window.addEventListener('load', () => {
            try {
                if (!window.isSecureContext) {
                    micAlert.classList.remove('hidden');
                }

                Quiet.init({
                    profilesPrefix: "../assets/wasm/quiet/",
                    memoryInitializerPrefix: "../assets/wasm/quiet/",
                    libfecPrefix: "../assets/wasm/quiet/"
                });

                Quiet.addReadyCallback(() => {
                    isEngineReady = true;
                    document.getElementById('engine-status').innerText = 'DSP: ONLINE';
                    document.getElementById('engine-status').classList.replace('text-emerald-300', 'text-white');
                    document.getElementById('engine-status').classList.replace('border-emerald-500/30', 'border-emerald-500');
                    document.getElementById('engine-status').classList.replace('bg-emerald-900/30', 'bg-emerald-600');

                    // Unlock Engage Button
                    btnEngage.disabled = false;
                    btnEngage.className = "bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-6 py-2 rounded-lg border border-emerald-500 uppercase tracking-widest text-xs transition-all w-full sm:w-auto flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(16,185,129,0.3)] cursor-pointer";
                    document.getElementById('btn-engage-text').innerText = "Engage Transceiver";
                }, (err) => {
                    console.error("DSP Boot Error: ", err);
                    document.getElementById('btn-engage-text').innerText = "WASM Failed.";
                });
            } catch (e) {
                console.error("Quiet Init Exception: ", e);
            }
        });

        // ==========================================
        // QUEUED TRANSMITTER
        // ==========================================
        function processTxQueue() {
            if (isCurrentlyTransmitting || txQueue.length === 0 || !activeTransmitter) return;
            
            isCurrentlyTransmitting = true;
            statusDot.className = "w-3 h-3 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6] pulse-tx shrink-0";
            
            const payloadStr = txQueue.shift();
            activeTransmitter.transmit(Quiet.str2ab(payloadStr));
        }

        function queuePacket(str) {
            txQueue.push(str);
            processTxQueue();
        }

        // ==========================================
        // THE LOVERS PROTOCOL (FULL DUPLEX)
        // ==========================================
        function sendChatMessage() {
            if (!isTransceiverActive) return;
            const text = chatInput.value.trim();
            
            // FSK Data payloads must be very tiny to survive noise. Max 40 chars.
            if (!text || text.length > 40) {
                alert("Message too long! Must be under 40 characters for acoustic transfer.");
                return;
            }

            chatInput.value = '';
            
            // Create short cryptographic ID
            const id = Math.random().toString(16).substring(2,6);
            
            // FIX: Add this to our memory so our microphone doesn't self-echo!
            mySentIds.add(id);
            
            // Render UI
            appendChatBubble('sent', id, text);

            // Construct JSON MSG Packet (Extremely tiny keys to save bandwidth)
            const packet = JSON.stringify({ i: id, m: text });

            // Transmit instantly
            queuePacket(packet);

            // Start Auto-ACK Loop (Relentlessly broadcast every 4 seconds)
            pendingAcks[id] = setInterval(() => {
                queuePacket(packet);
            }, 4000); 
        }

        function handleIncomingPacket(payloadArrayBuffer) {
            try {
                const str = Quiet.ab2str(payloadArrayBuffer);
                const data = JSON.parse(str);

                // Flash Green dot
                statusDot.className = "w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981] pulse-rx shrink-0";
                setTimeout(() => { if (!isCurrentlyTransmitting) statusDot.className = "w-3 h-3 rounded-full bg-emerald-500 shrink-0"; }, 500);

                if (data.a) {
                    // It's an ACK receipt!
                    const ackId = data.a;
                    if (pendingAcks[ackId]) {
                        clearInterval(pendingAcks[ackId]); // Stop screaming into the void
                        delete pendingAcks[ackId];
                        markDelivered(ackId); // Update UI
                    }
                } 
                else if (data.m && data.i) {
                    // It's a Message!
                    
                    // FIX: Is this my own message echoing off the walls into my mic? Drop it!
                    if (mySentIds.has(data.i)) return; 

                    // 1. Immediately queue an ACK receipt to tell the sender to shut up
                    const ackPacket = JSON.stringify({ a: data.i });
                    queuePacket(ackPacket);

                    // 2. Render to chat only if we haven't already
                    if (!receivedIds.has(data.i)) {
                        receivedIds.add(data.i);
                        appendChatBubble('recv', data.i, data.m);
                    }
                }
            } catch (e) {
                // Background noise loosely triggered the error correction. Ignored.
            }
        }


        // ==========================================
        // TRANSCEIVER BOOT / TEARDOWN
        // ==========================================
        async function toggleTransceiver() {
            if (!isEngineReady) return;
            
            if (isTransceiverActive) {
                stopTransceiver();
                return;
            }

            const profile = document.getElementById('config-band').value;

            try {
                visualizerStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false } 
                });
                micAlert.classList.add('hidden');
                
                visualizerAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = visualizerAudioCtx.createMediaStreamSource(visualizerStream);
                visualizerAnalyser = visualizerAudioCtx.createAnalyser();
                visualizerAnalyser.fftSize = 2048;
                source.connect(visualizerAnalyser);

                isTransceiverActive = true;

                // UI Updates
                btnEngage.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/></svg> <span id="btn-engage-text">Terminate Link</span>`;
                btnEngage.className = "bg-rose-600 hover:bg-rose-500 text-white font-bold px-6 py-2 rounded-lg border border-rose-500 uppercase tracking-widest text-xs transition-all w-full sm:w-auto flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(225,29,72,0.3)] cursor-pointer";
                
                statusDot.className = "w-3 h-3 rounded-full bg-emerald-500 shrink-0";
                
                chatInput.disabled = false;
                btnSend.disabled = false;
                btnSend.classList.remove('cursor-not-allowed');

                // Boot WASM Receiver
                activeReceiver = Quiet.receiver({
                    profile: profile,
                    onReceive: handleIncomingPacket,
                    onCreateFail: (reason) => {
                        console.error("Failed to create receiver", reason);
                        stopTransceiver();
                        micAlert.classList.remove('hidden');
                    }
                });

                // Boot WASM Transmitter
                activeTransmitter = Quiet.transmitter({
                    profile: profile,
                    onFinish: () => {
                        isCurrentlyTransmitting = false;
                        statusDot.className = "w-3 h-3 rounded-full bg-emerald-500 shrink-0";
                        processTxQueue(); // Send next in queue if exists
                    }
                });

                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                drawSpectrogram();

            } catch (err) {
                micAlert.classList.remove('hidden');
            }
        }

        function stopTransceiver() {
            isTransceiverActive = false;
            
            // FIX: Prevent Memory Leaks! We MUST destroy the C++ Pointers!
            if (activeReceiver) {
                activeReceiver.destroy();
                activeReceiver = null;
            }
            if (activeTransmitter) {
                activeTransmitter.destroy();
                activeTransmitter = null;
            }

            if (visualizerStream) visualizerStream.getTracks().forEach(track => track.stop());
            if (visualizerAudioCtx) visualizerAudioCtx.close();
            if (drawRaf) cancelAnimationFrame(drawRaf);

            // Clear all loops
            for (let id in pendingAcks) {
                clearInterval(pendingAcks[id]);
                delete pendingAcks[id];
            }
            txQueue.length = 0;
            isCurrentlyTransmitting = false;

            // Revert UI
            btnEngage.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg> <span id="btn-engage-text">Engage Transceiver</span>`;
            btnEngage.className = "bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-6 py-2 rounded-lg border border-emerald-500 uppercase tracking-widest text-xs transition-all w-full sm:w-auto flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(16,185,129,0.3)] cursor-pointer";
            
            statusDot.className = "w-3 h-3 rounded-full bg-slate-600 shadow-inner shrink-0";
            
            chatInput.disabled = true;
            btnSend.disabled = true;
            btnSend.classList.add('cursor-not-allowed');
            
            specCtx.clearRect(0, 0, specCanvas.width, specCanvas.height);
        }

        // ==========================================
        // OPTIMIZED RADAR SPECTROGRAM 
        // ==========================================
        function resizeCanvas() {
            specCanvas.width = specCanvas.parentElement.clientWidth;
            specCanvas.height = specCanvas.parentElement.clientHeight;
        }

        function drawSpectrogram(timestamp) {
            if (!isTransceiverActive) return;
            drawRaf = requestAnimationFrame(drawSpectrogram);

            // FIX: Throttle to ~20 FPS to completely eliminate CPU lag
            if (timestamp - lastDrawTime < 50) return;
            lastDrawTime = timestamp;

            const buffer = new Uint8Array(visualizerAnalyser.frequencyBinCount);
            visualizerAnalyser.getByteFrequencyData(buffer);

            const w = specCanvas.width;
            const h = specCanvas.height;

            // Radar Sweep Wrap-Around
            if (sliceX >= w) sliceX = 0;

            // Paint a "black bar" slightly ahead to create the sweeping radar effect
            specCtx.fillStyle = '#020617';
            specCtx.fillRect(sliceX + 1, 0, 10, h);

            const profile = document.getElementById('config-band').value;
            const startIdx = profile === 'ultrasonic-experimental' ? Math.floor(buffer.length * 0.7) : 0;
            const range = profile === 'ultrasonic-experimental' ? Math.floor(buffer.length * 0.3) : Math.floor(buffer.length * 0.4);

            for (let y = 0; y < h; y++) {
                const index = startIdx + Math.floor((y / h) * range); 
                const value = buffer[index];
                
                let r=2, g=6, b=23; // Background matching bg-[#020617]
                if (value > 200) { r=255; g=255; b=255; } // White Hot
                else if (value > 120) { r=16; g=185; b=129; } // Emerald
                else if (value > 60) { r=30; g=58; b=138; } // Blue

                specCtx.fillStyle = `rgb(${r},${g},${b})`;
                specCtx.fillRect(sliceX, h - y, 1, 1);
            }
            sliceX++;
        }

        // Auto-reboot on band change
        document.getElementById('config-band').addEventListener('change', () => {
            if (isTransceiverActive) {
                stopTransceiver();
                setTimeout(toggleTransceiver, 300);
            }
        });

        // Enter key to send
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!btnSend.disabled) sendChatMessage();
            }
        });
    </script>
</body>
</html>
