import { CanvasProcessor } from './CanvasProcessor.js';

// By extending CanvasProcessor, we inherit the flawless Canvas API scrubbing method automatically!
export class WebpProcessor extends CanvasProcessor {
    constructor(file, ext) {
        super(file, ext, 'image/webp');
        this.engineName = 'ExifReader Scout + Canvas Purge';
        this.engineClass = 'text-blue-400 font-mono text-sm';
        this.buttonText = 'Execute Canvas Purge';
    }

    async parse() {
        const buffer = await this.file.arrayBuffer();
        let exifData = {};

        // 1. Try the standard fast scanner first
        try {
            const standardData = await window.exifr.parse(buffer, {tiff: true, exif: true, gps: true, xmp: true, iptc: true});
            if (standardData) {
                Object.assign(exifData, standardData);
            }
        } catch(e) {
            console.warn("[WebpProcessor] exifr scanner skipped or failed.");
        }

        // 2. The Heavy Artillery: MattiasW's ExifReader
        if (window.ExifReader) {
            try {
                // THE FIX: ExifReader is asynchronous in modern versions. It MUST be awaited.
                // We pass the raw File object directly instead of the buffer for maximum accuracy.
                const tags = await window.ExifReader.load(this.file);
                
                let recovered = 0;
                for (const [key, tag] of Object.entries(tags)) {
                    // Skip internal structural tags generated by ExifReader
                    if (['Image Width', 'Image Height', 'colorSpace'].includes(key)) continue;
                    
                    let val = tag.description !== undefined ? tag.description : tag.value;
                    if (Array.isArray(val)) val = val.join(', ');

                    // If ExifReader found a tag that exifr missed, add it to our UI!
                    if (exifData[key] === undefined) {
                        exifData[key] = val;
                        recovered++;
                    }
                }
                
                if (recovered > 0) {
                    console.log(`[WebpProcessor] ExifReader successfully recovered ${recovered} hidden tags.`);
                }
            } catch(e) {
                console.warn("[WebpProcessor] ExifReader failed to parse file.", e);
            }
        } else {
            console.error("[WebpProcessor] window.ExifReader is missing. Check your HTML script tag!");
            const terminalOut = document.getElementById('terminal-out');
            if(terminalOut) terminalOut.innerHTML += `<div class="log-line"><span class="val-high">SYSTEM WARNING: ExifReader missing. Reading may be incomplete.</span></div>`;
        }

        return Object.keys(exifData).length > 0 ? exifData : null;
    }

    // We do NOT need a custom scrub() method anymore!
    // Because we extend CanvasProcessor, when you click "Execute Purge", 
    // it automatically uses the Canvas API to repaint the image and perfectly strip all data.
}
